
# Анализ сетевого трафика

---

`Анализ сетевого трафика (Network Traffic Analysis, NTA)` можно описать как процесс исследования сетевого трафика для характеристики используемых портов и протоколов, создания базовой линии для нашей среды, мониторинга и реагирования на угрозы, а также обеспечения максимального понимания сети нашей организации.

Этот процесс помогает специалистам по безопасности определять аномалии, в том числе угрозы безопасности в сети, на ранних этапах и эффективно выявлять угрозы. Анализ сетевого трафика также может облегчить процесс соблюдения рекомендаций по безопасности. Злоумышленники часто обновляют свою тактику, чтобы избежать обнаружения, и используют легитимные учетные данные с инструментами, которые большинство компаний разрешают в своих сетях, что усложняет обнаружение и, следовательно, реагирование для защитников. В таких случаях анализ сетевого трафика снова может оказаться полезным. Типичные случаи использования NTA включают:

| |
|---|
| `Сбор` трафика в реальном времени внутри сети для анализа потенциальных угроз. |
| `Установка` базового уровня для повседневных сетевых коммуникаций. |
| `Идентификация` и анализ трафика из нестандартных портов, подозрительных хостов и проблем с сетевыми протоколами, такими как ошибки HTTP, проблемы с TCP или другие сетевые неправильные конфигурации. |
| `Обнаружение` вредоносного ПО в сети, такого как программы-вымогатели, эксплойты и нестандартные взаимодействия. |
| NTA также полезен при расследовании прошлых инцидентов и во время поиска угроз. |

Попробуйте представить атакующего, нацеленного на проникновение в нашу сеть. Если они хотят нарушить сеть, злоумышленники неизбежно должны взаимодействовать и общаться с нашей инфраструктурой. Сетевая коммуникация происходит через множество различных портов и протоколов, которые одновременно используются сотрудниками, оборудованием и клиентами. Чтобы обнаружить вредоносный трафик, нам нужно использовать наши знания о типичном сетевом трафике в нашем анклаве. Это сузит наш поиск и поможет нам быстро найти и нарушить коммуникацию противника.

Например, если мы обнаружим много пакетов `SYN` на портах, которые мы никогда (или редко) используем в нашей сети, мы можем сделать вывод, что это, скорее всего, кто-то пытается определить, какие порты открыты на наших хостах. Такие действия являются типичными признаками `сканирования портов`. Выполнение такого анализа и формулирование таких выводов требует определенных навыков и знаний.

---

## Необходимые навыки и знания

Навыки, которые мы сейчас перечислим и опишем, требуют теоретических и практических знаний, приобретенных с течением времени. Нам не нужно все знать наизусть, но мы должны знать, что искать, когда определенные аспекты содержания кажутся незнакомыми. Это относится не только к NTA, но и к большинству других тем, с которыми мы будем иметь дело в кибербезопасности.

#### Стек TCP/IP и модель OSI

Это понимание обеспечит, что мы поймем, как взаимодействуют сетевой трафик и приложения хоста.

#### Основные сетевые концепции

Понимание типов трафика, которые мы увидим на каждом уровне, включает понимание отдельных слоев, составляющих модели TCP/IP и OSI, а также концепций коммутации и маршрутизации. Если мы подключимся к сети на магистральной линии, мы увидим гораздо больше трафика, чем обычно, и это будет сильно отличаться от того, что мы находим при подключении к офисному коммутатору.

#### Общие порты и протоколы

Быстрая идентификация стандартных портов и протоколов и функциональное понимание того, как они взаимодействуют, обеспечит, что мы сможем идентифицировать потенциально вредоносный или неправильно сформированный сетевой трафик.

#### Концепции IP-пакетов и подуровней

Фундаментальные знания о том, как взаимодействуют TCP и UDP, как минимум, гарантируют, что мы понимаем, что мы видим или что ищем. TCP, например, ориентирован на потоки и позволяет нам легко следить за разговором между хостами. UDP быстрый, но не заботится о полноте, поэтому было бы труднее воссоздать что-то из этого типа пакетов.

#### Инкапсуляция протоколов транспорта

Каждый слой будет инкапсулировать предыдущий. Способность читать или анализировать, когда эта инкапсуляция изменяется, поможет нам быстрее перемещаться по данным. Легко увидеть подсказки на основе заголовков инкапсуляции.

---

## Среда и оборудование

Список ниже содержит множество различных инструментов и типов оборудования, которые можно использовать для выполнения анализа сетевого трафика. Каждый из них предоставит разный способ захвата или анализа трафика. Некоторые предлагают способы копирования и захвата, в то время как другие читают и обрабатывают данные. В этом модуле мы рассмотрим лишь некоторые из них ([Wireshark](https://www.wireshark.org/) и [tcpdump](https://www.tcpdump.org/) в основном). Имейте в виду, что эти инструменты не предназначены строго для администраторов. Многие из них также могут быть использованы в злонамеренных целях.

#### Общие инструменты анализа трафика

| **Инструмент** | **Описание** |
|----------------|--------------|
| `tcpdump` | [tcpdump](https://www.tcpdump.org/) - это утилита командной строки, которая с помощью LibPcap захватывает и интерпретирует сетевой трафик из сетевого интерфейса или файла захвата. |
| `Tshark` | [TShark](https://www.wireshark.org/docs/man-pages/tshark.html) - это анализатор сетевых пакетов, похожий на TCPDump. Он будет захватывать пакеты из живой сети или читать и декодировать из файла. Это вариант Wireshark для командной строки. |
| `Wireshark` | [Wireshark](https://www.wireshark.org/) - это графический анализатор сетевого трафика. Он захватывает и декодирует кадры из сети и позволяет детально рассмотреть среду. Он может запускать множество различных диссекторов для характеристики протоколов и приложений и предоставлять информацию о происходящем. |
| `NGrep` | [NGrep](https://github.com/jpr5/ngrep) - это инструмент сопоставления с образцом, созданный для выполнения функций, аналогичных grep для дистрибутивов Linux. Большая разница в том, что он работает с пакетами сетевого трафика. NGrep понимает, как читать живой трафик или трафик из файла PCAP и использовать регулярные выражения и синтаксис BPF. Этот инструмент лучше всего подходит при отладке трафика от протоколов, таких как HTTP и FTP. |
| `tcpick` | [tcpick](http://tcpick.sourceforge.net/index.php?p=home.inc) - это сниффер пакетов командной строки, который специализируется на отслеживании и восстановлении TCP-потоков. Функциональность чтения потока и восстановления его обратно в файл с tcpick превосходна. |
| `Network Taps` | Ответвления ([Gigamon](https://www.gigamon.com/), [Niagra-taps](https://www.niagaranetworks.com/products/network-tap)) - это устройства, способные делать копии сетевого трафика и отправлять их в другое место для анализа. Они могут быть в линии или вне полосы. Они могут активно захватывать и анализировать трафик напрямую или пассивно, помещая исходный пакет обратно в сеть, как будто ничего не изменилось. |
| `Networking Span Ports` | [Зеркалирующие порты](https://en.wikipedia.org/wiki/Port_mirroring) - это способ копирования кадров из устройств второго или третьего уровня сети во время обработки выхода или входа и отправки их в точку сбора. Часто порт зеркалируется для отправки этих копий на сервер журналов. |
| `Elastic Stack` | [Elastic Stack](https://www.elastic.co/elastic-stack) - это кульминация инструментов, которые могут принимать данные из многих источников, обрабатывать данные и визуализировать их, чтобы обеспечить поиск и анализ этих данных. |
| `SIEMS` | `SIEMS` (такие как [Splunk](https://www.splunk.com/en_us)) - это центральная точка, в которой данные анализируются и визуализируются. Оповещения, анализ криминалистики и ежедневные проверки трафика - все это примеры использования SIEM. |
| и другие. | |

---

## Синтаксис BPF

Многие из упомянутых выше инструментов имеют свой синтаксис и команды для использования, но один из них, который используется среди них, - это синтаксис [Berkeley Packet Filter (BPF)](https://en.wikipedia.org/wiki/Berkeley_Packet_Filter). Этот синтаксис является основным методом, который мы будем использовать. По сути, BPF - это технология, которая обеспечивает необработанный интерфейс для чтения и записи с уровня канала данных. С учетом всего этого, мы заботимся о BPF из-за возможностей фильтрации и декодирования, которые он нам предоставляет. Мы будем использовать синтаксис BPF на протяжении всего модуля, поэтому базовое понимание того, как настроен фильтр BPF, может быть полезно. Для получения дополнительной информации о синтаксисе BPF ознакомьтесь с этой [ссылкой](https://www.ibm.com/docs/en/qsip/7.4?topic=queries-berkeley-packet-filters).

---

## Выполнение анализа сетевого трафика

Выполнение анализа может быть таким же простым, как наблюдение за живым трафиком, прокручивающимся в нашей консоли, или таким сложным, как захват данных с помощью ответвления, отправка их обратно в SIEM для обработки и анализ данных pcap на наличие сигнатур и предупреждений, связанных с общими тактиками и методами.

Как минимум, чтобы пассивно прослушивать, нам нужно быть подключенными к сегменту сети, который мы хотим прослушивать. Это особенно актуально в коммутируемой среде, где VLAN и порты коммутатора не будут пересылать трафик за пределы их домена широковещательной рассылки. С учетом этого, если мы хотим захватить трафик из определенной VLAN, наше устройство захвата должно быть подключено к той же сети. Устройства, такие как сетевые ответвления, конфигурации коммутатора или маршрутизатора, такие как отслеживающие порты, и зеркалирование портов, могут позволить нам получить копию всего трафика, проходящего через конкретное соединение, независимо от того, к какому сегменту сети или пункту назначения он принадлежит.

#### Рабочий процесс NTA

Анализ трафика - это не точная наука. NTA может быть очень динамичным процессом и не является прямой петлей. На него сильно влияет то, что мы ищем (сетевые ошибки или вредоносные действия) и где у нас есть видимость нашей сети. Выполнение анализа трафика можно свести к нескольким основным принципам.

#### Рабочий процесс NTA

![Циклическая диаграмма, показывающая четыре шага: 1. Входной трафик, 2. Уменьшение шума фильтрацией, 3. Анализ и исследование, 4. Обнаружение и оповещение.](https://academy.hackthebox.com/storage/modules/81/workflow.png)

#### 1. Входной трафик

После того, как мы определились с нашим размещением, начинаем захват трафика. Используйте фильтры захвата, если у нас уже есть представление о том, что мы ищем.

#### 2. Уменьшение шума фильтрацией

Захват трафика соединения, особенно в производственной среде, может быть чрезвычайно шумным. После завершения первоначального захвата попытка отфильтровать ненужный трафик из нашего представления может облегчить анализ. (Например, трафик широковещательной и групповой рассылки.)

#### 3. Анализ и исследование

Теперь настало время начать выделение данных, относящихся к проблеме, которую мы преследуем. Посмотрите на конкретные хосты, протоколы, даже такие специфические вещи, как флаги, установленные в заголовке TCP. Следующие вопросы помогут нам:

1. Шифруется ли трафик или он открытый текст? Должен ли он быть таким?

2. Можем ли мы видеть пользователей, пытающихся получить доступ к ресурсам, к которым у них не должно быть доступа?

3. Разговаривают ли между собой разные хосты, которые обычно не разговаривают?

#### 4. Обнаружение и оповещение

1. Видим ли мы какие-либо ошибки? Не отвечает ли устройство, которое должно отвечать?

2. Используйте наш анализ, чтобы решить, является ли то, что мы видим, доброкачественным или потенциально вредоносным.

3. Другие инструменты, такие как IDS и IPS, могут пригодиться на этом этапе. Они могут запускать эвристику и сигнатуры против трафика, чтобы определить, содержится ли что-либо потенциально вредоносное.

#### 5. Исправление и мониторинг

Исправление и мониторинг не являются частью цикла, но должны быть включены в любой рабочий процесс, который мы выполняем. Если мы вносим изменение или исправляем проблему, мы должны продолжать отслеживать источник некоторое время, чтобы определить, была ли проблема решена.
