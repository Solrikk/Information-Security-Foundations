
# Зачем нужен Active Directory?

---

Active Directory (AD) — это служба каталогов для сетевых сред Windows. Это распределенная иерархическая структура, которая обеспечивает централизованное управление ресурсами организации, включая пользователей, компьютеры, группы, сетевые устройства, общие файлы, групповые политики, устройства и доверительные отношения. AD обеспечивает функции аутентификации и авторизации в доменной среде Windows. В последние годы он подвергается все большим атакам. Он разработан с учетом обратной совместимости, и многие функции, можно сказать, не являются "безопасными по умолчанию", что делает его уязвимым для неправильной конфигурации. Эту слабость можно использовать для горизонтального и вертикального перемещения в сети и получения несанкционированного доступа. AD, по сути, представляет собой большую базу данных только для чтения, доступную всем пользователям внутри домена, независимо от их уровня привилегий. Базовая учетная запись пользователя AD без дополнительных привилегий может перечислить большинство объектов в AD. Этот факт делает крайне важным правильное обеспечение безопасности реализации AD, поскольку ЛЮБАЯ учетная запись пользователя, независимо от уровня привилегий, может использоваться для перечисления домена и тщательного поиска неправильных конфигураций и недостатков. Кроме того, несколько атак можно выполнить, используя только стандартную учетную запись пользователя домена, что показывает важность стратегии многоуровневой защиты и тщательного планирования, сосредоточенного на безопасности и усилении AD, сегментации сети и принципе минимальных привилегий. Одним из примеров является атака [noPac](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware), которая была впервые выпущена в декабре 2021 года.

Active Directory упрощает поиск и использование информации для администраторов и пользователей. AD хорошо масштабируется, поддерживает миллионы объектов на домен и позволяет создавать дополнительные домены по мере роста организации.

![Схема организации Active Directory, показывающая пирамидальную структуру. Вверху: Доменная политика для общекорпоративной политики и лицензирования. В середине: Объект групповой политики, управляющий портфелем приложений и настройками. Внизу: Документы отделов маркетинга и продаж в организационном подразделении Active Directory. Слева: Сервер Active Directory. Справа: Библиотека приложений и общий доступ к файлам.](https://academy.hackthebox.com/storage/modules/34/redesigned/whyad5.png)
[Источник](https://dbaontap.com/2016/11/25/oem13c-roles-ad-groups/active-directory/)

По оценкам, около 95% компаний из списка [Fortune 500](https://en.wikipedia.org/wiki/Fortune_500) используют Active Directory, что делает AD ключевой целью для злоумышленников. Успешная атака, например фишинг, которая помещает злоумышленника в среду AD в качестве стандартного пользователя домена, даст ему достаточный доступ, чтобы начать составление карты домена и поиск путей атаки. Как специалисты по безопасности, мы будем сталкиваться с средами AD всех размеров на протяжении нашей карьеры. Очень важно понимать структуру и функции AD, чтобы стать более информированными как в роли атакующего, так и защитника.

Операторы программ-вымогателей все чаще нацеливаются на Active Directory как на ключевую часть своих путей атаки. [Программа-вымогатель Conti](https://www.cisa.gov/sites/default/files/publications/AA21-265A-Conti_Ransomware_TLP_WHITE.pdf), которая использовалась в более чем 400 атаках по всему миру, как показано, использует недавние критические уязвимости Active Directory, такие как [PrintNightmare (CVE-2021-34527)](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) и [Zerologon (CVE-2020-1472)](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472), для повышения привилегий и горизонтального перемещения в целевой сети. Понимание структуры и функций Active Directory — это первый шаг на пути к карьере поиска и предотвращения таких уязвимостей до того, как их обнаружат злоумышленники. Исследователи постоянно обнаруживают новые, чрезвычайно опасные атаки, которые влияют на среды Active Directory и часто требуют не более чем стандартного пользователя домена для получения полного административного контроля над всем доменом. Существует множество отличных инструментов с открытым исходным кодом для специалистов по тестированию на проникновение для перечисления и атаки Active Directory. Тем не менее, чтобы использовать их наиболее эффективно, мы должны понимать, как работает Active Directory, чтобы идентифицировать очевидные и нюансированные недостатки. Инструменты эффективны настолько, насколько осведомлён их оператор. Поэтому давайте уделим время пониманию структуры и функций Active Directory, прежде чем переходить к последующим модулям, которые будут сосредоточены на глубоком ручном и инструментальном перечислении, атаках, горизонтальном перемещении, пост-эксплуатации и сохранении доступа.

Этот модуль заложит основы для начала пути по перечислению и атаке Active Directory. Мы подробно рассмотрим структуру и функции AD, обсудим различные объекты AD, права и привилегии пользователей, инструменты и процессы для управления AD, и даже рассмотрим примеры настройки небольшой среды AD.

---

## История Active Directory

LDAP, фундамент Active Directory, был впервые представлен в [RFC](https://en.wikipedia.org/wiki/Request_for_Comments) еще в 1971 году. Active Directory предшествовала концепция организационного подразделения [X.500](https://en.wikipedia.org/wiki/X.500), которая была самой ранней версией всех систем каталогов, созданных Novell и Lotus и выпущенных в 1993 году как [Novell Directory Services](https://en.wikipedia.org/wiki/NetIQ_eDirectory).

Active Directory был впервые представлен в середине 90-х годов, но не стал частью операционной системы Windows до выпуска Windows Server 2000. Microsoft впервые попытался предоставить службы каталогов в 1990 году с выпуском Windows NT 3.0. Эта операционная система объединила функции протокола [LAN Manager](https://en.wikipedia.org/wiki/LAN_Manager) и операционных систем [OS/2](https://en.wikipedia.org/wiki/OS/2), которые Microsoft изначально создал вместе с IBM под руководством [Эда Якобуччи](https://en.wikipedia.org/wiki/Ed_Iacobucci), который также руководил разработкой [IBM DOS](https://en.wikipedia.org/wiki/IBM_PC_DOS) и позже стал соучредителем Citrix Systems. Операционная система NT эволюционировала на протяжении 90-х годов, адаптируя такие протоколы, как LDAP и Kerberos, с проприетарными элементами Microsoft. Первый бета-релиз Active Directory был выпущен в 1997 году.

Выпуск Windows Server 2003 расширил функциональность и улучшил администрирование, добавив функцию `Forest`, которая позволяет системным администраторам создавать "контейнеры" отдельных доменов, пользователей, компьютеров и других объектов под одним зонтиком. [Active Directory Federation Services (ADFS)](https://en.wikipedia.org/wiki/Active_Directory_Federation_Services) был представлен в Server 2008 для обеспечения единого входа (SSO) в системы и приложения для пользователей операционных систем Windows Server. ADFS сделал более простым и рационализированным процесс входа пользователей в приложения и системы, не находящиеся в их локальной сети.

ADFS позволяет пользователям получать доступ к приложениям через организационные границы, используя единый набор учетных данных. ADFS использует модель авторизации доступа на основе [claims-based](https://en.wikipedia.org/wiki/Claims-based_identity), которая пытается обеспечить безопасность во всех приложениях, идентифицируя пользователей по набору утверждений, связанных с их идентичностью, которые упакованы в токен безопасности провайдером идентификации.

Выпуск Server 2016 принес еще больше изменений в Active Directory, таких как возможность миграции сред AD в облако и дополнительные улучшения безопасности, такие как мониторинг доступа пользователей и [Group Managed Service Accounts (gMSA)](https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/service-accounts-group-managed). gMSA предлагает более безопасный способ запуска определенных автоматизированных задач, приложений и служб, и часто рекомендуется как средство защиты от печально известной атаки Kerberoasting.

2016 год стал значительным шагом в направлении облака с выпуском Azure AD Connect, который был разработан как метод единого входа для пользователей, мигрирующих в среду Microsoft Office 365.

Active Directory страдал от различных неправильных конфигураций с 2000 года до настоящего времени. Регулярно обнаруживаются новые уязвимости, которые затрагивают Active Directory и другие технологии, взаимодействующие с AD, такие как Microsoft Exchange. По мере того, как исследователи в области безопасности продолжают раскрывать новые уязвимости, организации, использующие Active Directory, должны оставаться на передовой в плане патчей и внедрения исправлений. Как специалисты по тестированию на проникновение, мы должны находить эти недостатки для наших клиентов раньше атакующих.

По этой причине мы должны иметь прочную основу в основах Active Directory и понимать его структуру, функции, различные протоколы, которые он использует для работы, как управляются права и привилегии пользователей, как системные администраторы администрируют AD, и множество уязвимостей и неправильных конфигураций, которые могут присутствовать в среде AD. Управление AD — нелегкая задача. Одно изменение/исправление может привести к дополнительным проблемам в других местах. Прежде чем начать перечисление, а затем атаку Active Directory, давайте рассмотрим основные концепции, которые будут сопровождать нас на протяжении всей нашей карьеры в информационной безопасности.

Как уже говорилось, 95% компаний из списка Fortune 500 используют Active Directory, и Microsoft имеет почти полную монополию в пространстве служб каталогов. Несмотря на то, что многие компании переходят на облачные и гибридные среды, локальный AD не исчезнет для многих компаний. Если вы выполняете задания по тестированию на проникновение в сеть, вы можете быть почти уверены, что столкнетесь с AD в той или иной форме практически на всех из них.

Эти фундаментальные знания сделают нас лучшими атакующими и дадут нам представление об AD, которое будет чрезвычайно полезно при предоставлении рекомендаций по исправлению наших клиентов. Глубокое понимание AD сделает раскрытие слоев менее устрашающим, и у нас будет та же уверенность при подходе к среде с 10 000 хостов, как и с 20.
