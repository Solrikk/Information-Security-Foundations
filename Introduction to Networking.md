
# Обзор сетей

---

Сеть позволяет двум компьютерам взаимодействовать друг с другом. Существует широкий спектр `топологий` (mesh/tree/star), `сред передачи данных` (ethernet/fiber/coax/wireless) и `протоколов` (TCP/UDP/IPX), которые могут использоваться для организации сети. Специалистам по безопасности важно понимать принципы работы сетей, потому что когда сеть выходит из строя, это может произойти незаметно, из-за чего мы можем пропустить что-то важное.

Настройка большой плоской сети не является чрезвычайно сложной задачей, и она может быть надежной сетью, по крайней мере, с операционной точки зрения. Однако плоская сеть подобна дому, построенному на земельном участке, который считается безопасным только потому, что на двери есть замок. Создавая множество малых сетей и обеспечивая их взаимодействие, мы можем добавить слои защиты. Перемещение по сети не составляет труда, но делать это быстро и незаметно сложно, что замедлит атакующих. Вернемся к аналогии с домом и рассмотрим следующие примеры:

#### Пример № 1

Создание небольших сетей и применение списков контроля доступа (ACL) — это как установка забора вокруг границы участка, который создает конкретные точки входа и выхода. Да, атакующий может перепрыгнуть через забор, но это выглядит подозрительно и нетипично, что позволяет быстро выявить вредоносную активность. Почему сеть принтеров общается с серверами по HTTP?

#### Пример № 2

Время, потраченное на составление карты и документирование назначения каждой сети, подобно установке освещения вокруг дома, позволяющего видеть всю активность. Почему сеть принтеров вообще взаимодействует с интернетом?

#### Пример № 3

Наличие кустарников вокруг окон является сдерживающим фактором для людей, пытающихся открыть окно. Точно так же системы обнаружения вторжений, такие как Suricata или Snort, являются сдерживающим фактором для запуска сетевого сканирования. Почему сканирование портов началось из сети принтеров?

Эти примеры могут показаться глупыми, и здравый смысл подсказывает блокировать все вышеперечисленное для принтера. Однако, если принтер находится в "плоской сети /24" и получает адрес по DHCP, может быть сложно применить такие ограничения.

---

## История из практики — Недосмотр пентестера

Большинство сетей используют подсеть `/24`, настолько часто, что многие пентестеры устанавливают эту маску подсети (255.255.255.0) без проверки. Сеть /24 позволяет компьютерам общаться друг с другом, если первые три октета IP-адреса совпадают (например, 192.168.1.xxx). Установка маски подсети `/25` разделяет этот диапазон пополам, и компьютер сможет общаться только с компьютерами на "своей половине". Мы видели отчеты о пентестах, где оценщик утверждал, что контроллер домена не работает, хотя на самом деле он просто находился в другой сети. Структура сети была примерно такой:

* Шлюз сервера: 10.20.0.1/25
* Контроллер домена: 10.20.0.10/25
* Шлюз клиента: 10.20.0.129/25
* Клиентская рабочая станция: 10.20.0.200/25
* IP пентестера: 10.20.0.252/24 (Установлен шлюз 10.20.0.1)

Пентестер взаимодействовал с клиентскими рабочими станциями и думал, что выполнил отличную работу, поскольку смог украсть пароль рабочей станции через Impacket. Однако из-за непонимания сети они так и не смогли выйти за пределы клиентской сети и достичь более "ценных целей", таких как серверы баз данных. Надеемся, если это звучит непонятно, вы сможете вернуться к этому утверждению в конце модуля и понять его!

---

## Основная информация

Давайте взглянем на следующую схему высокого уровня, которая показывает, как может работать настройка работы из дома.

![Схема домашней сети с маршрутизатором, подключающим смартфон, ноутбук и ПК, и корпоративной сети с маршрутизатором, подключающим коммутатор, веб-сервер, IP-телефон, принтер и два клиентских хоста. Обе сети подключены к Интернет-провайдеру (ISP), с сервером доменных имен (DNS) и доступом в интернет.](https://academy.hackthebox.com/storage/modules/34/redesigned/net_overview.png)

---

Весь интернет основан на множестве подразделенных сетей, как показано в примере и обозначено как "`Домашняя сеть`" и "`Корпоративная сеть`". Мы можем представить `сети` как доставку почты или посылок, отправленных одним компьютером и полученных другим.

Представим сценарий, в котором мы хотим посетить веб-сайт компании из нашей "`Домашней сети`". В этом случае мы обмениваемся данными с веб-сайтом компании, расположенным в их "`Корпоративной сети`". Как и при отправке почты или посылок, мы знаем адрес, куда должны идти пакеты. Адрес веб-сайта или `Унифицированный указатель ресурса` (`URL`), который мы вводим в браузере, также известен как `Полное доменное имя` (`FQDN`).

Разница между `URL` и `FQDN` заключается в том, что:

* `FQDN` (`www.hackthebox.eu`) указывает только адрес "здания", а
* `URL` (`https://www.hackthebox.eu/example?floor=2&office=dev&employee=17`) также указывает "`этаж`", "`офис`", "`почтовый ящик`" и соответствующего "`сотрудника`", для которого предназначен пакет.

Мы обсудим точные представления и определения более четко и точно в других разделах.

Факт в том, что мы знаем адрес, но не точное географическое местоположение этого адреса. В этой ситуации почтовое отделение может определить точное местоположение, а затем переслать пакеты в нужное место. Таким образом, наше почтовое отделение пересылает наши пакеты в главное почтовое отделение, представляющее нашего `Интернет-провайдера` (`ISP`).

Наше почтовое отделение — это наш `маршрутизатор`, который мы используем для подключения к "Интернету" в сетевом взаимодействии.

Как только мы отправляем наш пакет через наше почтовое отделение (`маршрутизатор`), пакет пересылается в `главное почтовое отделение` (`ISP`). Это главное почтовое отделение смотрит в `адресном реестре`/`телефонной книге` (`Службе доменных имен`), где находится этот адрес, и возвращает соответствующие географические координаты (`IP-адрес`). Теперь, когда мы знаем точное местоположение адреса, наш пакет отправляется прямо туда прямым рейсом через наше главное почтовое отделение.

После того, как веб-сервер получил наш пакет с запросом о том, как выглядит их веб-сайт, веб-сервер отправляет нам обратно пакет с данными для отображения веб-сайта через почтовое отделение (`маршрутизатор`) "`Корпоративной сети`" на указанный обратный адрес (`наш IP-адрес`).

---

## Дополнительные замечания

В этой схеме я надеюсь, что показанная корпоративная сеть состоит из пяти отдельных сетей!

1. Веб-сервер должен находиться в DMZ (демилитаризованной зоне), потому что клиенты в интернете могут инициировать взаимодействие с веб-сайтом, что делает его более уязвимым для компрометации. Размещение его в отдельной сети позволяет администраторам установить сетевую защиту между веб-сервером и другими устройствами.

2. Рабочие станции должны быть в своей собственной сети, и в идеальном мире каждая рабочая станция должна иметь правило межсетевого экрана на уровне хоста, предотвращающее взаимодействие с другими рабочими станциями. Если рабочая станция находится в той же сети, что и сервер, сетевые атаки, такие как `подмена` или `человек посередине`, становятся гораздо более серьезной проблемой.

3. Коммутатор и маршрутизатор должны находиться в "Административной сети". Это предотвращает подслушивание рабочими станциями любого взаимодействия между этими устройствами. Я часто проводил тесты на проникновение и видел рекламу `OSPF` (Open Shortest Path First). Поскольку у маршрутизатора не было `доверенной сети`, любой во внутренней сети мог отправить вредоносную рекламу и выполнить атаку типа `человек посередине` против любой сети.

4. IP-телефоны должны быть в своей собственной сети. С точки зрения безопасности это необходимо для предотвращения подслушивания компьютерами. В дополнение к безопасности, телефоны уникальны в том смысле, что задержка/лаг имеет большое значение. Размещение их в собственной сети может позволить сетевым администраторам более легко приоритизировать их трафик для предотвращения высокой задержки.

5. Принтеры должны быть в своей собственной сети. Это может звучать странно, но защитить принтер практически невозможно. Из-за того, как работает Windows, если принтер сообщает компьютеру, что требуется аутентификация во время задания печати, этот компьютер попытается выполнить аутентификацию `NTLMv2`, что может привести к краже паролей. Кроме того, эти устройства отлично подходят для обеспечения устойчивости и, как правило, содержат множество конфиденциальной информации.

---

## Забавная история

Во время COVID мне было поручено выполнить `Физический тест на проникновение` через границы штатов, и мой штат находился под приказом о `домашнем карантине`. В компании, которую я тестировал, в офисе было минимальное количество персонала. Я решил купить дорогой принтер и внедрить в него обратную оболочку, чтобы при подключении к сети он отправлял мне шелл (удаленный доступ). Затем я отправил принтер в компанию и отправил фишинговое письмо, благодаря персонал за то, что они приходят на работу, и объясняя, что принтер должен позволить им печатать или сканировать быстрее, если они хотят взять что-то домой для работы из дома на несколько дней. Принтер был подключен почти мгновенно, и компьютер их доменного администратора любезно отправил принтеру свои учетные данные!

Если бы клиент спроектировал безопасную сеть, эта атака, вероятно, была бы невозможна по многим причинам:

* Принтер не должен был иметь возможность взаимодействовать с интернетом





# Типы сетей

---

Каждая сеть имеет свою структуру и настраивается индивидуально. По этой причине были разработаны так называемые `типы` и `топологии`, которые используются для категоризации этих сетей. При изучении всех типов сетей можно столкнуться с переизбытком информации, так как некоторые типы сетей включают в себя географический охват. Мы редко слышим некоторые термины на практике, поэтому этот раздел будет разделен на `Общие термины` и `Книжные термины`. Книжные термины полезно знать, поскольку был зафиксирован единственный документированный случай, когда почтовый сервер не смог доставить электронные письма длиннее 500 миль, но от вас не требуется цитировать их по требованию, если только вы не изучаете сетевые технологии для экзамена.

#### Общая терминология

| **Тип сети** | **Определение** |
|--------------|-----------------|
| Глобальная сеть (WAN) | Интернет |
| Локальная сеть (LAN) | Внутренние сети (например: домашняя или офисная) |
| Беспроводная локальная сеть (WLAN) | Внутренние сети, доступные через Wi-Fi |
| Виртуальная частная сеть (VPN) | Соединяет несколько сетевых узлов в одну `LAN` |

---

## WAN

WAN (Wide Area Network, Глобальная сеть) обычно называется `Интернетом`. При работе с сетевым оборудованием у нас часто будет WAN-адрес и LAN-адрес. WAN — это адрес, к которому обычно осуществляется доступ из Интернета. Тем не менее, это не ограничивается только Интернетом; WAN — это просто большое количество объединенных LAN-сетей. Многие крупные компании или правительственные учреждения имеют "Внутреннюю WAN" (также называемую Интранет, Изолированная сеть и т.д.). В общем, основным способом определения того, является ли сеть WAN, является использование специфичного для WAN протокола маршрутизации, такого как BGP, и если используемая IP-схема не входит в RFC 1918 (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16).

---

## LAN / WLAN

LAN (Local Area Network, Локальная сеть) и WLAN (Wireless Local Area Network, Беспроводная локальная сеть) обычно назначают IP-адреса, предназначенные для локального использования (RFC 1918, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16). В некоторых случаях, например в некоторых колледжах или отелях, вам может быть назначен маршрутизируемый (интернет) IP-адрес при подключении к их LAN, но это встречается гораздо реже. Между LAN и WLAN нет никакой разницы, кроме того, что WLAN предоставляет возможность передачи данных без кабелей. В основном это обозначение безопасности.

---

## VPN

Существует три основных типа `Виртуальных частных сетей` (`VPN`), но все три имеют одну и ту же цель — создать у пользователя ощущение, что он подключен к другой сети.

#### Site-To-Site VPN

И клиент, и сервер являются сетевыми устройствами, обычно либо `Маршрутизаторами`, либо `Межсетевыми экранами`, и они совместно используют целые диапазоны сетей. Это наиболее часто используется для объединения корпоративных сетей через Интернет, позволяя нескольким местоположениям взаимодействовать через Интернет, как если бы они были локальными.

#### Remote Access VPN

Это подразумевает создание компьютером клиента виртуального интерфейса, который ведет себя так, как если бы он находился в сети клиента. Hack The Box использует `OpenVPN`, который создает TUN адаптер, позволяющий нам получать доступ к лабораториям. При анализе этих VPN важным элементом для рассмотрения является таблица маршрутизации, которая создается при подключении к VPN. Если VPN создает маршруты только для определенных сетей (например: 10.10.10.0/24), это называется `Split-Tunnel VPN`, что означает, что интернет-соединение не проходит через VPN. Это отлично подходит для Hack The Box, поскольку обеспечивает доступ к лаборатории без опасений по поводу конфиденциальности и мониторинга вашего интернет-соединения. Однако для компании `split-tunnel` VPN обычно не идеален, потому что если машина заражена вредоносным ПО, сетевые методы обнаружения, вероятно, не будут работать, так как этот трафик направляется через Интернет.

#### SSL VPN

По сути, это VPN, который работает в нашем веб-браузере и становится все более распространенным, поскольку веб-браузеры становятся способными делать что угодно. Обычно они будут транслировать приложения или целые сеансы рабочего стола в ваш веб-браузер. Отличным примером этого является HackTheBox Pwnbox.

---

## Книжные термины

| Тип сети | Определение |
|----------|-------------|
| Глобальная сеть (GAN) | Глобальная сеть (Интернет) |
| Городская сеть (MAN) | Региональная сеть (несколько LAN) |
| Беспроводная персональная сеть (WPAN) | Персональная сеть (Bluetooth) |

#### GAN

Всемирная сеть, такая как `Интернет`, известна как `Глобальная сеть` (`GAN`). Однако Интернет — не единственная компьютерная сеть такого рода. Международные компании также поддерживают изолированные сети, охватывающие несколько `WAN` и соединяющие компьютеры компании по всему миру. `GAN` используют инфраструктуру оптоволоконных линий глобальных сетей и соединяют их международными подводными кабелями или спутниковой передачей.

#### MAN

`Городская сеть` (`MAN`) — это широкополосная телекоммуникационная сеть, которая соединяет несколько `LAN` в географической близости. Как правило, это отдельные филиалы компании, подключенные к `MAN` через выделенные линии. Используются высокопроизводительные маршрутизаторы и высокопроизводительные соединения на основе оптоволокна, которые обеспечивают значительно более высокую пропускную способность, чем Интернет. Скорость передачи между двумя удаленными узлами сопоставима с коммуникацией в пределах `LAN`.

Инфраструктуру для `MAN` предоставляют международные операторы сетей. Города, подключенные как `Городские сети`, могут быть интегрированы в надрегиональном масштабе в `Глобальные сети` (`WAN`) и на международном уровне в `Глобальные сети` (`GAN`).

#### PAN / WPAN

Современные конечные устройства, такие как смартфоны, планшеты, ноутбуки или настольные компьютеры, могут быть соединены для формирования сети для обмена данными. Это может быть сделано по кабелю в форме `Персональной сети` (`PAN`).

Беспроводной вариант `Беспроводная персональная сеть` (`WPAN`) основан на технологиях Bluetooth или Wireless USB. `Беспроводная персональная сеть`, устанавливаемая через Bluetooth, называется `Piconet`. `PAN` и `WPAN` обычно простираются всего на несколько метров и поэтому не подходят для соединения устройств в отдельных комнатах или даже зданиях.

В контексте `Интернета вещей` (`IoT`), `WPAN` используются для коммуникаций приложений управления и мониторинга с низкой скоростью передачи данных. Протоколы, такие как Insteon, Z-Wave и ZigBee, были специально разработаны для умных домов и домашней автоматизации.

* Рабочая станция не должна была иметь возможность взаимодействовать с принтером через порт 445
* Принтер не должен иметь возможности инициировать соединения с рабочими станциями. В некоторых случаях комбинации принтер/сканер должны иметь возможность взаимодействовать с почтовым сервером для отправки отсканированных документов по электронной почте.










# Сетевые топологии

---

`Сетевая топология` — это типичное расположение и `физическое` или `логическое` соединение устройств в сети. Компьютеры являются `хостами`, такими как `клиенты` и `серверы`, которые активно используют сеть. Они также включают в себя `сетевые компоненты`, такие как `коммутаторы`, `мосты` и `маршрутизаторы`, которые мы будем обсуждать более подробно в следующих разделах, выполняющие функцию распределения и обеспечивающие возможность установления логического соединения между всеми сетевыми хостами. Сетевая топология определяет компоненты, которые будут использоваться, и методы доступа к среде передачи.

`Схема размещения среды передачи`, используемая для соединения устройств, является физической топологией сети. Для проводных или оптоволоконных сред это относится к схеме прокладки кабелей, расположению `узлов` и соединениям между узлами и кабелями. В отличие от этого, `логическая топология` определяет, как сигналы действуют в сетевой среде или как данные будут передаваться по сети от одного устройства к устройствам с физическим соединением.

---

Всю область сетевой топологии можно разделить на три области:

#### 1. Соединения

| `Проводные соединения` | `Беспроводные соединения` |
|------------------------|---------------------------|
| Коаксиальный кабель    | Wi-Fi                    |
| Оптоволоконный кабель  | Сотовая связь            |
| Витая пара             | Спутниковая связь        |
| и другие               | и другие                 |

---

#### 2. Узлы - Сетевые интерфейсные контроллеры (NIC)

||||
|--------------|---------|---------|
| Повторители  | Хабы    | Мосты   | 
| Маршрутизаторы/Модемы | Шлюзы | Файерволы |

Сетевые узлы — это `точки подключения передающей среды` к передатчикам и приемникам электрических, оптических или радиосигналов в среде. Узел может быть подключен к компьютеру, но определенные типы могут иметь только один микроконтроллер на узле или вообще не иметь программируемого устройства.

---

#### 3. Классификации

Мы можем представить топологию как виртуальную форму или `структуру сети`. Эта форма не обязательно соответствует фактическому физическому расположению устройств в сети. Поэтому эти топологии могут быть как `физическими`, так и `логическими`. Например, компьютеры в `локальной сети` могут быть расположены по кругу в спальне, но вероятность того, что они образуют фактическую кольцевую топологию, очень мала.

Сетевые топологии делятся на следующие восемь основных типов:

|||
|---------------|---------|
| Точка-точка   | Шина    |
| Звезда        | Кольцо  |
| Ячеистая      | Дерево  |
| Гибридная     | Последовательная цепь |

Более сложные сети могут быть построены как гибриды двух или более из вышеупомянутых базовых топологий.

---

## Точка-точка

Самой простой сетевой топологией с выделенным соединением между двумя хостами является топология `точка-точка`. В этой топологии прямое и непосредственное физическое соединение существует только между `двумя хостами`. Эти два устройства могут использовать эти соединения для взаимного обмена данными.

Топологии `точка-точка` являются базовой моделью традиционной телефонии и не должны путаться с архитектурой `P2P` (`Peer-to-Peer`).

#### Топология точка-точка

![Топология точка-точка](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_p2p.png)

---

## Шина

В топологии шины все хосты подключены через передающую среду. Каждый хост имеет доступ к передающей среде и сигналам, которые передаются по ней. Нет центрального сетевого компонента, который контролирует процессы в ней. Средой передачи для этого может быть, например, `коаксиальный кабель`.

Поскольку среда используется совместно со всеми другими, только `один хост может отправлять` данные, а все остальные могут только получать и оценивать данные, чтобы определить, предназначены ли они для них.

#### Топология шины

![Топология шины](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_bus.png)

---

## Звезда

Топология звезды представляет собой сетевой компонент, поддерживающий соединение со всеми хостами. Каждый хост подключен к `центральному сетевому компоненту` через отдельную линию связи. Обычно это маршрутизатор, концентратор или коммутатор. Они выполняют `функцию пересылки` пакетов данных. Для этого пакеты данных принимаются и пересылаются к месту назначения.
Трафик данных на центральном сетевом компоненте может быть очень высоким, поскольку все данные и соединения проходят через него.

#### Топология звезды

![Топология звезды](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_star.png)

---

## Кольцо

`Физическая` кольцевая топология устроена так, что каждый хост или узел подключен к кольцу двумя кабелями:

* Один для `входящих` сигналов и
* другой для `исходящих` сигналов.

Это означает, что к каждому хосту приходит один кабель и один кабель выходит. Кольцевая топология обычно не требует активного сетевого компонента. Управление и доступ к среде передачи регулируются протоколом, которому следуют все станции.

`Логическая` кольцевая топология основана на физической топологии звезды, где распределитель в узле имитирует кольцо, пересылая данные от одного порта к следующему.

Информация передается в заранее определенном направлении передачи. Как правило, доступ к среде передачи осуществляется последовательно от станции к станции с использованием системы опроса от центральной станции или `маркера`. Маркер — это битовый шаблон, который постоянно проходит через кольцевую сеть в одном направлении и работает в соответствии с `процессом присвоения маркера`.

#### Кольцевая топология

![Кольцевая топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_ring.png)

---

## Ячеистая

Множество узлов принимают решения о соединениях на `физическом` уровне и маршрутизации на `логическом` уровне в ячеистых сетях. Поэтому ячеистые структуры не имеют фиксированной топологии. Существуют две основные структуры, исходя из базовой концепции: `полносвязная` и `частично связанная` структура.

Каждый хост соединен с каждым другим хостом в сети в `полносвязной структуре`. Это означает, что хосты соединены друг с другом. Эта техника в основном используется в `глобальных сетях` или `городских сетях` для обеспечения высокой надежности и пропускной способности.

В такой конфигурации вместе могут быть объединены важные сетевые узлы, такие как маршрутизаторы. Если один маршрутизатор выходит из строя, другие могут продолжать работать без проблем, и сеть может компенсировать сбой благодаря множеству соединений.

Каждый узел полносвязной топологии имеет одинаковые функции маршрутизации и знает соседние узлы, с которыми он может взаимодействовать, с учетом близости к сетевому шлюзу и загрузки трафика.

В `частично связанной структуре` конечные точки соединены только одним соединением. В этом типе сетевой топологии некоторые узлы подключены к одному другому узлу, а некоторые другие узлы подключены к двум или более другим узлам с помощью соединения типа точка-точка.

#### Ячеистая топология

![Ячеистая топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_mesh.png)

---

## Дерево

Топология дерева — это расширенная топология звезды, которую имеют более обширные локальные сети в этой структуре. Это особенно полезно при объединении нескольких топологий. Эта топология часто используется, например, в крупных офисных зданиях.

Существуют как логические древовидные структуры в соответствии с `остовным деревом`, так и физические. Модульные современные сети, основанные на структурированной кабельной системе с иерархией концентраторов, также имеют древовидную структуру. Топологии типа дерево также используются для `широкополосных сетей` и `городских сетей` (`MAN`).

#### Древовидная топология

![Древовидная топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_tree.png)

---

## Гибридная

Гибридные сети объединяют две или более топологии, так что результирующая сеть не представляет собой стандартную топологию. Например, древовидная сеть может представлять собой гибридную топологию, в которой звездообразные сети соединены через взаимосвязанные шинные сети. Однако древовидная сеть, связанная с другой древовидной сетью, по-прежнему топологически является древовидной сетью. Гибридная топология всегда создается, когда взаимосвязаны `две различные` базовые сетевые топологии.

#### Гибридная топология

![Гибридная топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_hybrid.png)

---

## Последовательная цепь

В топологии последовательной цепи несколько хостов соединены путем прокладки кабеля от одного узла к другому.

Поскольку это создает цепочку соединений, она также известна как конфигурация последовательной цепи, в которой несколько аппаратных компонентов соединены последовательно. Этот тип сети часто встречается в автоматизированных технологиях (`CAN`).

Последовательная цепь основана на физическом расположении узлов, в отличие от процедур с маркерами, которые являются структурными, но могут быть сделаны независимыми от физического расположения. Сигнал передается к компоненту и от него через его предыдущие узлы к компьютерной системе.

#### Топология последовательной цепи

![Топология последовательной цепи](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_daisy-chain.png)







# Прокси

---

У разных людей разные мнения о том, что такое прокси-сервер:

* Специалисты по безопасности сразу думают о `HTTP-прокси` (BurpSuite) или о переходе с использованием `SOCKS/SSH-прокси` (`Chisel`, `ptunnel`, `sshuttle`).

* Веб-разработчики используют прокси, такие как Cloudflare или ModSecurity, для блокировки вредоносного трафика.

* Обычные люди могут думать, что прокси используется для скрытия своего местоположения и доступа к каталогу Netflix другой страны.

* Правоохранительные органы часто связывают прокси с незаконной деятельностью.

Не все вышеперечисленные примеры верны. Прокси — это когда устройство или сервис находится в середине соединения и действует как посредник. `Посредник` — это ключевая часть информации, потому что это означает, что устройство в середине должно иметь возможность проверять содержимое трафика. Без возможности быть `посредником` устройство технически является `шлюзом`, а не прокси.

Возвращаясь к вышеуказанному вопросу, обычный человек имеет ошибочное представление о том, что такое прокси, поскольку он, скорее всего, использует VPN для скрытия своего местоположения, что технически не является прокси. Большинство людей считают, что когда меняется IP-адрес, это прокси, и в большинстве случаев, вероятно, лучше не поправлять их, так как это распространенное и безвредное заблуждение. Исправление может привести к более длительному разговору, который перерастет в обсуждение табуляции против пробелов, `emacs` против `vim`, или выяснится, что они пользователи `nano`.

Если вам трудно запомнить это, прокси почти всегда работают на 7 уровне модели OSI. Существует множество типов прокси-сервисов, но основными являются:

* `Выделенный прокси` / `Прямой прокси`
* `Обратный прокси`
* `Прозрачный прокси`

---

## Выделенный прокси / Прямой прокси

`Прямой прокси` — это то, что большинство людей представляет себе как прокси. Прямой прокси — это когда клиент отправляет запрос на компьютер, и этот компьютер выполняет запрос.

Например, в корпоративной сети чувствительные компьютеры могут не иметь прямого доступа в Интернет. Для доступа к веб-сайту они должны пройти через прокси (или веб-фильтр). Это может быть невероятно мощной линией защиты от вредоносных программ, поскольку не только нужно обойти веб-фильтр (это легко), но вредоносное ПО также должно быть `прокси-совместимым` или использовать нетрадиционный C2 (способ, которым вредоносное ПО получает информацию о заданиях). Если организация использует только `FireFox`, вероятность получения прокси-совместимого вредоносного ПО крайне мала.

Веб-браузеры, такие как Internet Explorer, Edge или Chrome, по умолчанию соблюдают настройки "Системного прокси". Если вредоносное ПО использует WinSock (нативный Windows API), оно, вероятно, будет прокси-совместимым без какого-либо дополнительного кода. Firefox не использует `WinSock`, а вместо этого использует `libcurl`, что позволяет использовать один и тот же код на любой операционной системе. Это означает, что вредоносному ПО нужно будет искать Firefox и получать настройки прокси, что вредоносное ПО вряд ли будет делать.

Альтернативно, вредоносное ПО может использовать DNS в качестве механизма C2, но если организация отслеживает DNS (что легко сделать с помощью [Sysmon](https://medium.com/falconforce/sysmon-11-dns-improvements-and-filedelete-events-7a74f17ca842), этот тип трафика должен быстро обнаруживаться.

Другим примером Прямого прокси является Burp Suite, поскольку большинство людей используют его для пересылки HTTP-запросов. Однако это приложение — швейцарский нож HTTP-прокси и может быть настроено как обратный прокси или прозрачный прокси!

#### Прямой прокси

![Диаграмма, показывающая как хост A отправляет HTTP-запрос через Прямой прокси в Интернет, достигая Веб-сервера. Хост B также подключен.](https://academy.hackthebox.com/storage/modules/34/redesigned/forward_proxy.png)

---

## Обратный прокси

Как вы уже догадались, `обратный прокси` является противоположностью `Прямого прокси`. Вместо того, чтобы быть предназначенным для фильтрации исходящих запросов, он фильтрует входящие. Наиболее распространенная цель с `Обратным прокси` — слушать адрес и перенаправлять его в закрытую сеть.

Многие организации используют CloudFlare, поскольку у них есть надежная сеть, способная выдержать большинство DDoS-атак. Используя Cloudflare, организации получают способ фильтровать количество (и тип) трафика, который отправляется на их веб-серверы.

Тестировщики на проникновение настраивают обратные прокси на зараженных конечных точках. Зараженная конечная точка слушает порт и отправляет любого клиента, который подключается к порту, обратно атакующему через зараженную конечную точку. Это полезно для обхода брандмауэров или уклонения от ведения журнала. Организации могут иметь `IDS` (`Системы обнаружения вторжений`), наблюдающие за внешними веб-запросами. Если атакующий получает доступ к организации через SSH, обратный прокси может отправлять веб-запросы через SSH-туннель и обходить IDS.

Другим распространенным обратным прокси является `ModSecurity`, `Веб-приложение брандмауэра` (`WAF`). Веб-приложения брандмауэров проверяют веб-запросы на наличие вредоносного содержимого и блокируют запрос, если он вредоносный. Если вы хотите узнать больше об этом, мы рекомендуем ознакомиться с [набором основных правил ModSecurity](https://owasp.org/www-project-modsecurity-core-rule-set/), так как это отличная отправная точка. Cloudflare также может действовать как WAF, но для этого требуется позволить им расшифровывать HTTPS-трафик, что некоторые организации могут не хотеть.

#### Обратный прокси

![Диаграмма, показывающая как хост А отправляет HTTP-запрос через Интернет, проходя через брандмауэры, Обратный прокси и достигая Веб-сервера. Хост B также подключен.](https://academy.hackthebox.com/storage/modules/34/redesigned/reverse_proxy.png)

---

## (Не-)Прозрачный прокси

Все эти прокси-сервисы действуют либо `прозрачно`, либо `непрозрачно`.

С `прозрачным прокси` клиент не знает о его существовании. Прозрачный прокси перехватывает запросы клиента на коммуникацию с Интернетом и действует как заместитель. Для внешнего мира прозрачный прокси, как и непрозрачный прокси, выступает в качестве партнера по коммуникации.

Если это `непрозрачный прокси`, мы должны быть проинформированы о его существовании. Для этой цели нам и программному обеспечению, которое мы хотим использовать, предоставляется специальная конфигурация прокси, которая гарантирует, что трафик в Интернет сначала адресуется прокси. Если эта конфигурация не существует, мы не можем общаться через прокси. Однако, поскольку прокси обычно предоставляет единственный путь коммуникации с другими сетями, коммуникация с Интернетом, как правило, отключена без соответствующей конфигурации прокси.








# Сетевые модели

---

Две сетевые модели описывают коммуникацию и передачу данных от одного хоста к другому: `модель ISO/OSI` и `модель TCP/IP`. Это упрощенное представление так называемых `уровней`, которые преобразуют передаваемые биты в читаемое для нас содержимое.

![Сравнение моделей OSI и TCP/IP: OSI имеет 7 уровней, включая Прикладной, Представления, Сеансовый, Транспортный, Сетевой, Канальный и Физический. TCP/IP имеет 4 уровня: Прикладной, Транспортный, Интернет и Канальный.](https://academy.hackthebox.com/storage/modules/34/redesigned/net_models4.png)

---

## Модель OSI

Модель `OSI`, часто называемая моделью `ISO/OSI`, является эталонной моделью, которая может использоваться для описания и определения коммуникации между системами. Эталонная модель имеет `семь` отдельных уровней, каждый с четко разделенными задачами.

Термин `OSI` означает модель `Open Systems Interconnection` (Взаимодействие открытых систем), опубликованную `Международным союзом электросвязи` (`ITU`) и `Международной организацией по стандартизации` (`ISO`). Поэтому модель `OSI` часто называют `ISO/OSI` моделью.

---

## Модель TCP/IP

`TCP/IP` (`Transmission Control Protocol`/`Internet Protocol`) — это общий термин для множества сетевых протоколов. Эти протоколы отвечают за коммутацию и транспортировку пакетов данных в интернете. Интернет полностью основан на семействе протоколов `TCP/IP`. Однако, `TCP/IP` относится не только к этим двум протоколам, но обычно используется как общий термин для целого семейства протоколов.

Например, `ICMP` (`Internet Control Message Protocol`) или `UDP` (`User Datagram Protocol`) относятся к семейству протоколов. Семейство протоколов предоставляет необходимые функции для транспортировки и коммутации пакетов данных в частной или публичной сети.

---

## ISO/OSI vs. TCP/IP

`TCP/IP` — это коммуникационный протокол, который позволяет хостам подключаться к интернету. Он относится к `Transmission Control Protocol`, используемому в приложениях в интернете. В отличие от `OSI`, он допускает ослабление правил, которым необходимо следовать, при условии соблюдения общих принципов.

`OSI`, с другой стороны, является коммуникационным шлюзом между сетью и конечными пользователями. Модель OSI обычно называют эталонной моделью, поскольку она более новая и широко используемая. Она также известна своим строгим протоколом и ограничениями.

---

## Передача пакетов

В многоуровневой системе устройства на каждом уровне обмениваются данными в различных форматах, называемых `protocol data unit` (`PDU` - блок данных протокола). Например, когда мы хотим просмотреть веб-сайт на компьютере, удаленное серверное программное обеспечение сначала передает запрашиваемые данные на прикладной уровень. Они обрабатываются уровень за уровнем, каждый уровень выполняет свои назначенные функции. Затем данные передаются через физический уровень сети, пока сервер назначения или другое устройство не получит их. Данные снова проходят через уровни, и каждый уровень выполняет свои операции, пока принимающее программное обеспечение не использует данные.

![Сравнение моделей OSI и TCP/IP с PDU: OSI имеет 7 уровней, включая Прикладной, Представления, Сеансовый, Транспортный, Сетевой, Канальный и Физический. TCP/IP имеет 4 уровня: Прикладной, Транспортный, Интернет и Канальный. PDU: Данные, Сегмент/Датаграмма, Пакет, Кадр и Бит.](https://academy.hackthebox.com/storage/modules/34/redesigned/net_models_pdu2.png)

Во время передачи каждый уровень добавляет `заголовок` к `PDU` верхнего уровня, который контролирует и идентифицирует пакет. Этот процесс называется `инкапсуляцией`. Заголовок и данные вместе образуют PDU для следующего уровня. Процесс продолжается до `Физического уровня` или `Сетевого уровня`, где данные передаются получателю. Получатель выполняет обратный процесс и распаковывает данные на каждом уровне с информацией заголовка. После этого приложение наконец использует данные. Этот процесс продолжается до тех пор, пока все данные не будут отправлены и получены.

![Диаграмма передачи пакетов, показывающая инкапсуляцию данных от отправителя к получателю через уровни: Данные, TCP, IP, MAC и Двоичная передача, с соответствующими заголовками и последовательностью.](https://academy.hackthebox.com/storage/modules/34/packet_transfer.png)

Для нас, как пентестеров, обе эталонные модели полезны. С помощью `TCP/IP` мы можем быстро понять, как устанавливается все соединение, а с помощью `ISO` мы можем разобрать его по частям и детально проанализировать. Это часто происходит, когда мы можем прослушивать и перехватывать определенный сетевой трафик. Затем мы должны соответствующим образом анализировать этот трафик, углубляясь в детали в модуле `Network Traffic Analysis`. Поэтому мы должны ознакомиться с обеими эталонными моделями и понять и усвоить их наилучшим возможным образом.





# Модель OSI

---

Целью определения стандарта `ISO/OSI` было создание эталонной модели, которая обеспечивает коммуникацию различных технических систем через разнообразные устройства и технологии, и обеспечивает совместимость. Модель `OSI` использует `семь` различных уровней, которые иерархически основаны друг на друге для достижения этой цели. Эти уровни представляют собой фазы в установлении каждого соединения, через которые проходят отправляемые пакеты. Таким образом, стандарт был создан для визуального отслеживания того, как соединение структурировано и установлено.

| **Уровень** | **Функция** |
|------------|------------|
| `7.Прикладной (Application)` | Помимо прочего, этот уровень контролирует ввод и вывод данных и предоставляет функции приложения. |
| `6.Представительский (Presentation)` | Задача уровня представления - преобразовать системно-зависимое представление данных в форму, независимую от приложения. |
| `5.Сеансовый (Session)` | Сеансовый уровень контролирует логическое соединение между двумя системами и предотвращает, например, разрывы соединения или другие проблемы. |
| `4.Транспортный (Transport)` | Уровень 4 используется для сквозного контроля передаваемых данных. Транспортный уровень может обнаруживать и избегать перегрузок и сегментировать потоки данных. |
| `3.Сетевой (Network)` | На сетевом уровне устанавливаются соединения в сетях с коммутацией каналов, а пакеты данных пересылаются в сетях с коммутацией пакетов. Данные передаются по всей сети от отправителя к получателю. |
| `2.Канальный (Data Link)` | Центральная задача уровня 2 - обеспечить надежную и безошибочную передачу данных на соответствующем носителе. Для этого битовые потоки с уровня 1 делятся на блоки или кадры. |
| `1.Физический (Physical)` | Используемые методы передачи - это, например, электрические сигналы, оптические сигналы или электромагнитные волны. Через уровень 1 передача осуществляется по проводным или беспроводным линиям передачи. |

---

Уровни `2-4` являются `транспортно-ориентированными`, а уровни `5-7` - `прикладными` уровнями. На каждом уровне выполняются точно определенные задачи, и интерфейсы к соседним уровням точно описаны. Каждый уровень предлагает услуги для использования уровню непосредственно над ним. Чтобы предоставить эти услуги, уровень использует услуги уровня под ним и выполняет задачи своего уровня.

Если две системы взаимодействуют, все семь уровней модели `OSI` проходятся как минимум `дважды`, поскольку и отправитель, и получатель должны учитывать модель уровней. Следовательно, на отдельных уровнях должно выполняться большое количество различных задач для обеспечения безопасности, надежности и производительности связи.

Когда приложение отправляет пакет в другую систему, система обрабатывает уровни, показанные выше, от уровня `7` до уровня `1`, а принимающая система распаковывает полученный пакет от уровня `1` до уровня `7`.






# Модель TCP/IP

---

Модель `TCP/IP` также является многоуровневой эталонной моделью, часто называемой `Набором Интернет-протоколов`. Термин `TCP/IP` обозначает два протокола: `Протокол управления передачей` (`TCP`) и `Интернет-протокол` (`IP`). `IP` находится в `сетевом уровне` (`Уровень 3`), а `TCP` находится в `транспортном уровне` (`Уровень 4`) модели `OSI`.

| **Уровень** | **Функция** |
|-------------|-------------|
| `4.Прикладной` | Прикладной уровень позволяет приложениям получать доступ к службам других уровней и определяет протоколы, которые приложения используют для обмена данными. |
| `3.Транспортный` | Транспортный уровень отвечает за предоставление сессионных (TCP) и дейтаграммных (UDP) сервисов для Прикладного уровня. |
| `2.Интернет` | Интернет-уровень отвечает за адресацию хостов, упаковку и маршрутизацию. |
| `1.Канальный` | Канальный уровень отвечает за размещение TCP/IP-пакетов на сетевом носителе и прием соответствующих пакетов из сетевого носителя. TCP/IP разработан для независимой работы от метода доступа к сети, формата кадра и среды передачи. |

---

С помощью `TCP/IP` любое приложение может передавать и обмениваться данными по любой сети, и неважно, где находится получатель. `IP` гарантирует, что пакет данных достигнет своего назначения, а `TCP` контролирует передачу данных и обеспечивает соединение между потоком данных и приложением. Основное различие между `TCP/IP` и `OSI` заключается в количестве уровней, некоторые из которых были объединены.

![Сравнение моделей OSI и TCP/IP: OSI имеет 7 уровней, включая Прикладной, Представительский, Сеансовый, Транспортный, Сетевой, Канальный и Физический. TCP/IP имеет 4 уровня: Прикладной, Транспортный, Интернет и Канальный.](https://academy.hackthebox.com/storage/modules/34/redesigned/net_models4.png)

Наиболее важные задачи `TCP/IP`:

| **Задача** | **Протокол** | **Описание** |
|------------|--------------|--------------|
| `Логическая адресация` | `IP` | Из-за множества хостов в разных сетях возникает необходимость структурировать сетевую топологию и логическую адресацию. В TCP/IP, IP берет на себя логическую адресацию сетей и узлов. Пакеты данных достигают только той сети, для которой они предназначены. Методы для этого включают `классы сетей`, `подсети` и `CIDR`. |
| `Маршрутизация` | `IP` | Для каждого пакета данных следующий узел определяется в каждом узле на пути от отправителя к получателю. Таким образом, пакет данных направляется к получателю, даже если его местоположение неизвестно отправителю. |
| `Контроль ошибок и потока` | `TCP` | Отправитель и получатель часто поддерживают связь через виртуальное соединение. Поэтому контрольные сообщения отправляются постоянно, чтобы проверить, установлено ли соединение. |
| `Поддержка приложений` | `TCP` | Порты TCP и UDP образуют программную абстракцию для различения конкретных приложений и их коммуникационных каналов. |
| `Разрешение имен` | `DNS` | DNS обеспечивает преобразование Полностью Квалифицированных Доменных Имен (FQDN) в IP-адреса, позволяя нам достигать желаемого хоста с указанным именем в интернете. |





# Сетевой уровень

---

`Сетевой уровень` (`Уровень 3`) модели `OSI` контролирует обмен пакетами данных, поскольку они не могут быть напрямую направлены получателю и должны быть обеспечены маршрутизирующими узлами. Пакеты данных передаются от узла к узлу, пока не достигнут своей цели. Для реализации этого `сетевой уровень` идентифицирует отдельные сетевые узлы, устанавливает и освобождает каналы соединения, а также заботится о маршрутизации и контроле потока данных. При отправке пакетов оцениваются адреса, и данные маршрутизируются по сети от узла к узлу. Обычно в узлах не происходит обработки данных на уровнях выше `L3`. На основе адресов осуществляется маршрутизация и создание таблиц маршрутизации.

Если кратко, он отвечает за следующие функции:

* `Логическая адресация`
* `Маршрутизация`

На каждом уровне `OSI` определены протоколы, и эти протоколы представляют собой набор правил для коммуникации на соответствующем уровне. Они прозрачны для протоколов уровней выше или ниже. Некоторые протоколы выполняют задачи нескольких уровней и охватывают два или более уровня. Наиболее используемые протоколы на этом уровне:

* `IPv4` / `IPv6`
* `IPsec`
* `ICMP`
* `IGMP`
* `RIP`
* `OSPF`

Он обеспечивает маршрутизацию пакетов от источника к месту назначения внутри или вне подсети. Эти две подсети могут иметь различные схемы адресации или несовместимые типы адресации. В обоих случаях передача данных проходит через всю коммуникационную сеть и включает маршрутизацию между сетевыми узлами. Поскольку прямая связь между отправителем и получателем не всегда возможна из-за различных подсетей, пакеты должны быть переданы от узлов (маршрутизаторов), которые находятся на пути. Пересылаемые пакеты не достигают более высоких уровней, им назначается новое промежуточное место назначения, и они отправляются к следующему узлу.





# IP-адреса

---

Каждый хост в сети может быть идентифицирован с помощью так называемого адреса `Media Access Control` (`MAC`). Это позволяет обмениваться данными внутри одной сети. Если удаленный хост находится в другой сети, знания MAC-адреса недостаточно для установления соединения. Адресация в Интернете осуществляется через адреса `IPv4` и/или `IPv6`, которые состоят из `сетевого адреса` и `адреса хоста`.

Неважно, идет ли речь о небольшой сети, такой как домашняя компьютерная сеть, или о всем Интернете. IP-адрес обеспечивает доставку данных правильному получателю. Мы можем представить адреса `MAC` и `IPv4` / `IPv6` следующим образом:

- `IPv4` / `IPv6` - описывает уникальный почтовый адрес и район здания получателя.
- `MAC` - описывает точный этаж и квартиру получателя.

Возможно, чтобы один IP-адрес адресовал нескольких получателей (широковещательная рассылка) или чтобы устройство отвечало на несколько IP-адресов. Однако необходимо обеспечить, чтобы каждый IP-адрес был назначен только один раз в пределах сети.

---

## Структура IPv4

Наиболее распространенным методом назначения IP-адресов является `IPv4`, который состоит из `32`-битного двоичного числа, объединенного в `4 байта`, состоящих из `8`-битных групп (`октетов`), значения которых находятся в диапазоне от `0 до 255`. Они преобразуются в более легко читаемые десятичные числа, разделенные точками и представленные в десятичной нотации с точками.

Таким образом, IPv4-адрес может выглядеть так:

| **Нотация** | **Представление** |
|------------|------------------|
| Двоичная    | 0111 1111.0000 0000.0000 0000.0000 0001 |
| Десятичная   | 127.0.0.1 |

Каждому сетевому интерфейсу (сетевым картам, сетевым принтерам или маршрутизаторам) назначается уникальный IP-адрес.

Формат `IPv4` позволяет иметь 4 294 967 296 уникальных адресов. IP-адрес разделен на `часть хоста` и `сетевую часть`. `Маршрутизатор` назначает `часть хоста` IP-адреса дома или администратором. Соответствующий `сетевой администратор` назначает `сетевую часть`. В Интернете это делает `IANA`, которая выделяет и управляет уникальными IP-адресами.

В прошлом здесь проводилась дальнейшая классификация. Блоки IP-сетей были разделены на `классы от A до E`. Различные классы отличались соответствующей длиной частей хоста и сети.

| **`Класс`** | **Сетевой адрес** | **Первый адрес** | **Последний адрес** | **Маска подсети** | **CIDR** | **Подсети** | **IP-адреса** |
|------------|------------------|-----------------|---------------------|-------------------|----------|-------------|-------------|
| `A`        | 1.0.0.0          | 1.0.0.1         | 127.255.255.255     | 255.0.0.0         | /8       | 127         | 16,777,214 + 2 |
| `B`        | 128.0.0.0        | 128.0.0.1       | 191.255.255.255     | 255.255.0.0       | /16      | 16,384      | 65,534 + 2  |
| `C`        | 192.0.0.0        | 192.0.0.1       | 223.255.255.255     | 255.255.255.0     | /24      | 2,097,152   | 254 + 2     |
| `D`        | 224.0.0.0        | 224.0.0.1       | 239.255.255.255     | Multicast         | Multicast| Multicast   | Multicast   |
| `E`        | 240.0.0.0        | 240.0.0.1       | 255.255.255.255     | reserved          | reserved | reserved    | reserved    |

---

## Маска подсети

Дальнейшее разделение этих классов на малые сети осуществляется с помощью `подсетей`. Это разделение выполняется с использованием `масок сети`, которые имеют такую же длину, как и IPv4-адрес. Как и в случае с классами, они описывают, какие позиции битов в IP-адресе действуют как `сетевая часть` или `часть хоста`.

| **Класс** | **Сетевой адрес** | **Первый адрес** | **Последний адрес** | **`Маска подсети`** | **CIDR** | **Подсети** | **IP-адреса** |
|-----------|------------------|-----------------|---------------------|---------------------|----------|-------------|-------------|
| **A**     | 1.0.0.0          | 1.0.0.1         | 127.255.255.255     | `255.0.0.0`         | /8       | 127         | 16,777,214 + 2 |
| **B**     | 128.0.0.0        | 128.0.0.1       | 191.255.255.255     | `255.255.0.0`       | /16      | 16,384      | 65,534 + 2  |
| **C**     | 192.0.0.0        | 192.0.0.1       | 223.255.255.255     | `255.255.255.0`     | /24      | 2,097,152   | 254 + 2     |
| **D**     | 224.0.0.0        | 224.0.0.1       | 239.255.255.255     | `Multicast`         | Multicast| Multicast   | Multicast   |
| **E**     | 240.0.0.0        | 240.0.0.1       | 255.255.255.255     | `reserved`          | reserved | reserved    | reserved    |

---

## Сетевые и шлюзовые адреса

`Два` дополнительных `IP-адреса`, добавленных в `столбце IP-адресов`, зарезервированы для так называемого `сетевого адреса` и `широковещательного адреса`. Ещё одну важную роль играет `шлюз по умолчанию`, который является названием для IPv4-адреса `маршрутизатора`, объединяющего сети и системы с различными протоколами и управляющего адресами и методами передачи. Обычно `шлюзу по умолчанию` присваивается первый или последний доступный IPv4-адрес в подсети. Это не является техническим требованием, но стало де-факто стандартом в сетевых средах любого размера.

| **Класс** | **Сетевой адрес** | **`Первый адрес`** | **Последний адрес** | **Маска подсети** | **CIDR** | **Подсети** | **`IP-адреса`** |
|-----------|------------------|-------------------|---------------------|-------------------|----------|-------------|--------------|
| A         | 1.0.0.0          | `1.0.0.1`         | 126.255.255.255     | 255.0.0.0         | /8       | 126         | 16,777,214 `+ 2` |
| B         | 128.0.0.0        | `128.0.0.1`       | 191.255.255.255     | 255.255.0.0       | /16      | 16,384      | 65,534 `+ 2` |
| C         | 192.0.0.0        | `192.0.0.1`       | 223.255.255.255     | 255.255.255.0     | /24      | 2,097,152   | 254 `+ 2`    |
| D         | 224.0.0.0        | `224.0.0.1`       | 239.255.255.255     | Multicast         | Multicast| Multicast   | Multicast    |
| E         | 240.0.0.0        | `240.0.0.1`       | 255.255.255.255     | reserved          | reserved | reserved    | reserved     |

---

## Широковещательный адрес

Задачей `широковещательного` IP-адреса является соединение всех устройств в сети друг с другом. `Широковещательная передача` в сети - это сообщение, которое передается всем участникам сети и не требует ответа. Таким образом, хост отправляет пакет данных всем другим участникам сети одновременно и при этом сообщает свой `IP-адрес`, который получатели могут использовать для связи с ним. Это `последний IPv4`-адрес, который используется для `широковещательной передачи`.

| **Класс** | **Сетевой адрес** | **Первый адрес** | **`Последний адрес`** | **Маска подсети** | **CIDR** | **Подсети** | **IP-адреса** |
|-----------|------------------|-----------------|---------------------|-------------------|----------|-------------|-------------|
| A         | 1.0.0.0          | 1.0.0.1         | `127.255.255.255`   | 255.0.0.0         | /8       | 127         | 16,777,214 + 2 |
| B         | 128.0.0.0        | 128.0.0.1       | `191.255.255.255`   | 255.255.0.0       | /16      | 16,384      | 65,534 + 2  |
| C         | 192.0.0.0        | 192.0.0.1       | `223.255.255.255`   | 255.255.255.0     | /24      | 2,097,152   | 254 + 2     |
| D         | 224.0.0.0        | 224.0.0.1       | `239.255.255.255`   | Multicast         | Multicast| Multicast   | Multicast   |
| E         | 240.0.0.0        | 240.0.0.1       | `255.255.255.255`   | reserved          | reserved | reserved    | reserved    |

---

## Двоичная система

Двоичная система - это система счисления, которая использует только два различных состояния, представленных двумя цифрами (`0` и `1`), в отличие от десятичной системы (от 0 до 9).

IPv4-адрес разделен на 4 октета, как мы уже видели. Каждый `октет` состоит из `8 бит`. Каждая позиция бита в октете имеет определенное десятичное значение. Возьмем в качестве примера следующий IPv4-адрес:

- IPv4-адрес: `192.168.10.39`

Вот пример того, как выглядит `первый октет`:

#### 1-й октет - Значение: 192

```
Значения:        128  64  32  16  8  4  2  1
Двоичный:         1   1   0   0  0  0  0  0
```

Если мы вычислим сумму всех этих значений для каждого октета, где бит установлен в `1`, мы получим сумму:

| **Октет** | **Значения** | **Сумма** |
|-----------|-------------|-----------|
| 1-й       | 128 + 64 + 0 + 0 + 0 + 0 + 0 + 0 | = `192` |
| 2-й       | 128 + 0 + 32 + 0 + 8 + 0 + 0 + 0 | = `168` |
| 3-й       | 0 + 0 + 0 + 0 + 8 + 0 + 2 + 0    | = `10`  |
| 4-й       | 0 + 0 + 32 + 0 + 0 + 4 + 2 + 1   | = `39`  |

Полное представление от двоичного к десятичному выглядело бы так:

#### IPv4 - Двоичная нотация

```
Октет:             1-й         2-й         3-й         4-й
Двоичный:      1100 0000 . 1010 1000 . 0000 1010 . 0010 0111
Десятичный:        192    .    168    .     10    .     39
```

- IPv4-адрес: `192.168.10.39`

Это сложение происходит для каждого октета, что приводит к десятичному представлению `IPv4-адреса`. Маска подсети рассчитывается аналогичным образом.

#### IPv4 - Десятичный в двоичный

```
Значения:        128  64  32  16  8  4  2  1
Двоичный:         1   1   1   1  1  1  1  1
```

| **Октет** | **Значения** | **Сумма** |
|-----------|-------------|-----------|
| 1-й       | 128 + 64 + 32 + 16 + 8 + 4 + 2 + 1 | = `255` |
| 2-й       | 128 + 64 + 32 + 16 + 8 + 4 + 2 + 1 | = `255` |
| 3-й       | 128 + 64 + 32 + 16 + 8 + 4 + 2 + 1 | = `255` |
| 4-й       | 0 + 0 + 0 + 0 + 0 + 0 + 0 + 0      | = `0`   |

#### Маска подсети

```
Октет:             1-й         2-й         3-й         4-й
Двоичный:      1111 1111 . 1111 1111 . 1111 1111 . 0000 0000 (/24)
Десятичный:        255    .    255    .    255    .     0
```

- IPv4-адрес: `192.168.10.39`
- Маска подсети: `255.255.255.0`

---

## CIDR

`Бесклассовая межзональная маршрутизация` (`CIDR`) - это метод представления, который заменяет фиксированное назначение между IPv4-адресом и сетевыми классами (A, B, C, D, E). Разделение основано на маске подсети или так называемом `суффиксе CIDR`, который позволяет побитово разделять адресное пространство IPv4 и, таким образом, на `подсети` любого размера. `Суффикс CIDR` указывает, сколько битов от начала IPv4-адреса принадлежат сети. Это нотация, которая представляет `маску подсети`, указывая количество `1`-битов в маске подсети.

Давайте придерживаться следующего IPv4-адреса и маски подсети в качестве примера:

- IPv4-адрес: `192.168.10.39`
- Маска подсети: `255.255.255.0`

Теперь всё представление IPv4-адреса и маски подсети будет выглядеть так:

- CIDR: `192.168.10.39/24`

Суффикс CIDR, таким образом, является суммой всех единиц в маске подсети.

```
Октет:             1-й         2-й         3-й         4-й
Двоичный:      1111 1111 . 1111 1111 . 1111 1111 . 0000 0000 (/24)
Десятичный:        255    .    255    .    255    .     0
```






# Подсети

---

Разделение диапазона IPv4-адресов на несколько меньших диапазонов называется `подсетями`.

Подсеть - это логический сегмент сети, использующий IP-адреса с одинаковым сетевым адресом. Подсеть можно представить как обозначенный вход в большой коридор здания. Например, это может быть стеклянная дверь, разделяющая различные отделы в здании компании. С помощью подсетей мы можем создать конкретную подсеть самостоятельно или определить следующую структуру соответствующей сети:

* `Сетевой адрес`
* `Широковещательный адрес`
* `Первый хост`
* `Последний хост`
* `Количество хостов`

Возьмем следующий IPv4-адрес и маску подсети в качестве примера:

* IPv4-адрес: `192.168.12.160`
* Маска подсети: `255.255.255.192`
* CIDR: `192.168.12.160/26`

---

Мы уже знаем, что IP-адрес делится на `сетевую часть` и `хостовую часть`.

#### Сетевая часть

| **Детали** | **1-й октет** | **2-й октет** | **3-й октет** | **4-й октет** | **Десятичный** |
|------------|---------------|---------------|---------------|---------------|----------------|
| IPv4 | `1100 0000` | `1010 1000` | `0000 1100` | `10`10 0000 | 192.168.12.160`/26` |
| Маска подсети | `1111 1111` | `1111 1111` | `1111 1111` | `11`00 0000 | `255.255.255.192` |
| Биты | /8 | /16 | /24 | /32 | |

В подсетях мы используем маску подсети как шаблон для IPv4-адреса. По `1`-битам в маске подсети мы знаем, какие биты в IPv4-адресе `не могут` быть изменены. Они `фиксированы` и, следовательно, определяют "основную сеть", в которой находится подсеть.

#### Хостовая часть

| **Детали** | **1-й октет** | **2-й октет** | **3-й октет** | **4-й октет** | **Десятичный** |
|------------|---------------|---------------|---------------|---------------|----------------|
| IPv4 | 1100 0000 | 1010 1000 | 0000 1100 | 10`10 0000` | 192.168.12.160/26 |
| Маска подсети | 1111 1111 | 1111 1111 | 1111 1111 | 11`00 0000` | 255.255.255.192 |
| Биты | /8 | /16 | /24 | /32 | |

Биты в `хостовой части` могут быть изменены для получения `первого` и `последнего` адреса. Первый адрес - это `сетевой адрес`, а последний адрес - это `широковещательный адрес` для соответствующей подсети.

`Сетевой адрес` важен для доставки пакета данных. Если `сетевой адрес` одинаков для адреса источника и адреса назначения, пакет данных доставляется внутри той же подсети. Если сетевые адреса разные, пакет данных должен быть направлен в другую подсеть через `шлюз по умолчанию`.

`Маска подсети` определяет, где происходит это разделение.

#### Разделение сетевой и хостовой частей

| **Детали** | **1-й октет** | **2-й октет** | **3-й октет** | **4-й октет** | **Десятичный** |
|------------|---------------|---------------|---------------|---------------|----------------|
| IPv4 | 1100 0000 | 1010 1000 | 0000 1100 | 10`|`10 0000 | 192.168.12.160/26 |
| Маска подсети | `1111 1111` | `1111 1111` | `1111 1111` | `11|`00 0000 | 255.255.255.192 |
| Биты | /8 | /16 | /24 | /32 | |

---

#### Сетевой адрес

Если мы установим все биты `хостовой части` IPv4-адреса в `0`, мы получим `сетевой адрес` соответствующей подсети.

| **Детали** | **1-й октет** | **2-й октет** | **3-й октет** | **4-й октет** | **Десятичный** |
|------------|---------------|---------------|---------------|---------------|----------------|
| IPv4 | 1100 0000 | 1010 1000 | 0000 1100 | 10`|00 0000` | `192.168.12.128`/26 |
| Маска подсети | `1111 1111` | `1111 1111` | `1111 1111` | `11|`00 0000 | 255.255.255.192 |
| Биты | /8 | /16 | /24 | /32 | |

---

#### Широковещательный адрес

Если мы установим все биты `хостовой части` IPv4-адреса в `1`, мы получим `широковещательный адрес`.

| **Детали** | **1-й октет** | **2-й октет** | **3-й октет** | **4-й октет** | **Десятичный** |
|------------|---------------|---------------|---------------|---------------|----------------|
| IPv4 | 1100 0000 | 1010 1000 | 0000 1100 | 10`|11 1111` | `192.168.12.191`/26 |
| Маска подсети | `1111 1111` | `1111 1111` | `1111 1111` | `11|`00 0000 | 255.255.255.192 |
| Биты | /8 | /16 | /24 | /32 | |

Поскольку мы теперь знаем, что IPv4-адреса `192.168.12.128` и `192.168.12.191` зарезервированы, все остальные IPv4-адреса находятся в диапазоне `192.168.12.129-190`. Теперь мы знаем, что эта подсеть предоставляет нам в общей сложности `64 - 2` (сетевой адрес и широковещательный адрес) или `62` IPv4-адресов, которые мы можем назначить нашим хостам.

| **Хосты** | **IPv4** |
|-----------|----------|
| Сетевой адрес | `192.168.12.128` |
| Первый хост | `192.168.12.129` |
| Другие хосты | `...` |
| Последний хост | `192.168.12.190` |
| Широковещательный адрес | `192.168.12.191` |

---

## Разделение на более мелкие сети

Допустим, что нам, как администраторам, была поставлена задача разделить назначенную нам подсеть на 4 дополнительные подсети. При этом важно знать, что мы можем разделить подсети только в соответствии с двоичной системой.

| **Степень** | **Значение** |
|-------------|--------------|
| 2`^0` | = 1 |
| 2`^1` | = 2 |
| 2`^2` | = 4 |
| 2`^3` | = 8 |
| 2`^4` | = 16 |
| 2`^5` | = 32 |
| 2`^6` | = 64 |
| 2`^7` | = 128 |
| 2`^8` | = 256 |

---

Поэтому мы можем разделить `64 хоста`, которые мы знаем, на `4`. Число `4` равно степени 2`^2` в двоичной системе, поэтому мы определяем количество битов для маски подсети, на которое мы должны её расширить. Итак, мы знаем следующие параметры:

* Подсеть: `192.168.12.128/26`
* Требуемые подсети: `4`

Теперь мы увеличиваем/расширяем нашу маску подсети на `2 бита` с `26` до `28`, и она будет выглядеть так:

| **Детали** | **1-й октет** | **2-й октет** | **3-й октет** | **4-й октет** | **Десятичный** |
|------------|---------------|---------------|---------------|---------------|----------------|
| IPv4 | 1100 0000 | 1010 1000 | 0000 1100 | 1000`|` 0000 | 192.168.12.128`/28` |
| Маска подсети | `1111 1111` | `1111 1111` | `1111 1111` | `1111|` 0000 | `255.255.255.240` |
| Биты | /8 | /16 | /24 | /32 | |

Далее, мы можем разделить `64` IPv4-адреса, которые у нас есть, на `4 части`:

| **Хосты** | **Математика** | **Подсети** | **Диапазон хостов для каждой подсети** |
|-----------|----------------|-------------|---------------------------------------|
| 64 | / | 4 | = `16` |

Теперь мы знаем, каким будет размер каждой подсети. Начиная с сетевого адреса, который нам дан (192.168.12.128), мы добавляем `16` хостов `4` раза:

| **№ подсети** | **Сетевой адрес** | **Первый хост** | **Последний хост** | **Широковещательный адрес** | **CIDR** |
|---------------|-------------------|-----------------|--------------------|-----------------------------|----------|
| 1 | `192.168.12.128` | 192.168.12.129 | 192.168.12.142 | `192.168.12.143` | 192.168.12.128/28 |
| 2 | `192.168.12.144` | 192.168.12.145 | 192.168.12.158 | `192.168.12.159` | 192.168.12.144/28 |
| 3 | `192.168.12.160` | 192.168.12.161 | 192.168.12.174 | `192.168.12.175` | 192.168.12.160/28 |
| 4 | `192.168.12.176` | 192.168.12.177 | 192.168.12.190 | `192.168.12.191` | 192.168.12.176/28 |

---

## Мысленное создание подсетей

Может показаться, что в создании подсетей задействовано много математики, но каждый октет повторяет себя, и всё основано на степенях двойки, поэтому запоминать нужно не так много. Первое, что нужно сделать, это определить, какой октет меняется.

| **1-й октет** | **2-й октет** | **3-й октет** | **4-й октет** |
|---------------|---------------|---------------|---------------|
| /8 | /16 | /24 | /32 |

Можно определить, какой октет IP-адреса может меняться, запомнив эти четыре числа. Если дан сетевой адрес: `192.168.1.1/25`, сразу становится очевидно, что 192.168.2.4 не будет находиться в той же сети, потому что подсеть `/25` означает, что может меняться только четвертый октет.

Следующая часть определяет, каким может быть размер каждой подсети, путем деления восьми на размер сети и поиска `остатка`. Это также называется `операцией по модулю (%)` и широко используется в криптологии. В нашем предыдущем примере с `/25`, `(25 % 8)` будет равен 1. Это потому, что восемь входит в 25 три раза (8 * 3 = 24). Остаётся 1, что является сетевым битом, зарезервированным для маски сети. Всего в каждом октете IP-адреса восемь битов. Если один используется для маски сети, уравнение становится 2^(8-1) или 2^7, 128. В таблице ниже приведены все числа.

| **Остаток** | **Число** | **Экспоненциальная форма** | **Форма деления** |
|-------------|-----------|----------------------------|-------------------|
| 0 | 256 | 2^8 | 256 |
| 1 | 128 | 2^7 | 256/2 |
| 2 | 64 | 2^6 | 256/2/2 |
| 3 | 32 | 2^5 | 256/2/2/2 |
| 4 | 16 | 2^4 | 256/2/2/2/2 |
| 5 | 8 | 2^3 | 256/2/2/2/2/2 |
| 6 | 4 | 2^2 | 256/2/2/2/2/2/2 |
| 7 | 2 | 2^1 | 256/2/2/2/2/2/2/2 |

Запомнив степени двойки до восьми, можно мгновенно производить расчеты. Однако, если они забыты, может быть быстрее запомнить принцип деления 256 пополам столько раз, сколько составляет остаток.

Сложная часть заключается в определении фактического диапазона IP-адресов, потому что 0 в сетях — это число, а не пустое значение. Так, в нашем `/25` со 128 IP-адресами первый диапазон — `192.168.1.0-127`. Первый адрес — это сетевой, а последний — широковещательный адрес, что означает, что используемое IP-пространство будет `192.168.1.1-126`. Если наш IP-адрес будет выше 128, то `используемое ip-пространство` будет 192.168.1.129-254 (128 — это сетевой адрес, а 255 — широковещательный).
