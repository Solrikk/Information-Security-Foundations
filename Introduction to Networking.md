
# Обзор сетей

---

Сеть позволяет двум компьютерам взаимодействовать друг с другом. Существует широкий спектр `топологий` (mesh/tree/star), `сред передачи данных` (ethernet/fiber/coax/wireless) и `протоколов` (TCP/UDP/IPX), которые могут использоваться для организации сети. Специалистам по безопасности важно понимать принципы работы сетей, потому что когда сеть выходит из строя, это может произойти незаметно, из-за чего мы можем пропустить что-то важное.

Настройка большой плоской сети не является чрезвычайно сложной задачей, и она может быть надежной сетью, по крайней мере, с операционной точки зрения. Однако плоская сеть подобна дому, построенному на земельном участке, который считается безопасным только потому, что на двери есть замок. Создавая множество малых сетей и обеспечивая их взаимодействие, мы можем добавить слои защиты. Перемещение по сети не составляет труда, но делать это быстро и незаметно сложно, что замедлит атакующих. Вернемся к аналогии с домом и рассмотрим следующие примеры:

#### Пример № 1

Создание небольших сетей и применение списков контроля доступа (ACL) — это как установка забора вокруг границы участка, который создает конкретные точки входа и выхода. Да, атакующий может перепрыгнуть через забор, но это выглядит подозрительно и нетипично, что позволяет быстро выявить вредоносную активность. Почему сеть принтеров общается с серверами по HTTP?

#### Пример № 2

Время, потраченное на составление карты и документирование назначения каждой сети, подобно установке освещения вокруг дома, позволяющего видеть всю активность. Почему сеть принтеров вообще взаимодействует с интернетом?

#### Пример № 3

Наличие кустарников вокруг окон является сдерживающим фактором для людей, пытающихся открыть окно. Точно так же системы обнаружения вторжений, такие как Suricata или Snort, являются сдерживающим фактором для запуска сетевого сканирования. Почему сканирование портов началось из сети принтеров?

Эти примеры могут показаться глупыми, и здравый смысл подсказывает блокировать все вышеперечисленное для принтера. Однако, если принтер находится в "плоской сети /24" и получает адрес по DHCP, может быть сложно применить такие ограничения.

---

## История из практики — Недосмотр пентестера

Большинство сетей используют подсеть `/24`, настолько часто, что многие пентестеры устанавливают эту маску подсети (255.255.255.0) без проверки. Сеть /24 позволяет компьютерам общаться друг с другом, если первые три октета IP-адреса совпадают (например, 192.168.1.xxx). Установка маски подсети `/25` разделяет этот диапазон пополам, и компьютер сможет общаться только с компьютерами на "своей половине". Мы видели отчеты о пентестах, где оценщик утверждал, что контроллер домена не работает, хотя на самом деле он просто находился в другой сети. Структура сети была примерно такой:

* Шлюз сервера: 10.20.0.1/25
* Контроллер домена: 10.20.0.10/25
* Шлюз клиента: 10.20.0.129/25
* Клиентская рабочая станция: 10.20.0.200/25
* IP пентестера: 10.20.0.252/24 (Установлен шлюз 10.20.0.1)

Пентестер взаимодействовал с клиентскими рабочими станциями и думал, что выполнил отличную работу, поскольку смог украсть пароль рабочей станции через Impacket. Однако из-за непонимания сети они так и не смогли выйти за пределы клиентской сети и достичь более "ценных целей", таких как серверы баз данных. Надеемся, если это звучит непонятно, вы сможете вернуться к этому утверждению в конце модуля и понять его!

---

## Основная информация

Давайте взглянем на следующую схему высокого уровня, которая показывает, как может работать настройка работы из дома.

![Схема домашней сети с маршрутизатором, подключающим смартфон, ноутбук и ПК, и корпоративной сети с маршрутизатором, подключающим коммутатор, веб-сервер, IP-телефон, принтер и два клиентских хоста. Обе сети подключены к Интернет-провайдеру (ISP), с сервером доменных имен (DNS) и доступом в интернет.](https://academy.hackthebox.com/storage/modules/34/net_overview.png)

---

Весь интернет основан на множестве подразделенных сетей, как показано в примере и обозначено как "`Домашняя сеть`" и "`Корпоративная сеть`". Мы можем представить `сети` как доставку почты или посылок, отправленных одним компьютером и полученных другим.

Представим сценарий, в котором мы хотим посетить веб-сайт компании из нашей "`Домашней сети`". В этом случае мы обмениваемся данными с веб-сайтом компании, расположенным в их "`Корпоративной сети`". Как и при отправке почты или посылок, мы знаем адрес, куда должны идти пакеты. Адрес веб-сайта или `Унифицированный указатель ресурса` (`URL`), который мы вводим в браузере, также известен как `Полное доменное имя` (`FQDN`).

Разница между `URL` и `FQDN` заключается в том, что:

* `FQDN` (`www.hackthebox.eu`) указывает только адрес "здания", а
* `URL` (`https://www.hackthebox.eu/example?floor=2&office=dev&employee=17`) также указывает "`этаж`", "`офис`", "`почтовый ящик`" и соответствующего "`сотрудника`", для которого предназначен пакет.

Мы обсудим точные представления и определения более четко и точно в других разделах.

Факт в том, что мы знаем адрес, но не точное географическое местоположение этого адреса. В этой ситуации почтовое отделение может определить точное местоположение, а затем переслать пакеты в нужное место. Таким образом, наше почтовое отделение пересылает наши пакеты в главное почтовое отделение, представляющее нашего `Интернет-провайдера` (`ISP`).

Наше почтовое отделение — это наш `маршрутизатор`, который мы используем для подключения к "Интернету" в сетевом взаимодействии.

Как только мы отправляем наш пакет через наше почтовое отделение (`маршрутизатор`), пакет пересылается в `главное почтовое отделение` (`ISP`). Это главное почтовое отделение смотрит в `адресном реестре`/`телефонной книге` (`Службе доменных имен`), где находится этот адрес, и возвращает соответствующие географические координаты (`IP-адрес`). Теперь, когда мы знаем точное местоположение адреса, наш пакет отправляется прямо туда прямым рейсом через наше главное почтовое отделение.

После того, как веб-сервер получил наш пакет с запросом о том, как выглядит их веб-сайт, веб-сервер отправляет нам обратно пакет с данными для отображения веб-сайта через почтовое отделение (`маршрутизатор`) "`Корпоративной сети`" на указанный обратный адрес (`наш IP-адрес`).

---

## Дополнительные замечания

В этой схеме я надеюсь, что показанная корпоративная сеть состоит из пяти отдельных сетей!

1. Веб-сервер должен находиться в DMZ (демилитаризованной зоне), потому что клиенты в интернете могут инициировать взаимодействие с веб-сайтом, что делает его более уязвимым для компрометации. Размещение его в отдельной сети позволяет администраторам установить сетевую защиту между веб-сервером и другими устройствами.

2. Рабочие станции должны быть в своей собственной сети, и в идеальном мире каждая рабочая станция должна иметь правило межсетевого экрана на уровне хоста, предотвращающее взаимодействие с другими рабочими станциями. Если рабочая станция находится в той же сети, что и сервер, сетевые атаки, такие как `подмена` или `человек посередине`, становятся гораздо более серьезной проблемой.

3. Коммутатор и маршрутизатор должны находиться в "Административной сети". Это предотвращает подслушивание рабочими станциями любого взаимодействия между этими устройствами. Я часто проводил тесты на проникновение и видел рекламу `OSPF` (Open Shortest Path First). Поскольку у маршрутизатора не было `доверенной сети`, любой во внутренней сети мог отправить вредоносную рекламу и выполнить атаку типа `человек посередине` против любой сети.

4. IP-телефоны должны быть в своей собственной сети. С точки зрения безопасности это необходимо для предотвращения подслушивания компьютерами. В дополнение к безопасности, телефоны уникальны в том смысле, что задержка/лаг имеет большое значение. Размещение их в собственной сети может позволить сетевым администраторам более легко приоритизировать их трафик для предотвращения высокой задержки.

5. Принтеры должны быть в своей собственной сети. Это может звучать странно, но защитить принтер практически невозможно. Из-за того, как работает Windows, если принтер сообщает компьютеру, что требуется аутентификация во время задания печати, этот компьютер попытается выполнить аутентификацию `NTLMv2`, что может привести к краже паролей. Кроме того, эти устройства отлично подходят для обеспечения устойчивости и, как правило, содержат множество конфиденциальной информации.

---

## Забавная история

Во время COVID мне было поручено выполнить `Физический тест на проникновение` через границы штатов, и мой штат находился под приказом о `домашнем карантине`. В компании, которую я тестировал, в офисе было минимальное количество персонала. Я решил купить дорогой принтер и внедрить в него обратную оболочку, чтобы при подключении к сети он отправлял мне шелл (удаленный доступ). Затем я отправил принтер в компанию и отправил фишинговое письмо, благодаря персонал за то, что они приходят на работу, и объясняя, что принтер должен позволить им печатать или сканировать быстрее, если они хотят взять что-то домой для работы из дома на несколько дней. Принтер был подключен почти мгновенно, и компьютер их доменного администратора любезно отправил принтеру свои учетные данные!

Если бы клиент спроектировал безопасную сеть, эта атака, вероятно, была бы невозможна по многим причинам:

* Принтер не должен был иметь возможность взаимодействовать с интернетом
* Рабочая станция не должна была иметь возможность взаимодействовать с принтером через порт 445
* Принтер не должен иметь возможности инициировать соединения с рабочими станциями. В некоторых случаях комбинации принтер/сканер должны иметь возможность взаимодействовать с почтовым сервером для отправки отсканированных документов по электронной почте.
