
# Обзор сетей

---

Сеть позволяет двум компьютерам взаимодействовать друг с другом. Существует широкий спектр `топологий` (mesh/tree/star), `сред передачи данных` (ethernet/fiber/coax/wireless) и `протоколов` (TCP/UDP/IPX), которые могут использоваться для организации сети. Специалистам по безопасности важно понимать принципы работы сетей, потому что когда сеть выходит из строя, это может произойти незаметно, из-за чего мы можем пропустить что-то важное.

Настройка большой плоской сети не является чрезвычайно сложной задачей, и она может быть надежной сетью, по крайней мере, с операционной точки зрения. Однако плоская сеть подобна дому, построенному на земельном участке, который считается безопасным только потому, что на двери есть замок. Создавая множество малых сетей и обеспечивая их взаимодействие, мы можем добавить слои защиты. Перемещение по сети не составляет труда, но делать это быстро и незаметно сложно, что замедлит атакующих. Вернемся к аналогии с домом и рассмотрим следующие примеры:

#### Пример № 1

Создание небольших сетей и применение списков контроля доступа (ACL) — это как установка забора вокруг границы участка, который создает конкретные точки входа и выхода. Да, атакующий может перепрыгнуть через забор, но это выглядит подозрительно и нетипично, что позволяет быстро выявить вредоносную активность. Почему сеть принтеров общается с серверами по HTTP?

#### Пример № 2

Время, потраченное на составление карты и документирование назначения каждой сети, подобно установке освещения вокруг дома, позволяющего видеть всю активность. Почему сеть принтеров вообще взаимодействует с интернетом?

#### Пример № 3

Наличие кустарников вокруг окон является сдерживающим фактором для людей, пытающихся открыть окно. Точно так же системы обнаружения вторжений, такие как Suricata или Snort, являются сдерживающим фактором для запуска сетевого сканирования. Почему сканирование портов началось из сети принтеров?

Эти примеры могут показаться глупыми, и здравый смысл подсказывает блокировать все вышеперечисленное для принтера. Однако, если принтер находится в "плоской сети /24" и получает адрес по DHCP, может быть сложно применить такие ограничения.

---

## История из практики — Недосмотр пентестера

Большинство сетей используют подсеть `/24`, настолько часто, что многие пентестеры устанавливают эту маску подсети (255.255.255.0) без проверки. Сеть /24 позволяет компьютерам общаться друг с другом, если первые три октета IP-адреса совпадают (например, 192.168.1.xxx). Установка маски подсети `/25` разделяет этот диапазон пополам, и компьютер сможет общаться только с компьютерами на "своей половине". Мы видели отчеты о пентестах, где оценщик утверждал, что контроллер домена не работает, хотя на самом деле он просто находился в другой сети. Структура сети была примерно такой:

* Шлюз сервера: 10.20.0.1/25
* Контроллер домена: 10.20.0.10/25
* Шлюз клиента: 10.20.0.129/25
* Клиентская рабочая станция: 10.20.0.200/25
* IP пентестера: 10.20.0.252/24 (Установлен шлюз 10.20.0.1)

Пентестер взаимодействовал с клиентскими рабочими станциями и думал, что выполнил отличную работу, поскольку смог украсть пароль рабочей станции через Impacket. Однако из-за непонимания сети они так и не смогли выйти за пределы клиентской сети и достичь более "ценных целей", таких как серверы баз данных. Надеемся, если это звучит непонятно, вы сможете вернуться к этому утверждению в конце модуля и понять его!

---

## Основная информация

Давайте взглянем на следующую схему высокого уровня, которая показывает, как может работать настройка работы из дома.

![Схема домашней сети с маршрутизатором, подключающим смартфон, ноутбук и ПК, и корпоративной сети с маршрутизатором, подключающим коммутатор, веб-сервер, IP-телефон, принтер и два клиентских хоста. Обе сети подключены к Интернет-провайдеру (ISP), с сервером доменных имен (DNS) и доступом в интернет.](https://academy.hackthebox.com/storage/modules/34/redesigned/net_overview.png)

---

Весь интернет основан на множестве подразделенных сетей, как показано в примере и обозначено как "`Домашняя сеть`" и "`Корпоративная сеть`". Мы можем представить `сети` как доставку почты или посылок, отправленных одним компьютером и полученных другим.

Представим сценарий, в котором мы хотим посетить веб-сайт компании из нашей "`Домашней сети`". В этом случае мы обмениваемся данными с веб-сайтом компании, расположенным в их "`Корпоративной сети`". Как и при отправке почты или посылок, мы знаем адрес, куда должны идти пакеты. Адрес веб-сайта или `Унифицированный указатель ресурса` (`URL`), который мы вводим в браузере, также известен как `Полное доменное имя` (`FQDN`).

Разница между `URL` и `FQDN` заключается в том, что:

* `FQDN` (`www.hackthebox.eu`) указывает только адрес "здания", а
* `URL` (`https://www.hackthebox.eu/example?floor=2&office=dev&employee=17`) также указывает "`этаж`", "`офис`", "`почтовый ящик`" и соответствующего "`сотрудника`", для которого предназначен пакет.

Мы обсудим точные представления и определения более четко и точно в других разделах.

Факт в том, что мы знаем адрес, но не точное географическое местоположение этого адреса. В этой ситуации почтовое отделение может определить точное местоположение, а затем переслать пакеты в нужное место. Таким образом, наше почтовое отделение пересылает наши пакеты в главное почтовое отделение, представляющее нашего `Интернет-провайдера` (`ISP`).

Наше почтовое отделение — это наш `маршрутизатор`, который мы используем для подключения к "Интернету" в сетевом взаимодействии.

Как только мы отправляем наш пакет через наше почтовое отделение (`маршрутизатор`), пакет пересылается в `главное почтовое отделение` (`ISP`). Это главное почтовое отделение смотрит в `адресном реестре`/`телефонной книге` (`Службе доменных имен`), где находится этот адрес, и возвращает соответствующие географические координаты (`IP-адрес`). Теперь, когда мы знаем точное местоположение адреса, наш пакет отправляется прямо туда прямым рейсом через наше главное почтовое отделение.

После того, как веб-сервер получил наш пакет с запросом о том, как выглядит их веб-сайт, веб-сервер отправляет нам обратно пакет с данными для отображения веб-сайта через почтовое отделение (`маршрутизатор`) "`Корпоративной сети`" на указанный обратный адрес (`наш IP-адрес`).

---

## Дополнительные замечания

В этой схеме я надеюсь, что показанная корпоративная сеть состоит из пяти отдельных сетей!

1. Веб-сервер должен находиться в DMZ (демилитаризованной зоне), потому что клиенты в интернете могут инициировать взаимодействие с веб-сайтом, что делает его более уязвимым для компрометации. Размещение его в отдельной сети позволяет администраторам установить сетевую защиту между веб-сервером и другими устройствами.

2. Рабочие станции должны быть в своей собственной сети, и в идеальном мире каждая рабочая станция должна иметь правило межсетевого экрана на уровне хоста, предотвращающее взаимодействие с другими рабочими станциями. Если рабочая станция находится в той же сети, что и сервер, сетевые атаки, такие как `подмена` или `человек посередине`, становятся гораздо более серьезной проблемой.

3. Коммутатор и маршрутизатор должны находиться в "Административной сети". Это предотвращает подслушивание рабочими станциями любого взаимодействия между этими устройствами. Я часто проводил тесты на проникновение и видел рекламу `OSPF` (Open Shortest Path First). Поскольку у маршрутизатора не было `доверенной сети`, любой во внутренней сети мог отправить вредоносную рекламу и выполнить атаку типа `человек посередине` против любой сети.

4. IP-телефоны должны быть в своей собственной сети. С точки зрения безопасности это необходимо для предотвращения подслушивания компьютерами. В дополнение к безопасности, телефоны уникальны в том смысле, что задержка/лаг имеет большое значение. Размещение их в собственной сети может позволить сетевым администраторам более легко приоритизировать их трафик для предотвращения высокой задержки.

5. Принтеры должны быть в своей собственной сети. Это может звучать странно, но защитить принтер практически невозможно. Из-за того, как работает Windows, если принтер сообщает компьютеру, что требуется аутентификация во время задания печати, этот компьютер попытается выполнить аутентификацию `NTLMv2`, что может привести к краже паролей. Кроме того, эти устройства отлично подходят для обеспечения устойчивости и, как правило, содержат множество конфиденциальной информации.

---

## Забавная история

Во время COVID мне было поручено выполнить `Физический тест на проникновение` через границы штатов, и мой штат находился под приказом о `домашнем карантине`. В компании, которую я тестировал, в офисе было минимальное количество персонала. Я решил купить дорогой принтер и внедрить в него обратную оболочку, чтобы при подключении к сети он отправлял мне шелл (удаленный доступ). Затем я отправил принтер в компанию и отправил фишинговое письмо, благодаря персонал за то, что они приходят на работу, и объясняя, что принтер должен позволить им печатать или сканировать быстрее, если они хотят взять что-то домой для работы из дома на несколько дней. Принтер был подключен почти мгновенно, и компьютер их доменного администратора любезно отправил принтеру свои учетные данные!

Если бы клиент спроектировал безопасную сеть, эта атака, вероятно, была бы невозможна по многим причинам:

* Принтер не должен был иметь возможность взаимодействовать с интернетом





# Типы сетей

---

Каждая сеть имеет свою структуру и настраивается индивидуально. По этой причине были разработаны так называемые `типы` и `топологии`, которые используются для категоризации этих сетей. При изучении всех типов сетей можно столкнуться с переизбытком информации, так как некоторые типы сетей включают в себя географический охват. Мы редко слышим некоторые термины на практике, поэтому этот раздел будет разделен на `Общие термины` и `Книжные термины`. Книжные термины полезно знать, поскольку был зафиксирован единственный документированный случай, когда почтовый сервер не смог доставить электронные письма длиннее 500 миль, но от вас не требуется цитировать их по требованию, если только вы не изучаете сетевые технологии для экзамена.

#### Общая терминология

| **Тип сети** | **Определение** |
|--------------|-----------------|
| Глобальная сеть (WAN) | Интернет |
| Локальная сеть (LAN) | Внутренние сети (например: домашняя или офисная) |
| Беспроводная локальная сеть (WLAN) | Внутренние сети, доступные через Wi-Fi |
| Виртуальная частная сеть (VPN) | Соединяет несколько сетевых узлов в одну `LAN` |

---

## WAN

WAN (Wide Area Network, Глобальная сеть) обычно называется `Интернетом`. При работе с сетевым оборудованием у нас часто будет WAN-адрес и LAN-адрес. WAN — это адрес, к которому обычно осуществляется доступ из Интернета. Тем не менее, это не ограничивается только Интернетом; WAN — это просто большое количество объединенных LAN-сетей. Многие крупные компании или правительственные учреждения имеют "Внутреннюю WAN" (также называемую Интранет, Изолированная сеть и т.д.). В общем, основным способом определения того, является ли сеть WAN, является использование специфичного для WAN протокола маршрутизации, такого как BGP, и если используемая IP-схема не входит в RFC 1918 (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16).

---

## LAN / WLAN

LAN (Local Area Network, Локальная сеть) и WLAN (Wireless Local Area Network, Беспроводная локальная сеть) обычно назначают IP-адреса, предназначенные для локального использования (RFC 1918, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16). В некоторых случаях, например в некоторых колледжах или отелях, вам может быть назначен маршрутизируемый (интернет) IP-адрес при подключении к их LAN, но это встречается гораздо реже. Между LAN и WLAN нет никакой разницы, кроме того, что WLAN предоставляет возможность передачи данных без кабелей. В основном это обозначение безопасности.

---

## VPN

Существует три основных типа `Виртуальных частных сетей` (`VPN`), но все три имеют одну и ту же цель — создать у пользователя ощущение, что он подключен к другой сети.

#### Site-To-Site VPN

И клиент, и сервер являются сетевыми устройствами, обычно либо `Маршрутизаторами`, либо `Межсетевыми экранами`, и они совместно используют целые диапазоны сетей. Это наиболее часто используется для объединения корпоративных сетей через Интернет, позволяя нескольким местоположениям взаимодействовать через Интернет, как если бы они были локальными.

#### Remote Access VPN

Это подразумевает создание компьютером клиента виртуального интерфейса, который ведет себя так, как если бы он находился в сети клиента. Hack The Box использует `OpenVPN`, который создает TUN адаптер, позволяющий нам получать доступ к лабораториям. При анализе этих VPN важным элементом для рассмотрения является таблица маршрутизации, которая создается при подключении к VPN. Если VPN создает маршруты только для определенных сетей (например: 10.10.10.0/24), это называется `Split-Tunnel VPN`, что означает, что интернет-соединение не проходит через VPN. Это отлично подходит для Hack The Box, поскольку обеспечивает доступ к лаборатории без опасений по поводу конфиденциальности и мониторинга вашего интернет-соединения. Однако для компании `split-tunnel` VPN обычно не идеален, потому что если машина заражена вредоносным ПО, сетевые методы обнаружения, вероятно, не будут работать, так как этот трафик направляется через Интернет.

#### SSL VPN

По сути, это VPN, который работает в нашем веб-браузере и становится все более распространенным, поскольку веб-браузеры становятся способными делать что угодно. Обычно они будут транслировать приложения или целые сеансы рабочего стола в ваш веб-браузер. Отличным примером этого является HackTheBox Pwnbox.

---

## Книжные термины

| Тип сети | Определение |
|----------|-------------|
| Глобальная сеть (GAN) | Глобальная сеть (Интернет) |
| Городская сеть (MAN) | Региональная сеть (несколько LAN) |
| Беспроводная персональная сеть (WPAN) | Персональная сеть (Bluetooth) |

#### GAN

Всемирная сеть, такая как `Интернет`, известна как `Глобальная сеть` (`GAN`). Однако Интернет — не единственная компьютерная сеть такого рода. Международные компании также поддерживают изолированные сети, охватывающие несколько `WAN` и соединяющие компьютеры компании по всему миру. `GAN` используют инфраструктуру оптоволоконных линий глобальных сетей и соединяют их международными подводными кабелями или спутниковой передачей.

#### MAN

`Городская сеть` (`MAN`) — это широкополосная телекоммуникационная сеть, которая соединяет несколько `LAN` в географической близости. Как правило, это отдельные филиалы компании, подключенные к `MAN` через выделенные линии. Используются высокопроизводительные маршрутизаторы и высокопроизводительные соединения на основе оптоволокна, которые обеспечивают значительно более высокую пропускную способность, чем Интернет. Скорость передачи между двумя удаленными узлами сопоставима с коммуникацией в пределах `LAN`.

Инфраструктуру для `MAN` предоставляют международные операторы сетей. Города, подключенные как `Городские сети`, могут быть интегрированы в надрегиональном масштабе в `Глобальные сети` (`WAN`) и на международном уровне в `Глобальные сети` (`GAN`).

#### PAN / WPAN

Современные конечные устройства, такие как смартфоны, планшеты, ноутбуки или настольные компьютеры, могут быть соединены для формирования сети для обмена данными. Это может быть сделано по кабелю в форме `Персональной сети` (`PAN`).

Беспроводной вариант `Беспроводная персональная сеть` (`WPAN`) основан на технологиях Bluetooth или Wireless USB. `Беспроводная персональная сеть`, устанавливаемая через Bluetooth, называется `Piconet`. `PAN` и `WPAN` обычно простираются всего на несколько метров и поэтому не подходят для соединения устройств в отдельных комнатах или даже зданиях.

В контексте `Интернета вещей` (`IoT`), `WPAN` используются для коммуникаций приложений управления и мониторинга с низкой скоростью передачи данных. Протоколы, такие как Insteon, Z-Wave и ZigBee, были специально разработаны для умных домов и домашней автоматизации.

* Рабочая станция не должна была иметь возможность взаимодействовать с принтером через порт 445
* Принтер не должен иметь возможности инициировать соединения с рабочими станциями. В некоторых случаях комбинации принтер/сканер должны иметь возможность взаимодействовать с почтовым сервером для отправки отсканированных документов по электронной почте.










# Сетевые топологии

---

`Сетевая топология` — это типичное расположение и `физическое` или `логическое` соединение устройств в сети. Компьютеры являются `хостами`, такими как `клиенты` и `серверы`, которые активно используют сеть. Они также включают в себя `сетевые компоненты`, такие как `коммутаторы`, `мосты` и `маршрутизаторы`, которые мы будем обсуждать более подробно в следующих разделах, выполняющие функцию распределения и обеспечивающие возможность установления логического соединения между всеми сетевыми хостами. Сетевая топология определяет компоненты, которые будут использоваться, и методы доступа к среде передачи.

`Схема размещения среды передачи`, используемая для соединения устройств, является физической топологией сети. Для проводных или оптоволоконных сред это относится к схеме прокладки кабелей, расположению `узлов` и соединениям между узлами и кабелями. В отличие от этого, `логическая топология` определяет, как сигналы действуют в сетевой среде или как данные будут передаваться по сети от одного устройства к устройствам с физическим соединением.

---

Всю область сетевой топологии можно разделить на три области:

#### 1. Соединения

| `Проводные соединения` | `Беспроводные соединения` |
|------------------------|---------------------------|
| Коаксиальный кабель    | Wi-Fi                    |
| Оптоволоконный кабель  | Сотовая связь            |
| Витая пара             | Спутниковая связь        |
| и другие               | и другие                 |

---

#### 2. Узлы - Сетевые интерфейсные контроллеры (NIC)

||||
|--------------|---------|---------|
| Повторители  | Хабы    | Мосты   | 
| Маршрутизаторы/Модемы | Шлюзы | Файерволы |

Сетевые узлы — это `точки подключения передающей среды` к передатчикам и приемникам электрических, оптических или радиосигналов в среде. Узел может быть подключен к компьютеру, но определенные типы могут иметь только один микроконтроллер на узле или вообще не иметь программируемого устройства.

---

#### 3. Классификации

Мы можем представить топологию как виртуальную форму или `структуру сети`. Эта форма не обязательно соответствует фактическому физическому расположению устройств в сети. Поэтому эти топологии могут быть как `физическими`, так и `логическими`. Например, компьютеры в `локальной сети` могут быть расположены по кругу в спальне, но вероятность того, что они образуют фактическую кольцевую топологию, очень мала.

Сетевые топологии делятся на следующие восемь основных типов:

|||
|---------------|---------|
| Точка-точка   | Шина    |
| Звезда        | Кольцо  |
| Ячеистая      | Дерево  |
| Гибридная     | Последовательная цепь |

Более сложные сети могут быть построены как гибриды двух или более из вышеупомянутых базовых топологий.

---

## Точка-точка

Самой простой сетевой топологией с выделенным соединением между двумя хостами является топология `точка-точка`. В этой топологии прямое и непосредственное физическое соединение существует только между `двумя хостами`. Эти два устройства могут использовать эти соединения для взаимного обмена данными.

Топологии `точка-точка` являются базовой моделью традиционной телефонии и не должны путаться с архитектурой `P2P` (`Peer-to-Peer`).

#### Топология точка-точка

![Топология точка-точка](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_p2p.png)

---

## Шина

В топологии шины все хосты подключены через передающую среду. Каждый хост имеет доступ к передающей среде и сигналам, которые передаются по ней. Нет центрального сетевого компонента, который контролирует процессы в ней. Средой передачи для этого может быть, например, `коаксиальный кабель`.

Поскольку среда используется совместно со всеми другими, только `один хост может отправлять` данные, а все остальные могут только получать и оценивать данные, чтобы определить, предназначены ли они для них.

#### Топология шины

![Топология шины](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_bus.png)

---

## Звезда

Топология звезды представляет собой сетевой компонент, поддерживающий соединение со всеми хостами. Каждый хост подключен к `центральному сетевому компоненту` через отдельную линию связи. Обычно это маршрутизатор, концентратор или коммутатор. Они выполняют `функцию пересылки` пакетов данных. Для этого пакеты данных принимаются и пересылаются к месту назначения.
Трафик данных на центральном сетевом компоненте может быть очень высоким, поскольку все данные и соединения проходят через него.

#### Топология звезды

![Топология звезды](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_star.png)

---

## Кольцо

`Физическая` кольцевая топология устроена так, что каждый хост или узел подключен к кольцу двумя кабелями:

* Один для `входящих` сигналов и
* другой для `исходящих` сигналов.

Это означает, что к каждому хосту приходит один кабель и один кабель выходит. Кольцевая топология обычно не требует активного сетевого компонента. Управление и доступ к среде передачи регулируются протоколом, которому следуют все станции.

`Логическая` кольцевая топология основана на физической топологии звезды, где распределитель в узле имитирует кольцо, пересылая данные от одного порта к следующему.

Информация передается в заранее определенном направлении передачи. Как правило, доступ к среде передачи осуществляется последовательно от станции к станции с использованием системы опроса от центральной станции или `маркера`. Маркер — это битовый шаблон, который постоянно проходит через кольцевую сеть в одном направлении и работает в соответствии с `процессом присвоения маркера`.

#### Кольцевая топология

![Кольцевая топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_ring.png)

---

## Ячеистая

Множество узлов принимают решения о соединениях на `физическом` уровне и маршрутизации на `логическом` уровне в ячеистых сетях. Поэтому ячеистые структуры не имеют фиксированной топологии. Существуют две основные структуры, исходя из базовой концепции: `полносвязная` и `частично связанная` структура.

Каждый хост соединен с каждым другим хостом в сети в `полносвязной структуре`. Это означает, что хосты соединены друг с другом. Эта техника в основном используется в `глобальных сетях` или `городских сетях` для обеспечения высокой надежности и пропускной способности.

В такой конфигурации вместе могут быть объединены важные сетевые узлы, такие как маршрутизаторы. Если один маршрутизатор выходит из строя, другие могут продолжать работать без проблем, и сеть может компенсировать сбой благодаря множеству соединений.

Каждый узел полносвязной топологии имеет одинаковые функции маршрутизации и знает соседние узлы, с которыми он может взаимодействовать, с учетом близости к сетевому шлюзу и загрузки трафика.

В `частично связанной структуре` конечные точки соединены только одним соединением. В этом типе сетевой топологии некоторые узлы подключены к одному другому узлу, а некоторые другие узлы подключены к двум или более другим узлам с помощью соединения типа точка-точка.

#### Ячеистая топология

![Ячеистая топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_mesh.png)

---

## Дерево

Топология дерева — это расширенная топология звезды, которую имеют более обширные локальные сети в этой структуре. Это особенно полезно при объединении нескольких топологий. Эта топология часто используется, например, в крупных офисных зданиях.

Существуют как логические древовидные структуры в соответствии с `остовным деревом`, так и физические. Модульные современные сети, основанные на структурированной кабельной системе с иерархией концентраторов, также имеют древовидную структуру. Топологии типа дерево также используются для `широкополосных сетей` и `городских сетей` (`MAN`).

#### Древовидная топология

![Древовидная топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_tree.png)

---

## Гибридная

Гибридные сети объединяют две или более топологии, так что результирующая сеть не представляет собой стандартную топологию. Например, древовидная сеть может представлять собой гибридную топологию, в которой звездообразные сети соединены через взаимосвязанные шинные сети. Однако древовидная сеть, связанная с другой древовидной сетью, по-прежнему топологически является древовидной сетью. Гибридная топология всегда создается, когда взаимосвязаны `две различные` базовые сетевые топологии.

#### Гибридная топология

![Гибридная топология](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_hybrid.png)

---

## Последовательная цепь

В топологии последовательной цепи несколько хостов соединены путем прокладки кабеля от одного узла к другому.

Поскольку это создает цепочку соединений, она также известна как конфигурация последовательной цепи, в которой несколько аппаратных компонентов соединены последовательно. Этот тип сети часто встречается в автоматизированных технологиях (`CAN`).

Последовательная цепь основана на физическом расположении узлов, в отличие от процедур с маркерами, которые являются структурными, но могут быть сделаны независимыми от физического расположения. Сигнал передается к компоненту и от него через его предыдущие узлы к компьютерной системе.

#### Топология последовательной цепи

![Топология последовательной цепи](https://academy.hackthebox.com/storage/modules/34/redesigned/topo_daisy-chain.png)







# Прокси

---

У разных людей разные мнения о том, что такое прокси-сервер:

* Специалисты по безопасности сразу думают о `HTTP-прокси` (BurpSuite) или о переходе с использованием `SOCKS/SSH-прокси` (`Chisel`, `ptunnel`, `sshuttle`).

* Веб-разработчики используют прокси, такие как Cloudflare или ModSecurity, для блокировки вредоносного трафика.

* Обычные люди могут думать, что прокси используется для скрытия своего местоположения и доступа к каталогу Netflix другой страны.

* Правоохранительные органы часто связывают прокси с незаконной деятельностью.

Не все вышеперечисленные примеры верны. Прокси — это когда устройство или сервис находится в середине соединения и действует как посредник. `Посредник` — это ключевая часть информации, потому что это означает, что устройство в середине должно иметь возможность проверять содержимое трафика. Без возможности быть `посредником` устройство технически является `шлюзом`, а не прокси.

Возвращаясь к вышеуказанному вопросу, обычный человек имеет ошибочное представление о том, что такое прокси, поскольку он, скорее всего, использует VPN для скрытия своего местоположения, что технически не является прокси. Большинство людей считают, что когда меняется IP-адрес, это прокси, и в большинстве случаев, вероятно, лучше не поправлять их, так как это распространенное и безвредное заблуждение. Исправление может привести к более длительному разговору, который перерастет в обсуждение табуляции против пробелов, `emacs` против `vim`, или выяснится, что они пользователи `nano`.

Если вам трудно запомнить это, прокси почти всегда работают на 7 уровне модели OSI. Существует множество типов прокси-сервисов, но основными являются:

* `Выделенный прокси` / `Прямой прокси`
* `Обратный прокси`
* `Прозрачный прокси`

---

## Выделенный прокси / Прямой прокси

`Прямой прокси` — это то, что большинство людей представляет себе как прокси. Прямой прокси — это когда клиент отправляет запрос на компьютер, и этот компьютер выполняет запрос.

Например, в корпоративной сети чувствительные компьютеры могут не иметь прямого доступа в Интернет. Для доступа к веб-сайту они должны пройти через прокси (или веб-фильтр). Это может быть невероятно мощной линией защиты от вредоносных программ, поскольку не только нужно обойти веб-фильтр (это легко), но вредоносное ПО также должно быть `прокси-совместимым` или использовать нетрадиционный C2 (способ, которым вредоносное ПО получает информацию о заданиях). Если организация использует только `FireFox`, вероятность получения прокси-совместимого вредоносного ПО крайне мала.

Веб-браузеры, такие как Internet Explorer, Edge или Chrome, по умолчанию соблюдают настройки "Системного прокси". Если вредоносное ПО использует WinSock (нативный Windows API), оно, вероятно, будет прокси-совместимым без какого-либо дополнительного кода. Firefox не использует `WinSock`, а вместо этого использует `libcurl`, что позволяет использовать один и тот же код на любой операционной системе. Это означает, что вредоносному ПО нужно будет искать Firefox и получать настройки прокси, что вредоносное ПО вряд ли будет делать.

Альтернативно, вредоносное ПО может использовать DNS в качестве механизма C2, но если организация отслеживает DNS (что легко сделать с помощью [Sysmon](https://medium.com/falconforce/sysmon-11-dns-improvements-and-filedelete-events-7a74f17ca842), этот тип трафика должен быстро обнаруживаться.

Другим примером Прямого прокси является Burp Suite, поскольку большинство людей используют его для пересылки HTTP-запросов. Однако это приложение — швейцарский нож HTTP-прокси и может быть настроено как обратный прокси или прозрачный прокси!

#### Прямой прокси

![Диаграмма, показывающая как хост A отправляет HTTP-запрос через Прямой прокси в Интернет, достигая Веб-сервера. Хост B также подключен.](https://academy.hackthebox.com/storage/modules/34/redesigned/forward_proxy.png)

---

## Обратный прокси

Как вы уже догадались, `обратный прокси` является противоположностью `Прямого прокси`. Вместо того, чтобы быть предназначенным для фильтрации исходящих запросов, он фильтрует входящие. Наиболее распространенная цель с `Обратным прокси` — слушать адрес и перенаправлять его в закрытую сеть.

Многие организации используют CloudFlare, поскольку у них есть надежная сеть, способная выдержать большинство DDoS-атак. Используя Cloudflare, организации получают способ фильтровать количество (и тип) трафика, который отправляется на их веб-серверы.

Тестировщики на проникновение настраивают обратные прокси на зараженных конечных точках. Зараженная конечная точка слушает порт и отправляет любого клиента, который подключается к порту, обратно атакующему через зараженную конечную точку. Это полезно для обхода брандмауэров или уклонения от ведения журнала. Организации могут иметь `IDS` (`Системы обнаружения вторжений`), наблюдающие за внешними веб-запросами. Если атакующий получает доступ к организации через SSH, обратный прокси может отправлять веб-запросы через SSH-туннель и обходить IDS.

Другим распространенным обратным прокси является `ModSecurity`, `Веб-приложение брандмауэра` (`WAF`). Веб-приложения брандмауэров проверяют веб-запросы на наличие вредоносного содержимого и блокируют запрос, если он вредоносный. Если вы хотите узнать больше об этом, мы рекомендуем ознакомиться с [набором основных правил ModSecurity](https://owasp.org/www-project-modsecurity-core-rule-set/), так как это отличная отправная точка. Cloudflare также может действовать как WAF, но для этого требуется позволить им расшифровывать HTTPS-трафик, что некоторые организации могут не хотеть.

#### Обратный прокси

![Диаграмма, показывающая как хост А отправляет HTTP-запрос через Интернет, проходя через брандмауэры, Обратный прокси и достигая Веб-сервера. Хост B также подключен.](https://academy.hackthebox.com/storage/modules/34/redesigned/reverse_proxy.png)

---

## (Не-)Прозрачный прокси

Все эти прокси-сервисы действуют либо `прозрачно`, либо `непрозрачно`.

С `прозрачным прокси` клиент не знает о его существовании. Прозрачный прокси перехватывает запросы клиента на коммуникацию с Интернетом и действует как заместитель. Для внешнего мира прозрачный прокси, как и непрозрачный прокси, выступает в качестве партнера по коммуникации.

Если это `непрозрачный прокси`, мы должны быть проинформированы о его существовании. Для этой цели нам и программному обеспечению, которое мы хотим использовать, предоставляется специальная конфигурация прокси, которая гарантирует, что трафик в Интернет сначала адресуется прокси. Если эта конфигурация не существует, мы не можем общаться через прокси. Однако, поскольку прокси обычно предоставляет единственный путь коммуникации с другими сетями, коммуникация с Интернетом, как правило, отключена без соответствующей конфигурации прокси.








# Сетевые модели

---

Две сетевые модели описывают коммуникацию и передачу данных от одного хоста к другому: `модель ISO/OSI` и `модель TCP/IP`. Это упрощенное представление так называемых `уровней`, которые преобразуют передаваемые биты в читаемое для нас содержимое.

![Сравнение моделей OSI и TCP/IP: OSI имеет 7 уровней, включая Прикладной, Представления, Сеансовый, Транспортный, Сетевой, Канальный и Физический. TCP/IP имеет 4 уровня: Прикладной, Транспортный, Интернет и Канальный.](https://academy.hackthebox.com/storage/modules/34/redesigned/net_models4.png)

---

## Модель OSI

Модель `OSI`, часто называемая моделью `ISO/OSI`, является эталонной моделью, которая может использоваться для описания и определения коммуникации между системами. Эталонная модель имеет `семь` отдельных уровней, каждый с четко разделенными задачами.

Термин `OSI` означает модель `Open Systems Interconnection` (Взаимодействие открытых систем), опубликованную `Международным союзом электросвязи` (`ITU`) и `Международной организацией по стандартизации` (`ISO`). Поэтому модель `OSI` часто называют `ISO/OSI` моделью.

---

## Модель TCP/IP

`TCP/IP` (`Transmission Control Protocol`/`Internet Protocol`) — это общий термин для множества сетевых протоколов. Эти протоколы отвечают за коммутацию и транспортировку пакетов данных в интернете. Интернет полностью основан на семействе протоколов `TCP/IP`. Однако, `TCP/IP` относится не только к этим двум протоколам, но обычно используется как общий термин для целого семейства протоколов.

Например, `ICMP` (`Internet Control Message Protocol`) или `UDP` (`User Datagram Protocol`) относятся к семейству протоколов. Семейство протоколов предоставляет необходимые функции для транспортировки и коммутации пакетов данных в частной или публичной сети.

---

## ISO/OSI vs. TCP/IP

`TCP/IP` — это коммуникационный протокол, который позволяет хостам подключаться к интернету. Он относится к `Transmission Control Protocol`, используемому в приложениях в интернете. В отличие от `OSI`, он допускает ослабление правил, которым необходимо следовать, при условии соблюдения общих принципов.

`OSI`, с другой стороны, является коммуникационным шлюзом между сетью и конечными пользователями. Модель OSI обычно называют эталонной моделью, поскольку она более новая и широко используемая. Она также известна своим строгим протоколом и ограничениями.

---

## Передача пакетов

В многоуровневой системе устройства на каждом уровне обмениваются данными в различных форматах, называемых `protocol data unit` (`PDU` - блок данных протокола). Например, когда мы хотим просмотреть веб-сайт на компьютере, удаленное серверное программное обеспечение сначала передает запрашиваемые данные на прикладной уровень. Они обрабатываются уровень за уровнем, каждый уровень выполняет свои назначенные функции. Затем данные передаются через физический уровень сети, пока сервер назначения или другое устройство не получит их. Данные снова проходят через уровни, и каждый уровень выполняет свои операции, пока принимающее программное обеспечение не использует данные.

![Сравнение моделей OSI и TCP/IP с PDU: OSI имеет 7 уровней, включая Прикладной, Представления, Сеансовый, Транспортный, Сетевой, Канальный и Физический. TCP/IP имеет 4 уровня: Прикладной, Транспортный, Интернет и Канальный. PDU: Данные, Сегмент/Датаграмма, Пакет, Кадр и Бит.](https://academy.hackthebox.com/storage/modules/34/redesigned/net_models_pdu2.png)

Во время передачи каждый уровень добавляет `заголовок` к `PDU` верхнего уровня, который контролирует и идентифицирует пакет. Этот процесс называется `инкапсуляцией`. Заголовок и данные вместе образуют PDU для следующего уровня. Процесс продолжается до `Физического уровня` или `Сетевого уровня`, где данные передаются получателю. Получатель выполняет обратный процесс и распаковывает данные на каждом уровне с информацией заголовка. После этого приложение наконец использует данные. Этот процесс продолжается до тех пор, пока все данные не будут отправлены и получены.

![Диаграмма передачи пакетов, показывающая инкапсуляцию данных от отправителя к получателю через уровни: Данные, TCP, IP, MAC и Двоичная передача, с соответствующими заголовками и последовательностью.](https://academy.hackthebox.com/storage/modules/34/packet_transfer.png)

Для нас, как пентестеров, обе эталонные модели полезны. С помощью `TCP/IP` мы можем быстро понять, как устанавливается все соединение, а с помощью `ISO` мы можем разобрать его по частям и детально проанализировать. Это часто происходит, когда мы можем прослушивать и перехватывать определенный сетевой трафик. Затем мы должны соответствующим образом анализировать этот трафик, углубляясь в детали в модуле `Network Traffic Analysis`. Поэтому мы должны ознакомиться с обеими эталонными моделями и понять и усвоить их наилучшим возможным образом.

