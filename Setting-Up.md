
# 1.1 Введение

---

Перед началом любого пентест-задания крайне важно настроить надежную и эффективную рабочую среду. Это включает организацию инструментов, настройку систем и обеспечение готовности всех необходимых ресурсов к использованию. Создавая хорошо структурированную тестовую инфраструктуру с самого начала, мы можем сократить время простоя, минимизировать ошибки и оптимизировать процесс оценки. В этом модуле мы рассмотрим фундаментальные технологии и конфигурации, которые поддерживают эту цель, фокусируясь на виртуализации и настройке правильной среды для нашей тестовой деятельности.

Предположим, что наша компания получила заказ от нового клиента (Inlanefreight) на проведение внешнего и внутреннего пентеста. Как уже упоминалось, перед проведением любого пентеста требуется правильная подготовка операционной системы. Наш клиент предоставляет нам внутренние системы, которые мы должны подготовить перед началом работы, чтобы тестирование на проникновение началось без задержек. Для этого нам необходимо соответствующим образом и эффективно подготовить необходимые операционные системы.

---

## Этапы и ситуации пентеста

Каждый пентест отличается по объему, ожидаемым результатам и среде в зависимости от сервисной линии и инфраструктуры клиента. Помимо различных этапов пентеста, через которые мы обычно проходим, наша деятельность может варьироваться в зависимости от типа пентеста, что может либо расширить, либо ограничить нашу рабочую среду и возможности.

Например, если мы проводим внутренний пентест, в большинстве случаев нам предоставляется внутренний хост, с которого мы можем работать. Предположим, этот хост имеет доступ в интернет (что обычно бывает). В таком случае нам нужен соответствующий виртуальный частный сервер (VPS) с нашими инструментами для быстрого доступа и загрузки соответствующих ресурсов для пентеста.

Тестирование может проводиться удаленно или на месте, в зависимости от предпочтений клиента. Если удаленно, мы обычно отправляем им устройство с предустановленным дистрибутивом пентеста по нашему выбору или предоставляем им настроенную виртуальную машину, которая будет связываться с нашей инфраструктурой через OpenVPN. Клиент выберет либо размещение образа (в который мы должны войти и немного настроить в первый день) и предоставит нам SSH-доступ (через белый список IP-адресов), либо предоставит нам прямой VPN-доступ в их сеть. Некоторые клиенты предпочитают не размещать никаких образов и предоставляют VPN-доступ, и в этом случае мы свободны тестировать с наших собственных локальных виртуальных машин Linux и Windows.

При выезде к клиенту на месте важно иметь как настроенную и полностью обновленную виртуальную машину Linux, так и Windows. Определенные инструменты работают лучше (или только) на Linux, а наличие виртуальной машины Windows делает определенные задачи (например, перечисление Active Directory) намного проще и эффективнее. Независимо от выбранной установки, мы должны направлять наших клиентов по плюсам и минусам и помогать им выбрать лучшее возможное решение, основанное на их сети и требованиях.

Это еще одна область пентеста, в которой мы должны быть универсальными и адаптивными как предметные эксперты. Мы должны убедиться, что мы полностью готовы с первого дня с правильными инструментами, чтобы предоставить клиенту наилучшую возможную ценность и углубленную оценку. Каждая среда отличается, и мы никогда не знаем, с чем столкнемся, когда начнем перечислять сеть и выявлять проблемы. Нам придется компилировать/устанавливать инструменты или загружать определенные скрипты на нашу атакующую виртуальную машину практически при каждой оценке, которую мы проводим. Настройка наших инструментов наилучшим образом гарантирует, что мы не потратим время впустую в начальные дни оценки. В идеале, нам следует вносить изменения в наши виртуальные машины оценки только для конкретных сценариев, с которыми мы сталкиваемся в ходе оценки.

---

## Настройка и эффективность

Со временем мы все собираем различный опыт и коллекции инструментов, с которыми мы наиболее знакомы. Структурированность имеет первостепенное значение, поскольку она повышает нашу эффективность в пентесте.
Необходимость поиска отдельных ресурсов и их зависимостей до начала работы может быть полностью устранена, если иметь доступ к заранее подготовленной, организованной и структурированной среде. Это требует подготовки и знания различных операционных систем, которые будут развиваться со временем.

Эффективность — это то, чего хотят и ожидают многие люди. Однако многие сегодня полагаются на огромное количество инструментов, до такой степени, что система становится медленной и больше не работает должным образом. Это неудивительно, учитывая большое количество приложений и решений, предлагаемых сегодня. Особенно новички ошеломлены, когда каждый источник информации имеет 50 разных мнений. Все они актуальны и зависят от конкретного случая, что не является плохим.

Но начинающие или даже опытные люди часто ищут другие решения, когда их рабочий спектр или обязанности в рабочей среде меняются. Затем возникает еще один сложный аспект: миграция со старого на новое.

Это часто требует значительных усилий и времени и все же не гарантирует, что эти инвестиции отразят ценность. Поэтому с этим модулем мы хотим создать основную настройку, в которой мы создаем рабочую среду для себя, которую мы знаем изнутри, можем настраивать сами и адаптировать независимо.


# 1.2 Организация

---

Как мы уже видели в модуле `Learning Process`, организация играет важную роль в наших тестах на проникновение. Неважно, какой это тест на проникновение. Наличие рабочей среды, в которой мы можем ориентироваться практически вслепую, экономит огромное количество времени на поиск ресурсов, с которыми мы уже знакомы и на изучение которых мы потратили время. Эти ресурсы можно найти за несколько минут, но если у нас есть обширный список ресурсов, необходимых для каждой оценки, включая установку, это занимает несколько часов подготовки.

Корпоративные среды обычно состоят из разнородных сетей (хостов/серверов с разными операционными системами). Поэтому имеет смысл организовать хосты и серверы в соответствии с их операционными системами. Если мы организуем нашу структуру в соответствии со стадиями тестирования на проникновение и операционными системами целей, то пример структуры папок может выглядеть следующим образом.

#### Организация

```shell
Cry0l1t3@htb[/htb]$ tree ..

└── Penetration-Testing
	│
	├── Pre-Engagement
	│       └── ...
    ├── Linux
    │   ├── Information-Gathering
    │   │   └── ...
    │   ├── Vulnerability-Assessment
    │   │   └── ...
    │   ├── Exploitation
    │   │   └── ...
    │   ├── Post-Exploitation
    │   │   └── ...
    │   └── Lateral-Movement
    │       └── ...
    ├── Windows
    │   ├── Information-Gathering
    │   │   └── ...
    │   ├── Vulnerability-Assessment
    │   │   └── ...
    │   ├── Exploitation
    │   │   └── ...
    │   ├── Post-Exploitation
    │   │   └── ...
    │   └── Lateral-Movement
    │       └── ...
    ├── Reporting
    │   └── ...
	└── Results
	    └── ...
```

Если мы специализируемся в определённых областях тестирования на проникновение, мы, конечно, можем реорганизовать структуру в соответствии с этими областями. Мы все вольны разрабатывать систему, с которой знакомы, и на самом деле это рекомендуется делать. Все работают по-разному, у всех есть свои сильные и слабые стороны. Если мы работаем в команде, мы должны разработать структуру, с которой знаком каждый член команды. Возьмите этот пример за основу при создании своей системы.

```shell
Cry0l1t3@htb[/htb]$ tree ..

└── Penetration-Testing
	│
	├── Pre-Engagement
	│       └── ...
    ├── Network-Pentesting
	│       ├── Linux
	│       │   ├── Information-Gathering
	│       │   │   └── ...
	│       │   ├── Vulnerability-Assessment
    │       │   │	└── ...
    │       │	└── ...
    │       │    	└── ...
    │		├── Windows
    │ 		│   ├── Information-Gathering
    │		│   │   └── ...
    │		│   └── ...
    │       └── ...
    ├── WebApp-Pentesting
	│       └── ...
    ├── Social-Engineering
	│       └── ...
    ├── .......
	│       └── ...
    ├── Reporting
    │   └── ...
	└── Results
	    └── ...
```

Правильная организация помогает нам как отслеживать всё происходящее, так и находить ошибки в наших процессах. Во время нашего обучения здесь мы столкнемся со многими различными областями, которые мы можем использовать для расширения и улучшения нашего понимания в области кибербезопасности. Мы можем не только сохранять шпаргалки или скрипты, предоставленные в модулях Академии, но также вести заметки относительно всех этапов тестирования на проникновение, с которыми мы столкнемся в HTB Academy, чтобы гарантировать, что никакие критические шаги не будут пропущены в будущих проектах. Мы рекомендуем начинать с небольших структур, особенно при входе в область тестирования на проникновение. Организация на основе операционной системы, таким образом, более подходит для новичков.

При организации работы для себя или для целой команды, мы должны убедиться, что все работают в соответствии с определенной процедурой. Каждый должен знать свое место и место каждого члена команды на протяжении всего процесса тестирования на проникновение. Также должно быть общее понимание относительно деятельности каждого члена. В противном случае, материалы могут оказаться в неправильном подкаталоге, или доказательства, необходимые для отчетности, могут быть потеряны или повреждены.

---

## Закладки

Существует множество браузерных дополнений, которые могут значительно улучшить наши действия по тестированию на проникновение и эффективность. Необходимость переустанавливать их снова и снова отнимает время и ненужно замедляет нас. К счастью, Firefox предлагает синхронизацию дополнений и закладок после создания и использования учетной записи Firefox. Все дополнения, установленные с использованием этой учетной записи, автоматически устанавливаются и синхронизируются при повторном входе в систему. То же самое относится и к сохраненным закладкам. Таким образом, входа в учетную запись Firefox будет достаточно для переноса всего из готовой среды в новую.

Мы должны быть осторожны, чтобы не хранить ресурсы, содержащие потенциально конфиденциальную информацию или частные ресурсы. Мы всегда должны помнить, что третьи стороны могут просматривать эти сохраненные ресурсы. Поэтому закладки, относящиеся к клиентам, никогда не должны сохраняться. Список закладок всегда должен создаваться с единственным принципом:

* **`Этот список рано или поздно увидят третьи лица.`**

По этой причине нам следует создать учетную запись только для целей тестирования на проникновение. Если наш список закладок необходимо редактировать и расширять, то самый безопасный путь — хранить список локально и импортировать его в учетную запись для тестирования на проникновение. После того, как мы это сделали, мы должны изменить нашу личную учетную запись (не для тестирования на проникновение).

---

## Менеджер паролей

Еще одним важным компонентом для нас являются менеджеры паролей. Менеджеры паролей могут оказаться полезными не только для личных целей, но и для тестов на проникновение. Одной из наиболее распространенных уязвимостей или методов атаки в сети является "повторное использование пароля". Мы часто пытаемся использовать найденные или расшифрованные пароли и имена пользователей для входа в несколько систем и сервисов в корпоративной сети посредством этой атаки. До сих пор довольно часто встречаются учетные данные, которые можно использовать для доступа к нескольким службам или серверам, что облегчает нашу работу и предоставляет больше возможностей для атаки. Существуют три основные проблемы с паролями:

1. `Сложность`
2. `Повторное использование`
3. `Запоминание`

#### 1. Сложность

Первая проблема с паролями — это сложность и их запоминание. Для обычных пользователей уже является проблемой создание сложного пароля, так как они часто связаны с контентом, который пользователи знают и могут запомнить. NordPass создал список наиболее часто используемых паролей, которые мы можем посмотреть [здесь](https://nordpass.com/most-common-passwords-list/). Мы можем видеть, что эти пароли могут быть угаданы в течение нескольких секунд без каких-либо специальных приготовлений, таких как мутация паролей.

#### 2. Повторное использование

После того, как пользователь создал и запомнил сложный пароль, остаются только две проблемы. Запоминание сложного и трудно угадываемого пароля все еще находится в пределах возможностей обычного пользователя. Вторая проблема заключается в том, что этот пароль затем используется для всех сервисов, что позволяет нам работать с несколькими компонентами инфраструктуры компании. Чтобы предотвратить это, пользователю пришлось бы создавать и запоминать сложные пароли `для всех` используемых сервисов.

#### 3. Запоминание

Это приводит нас к третьей проблеме с паролями. Если обычный пользователь использует несколько десятков сервисов, человеческая природа заставляет их лениться. Очень немногие приложат усилия, чтобы действительно `запомнить` все пароли. Если пользователь создает несколько паролей, риск забыть их или перепутать с другими компонентами пароля высок, если не используется безопасное решение для хранения паролей.

`Менеджеры паролей` решают все вышеперечисленные проблемы не только для обычных пользователей, но и для тестировщиков на проникновение. Мы работаем с десятками, если не сотнями, различных сервисов и серверов, для которых нам нужен новый, надежный и сложный пароль каждый раз. Некоторые провайдеры включают следующие, но не ограничиваются ими:

| [**1Password**](https://1password.com/) | [**LastPass**](https://www.lastpass.com/) | [**Keeper**](https://www.keepersecurity.com/) | [**Bitwarden**](https://bitwarden.com/) | [Proton Pass](https://proton.me/pass) |
|---|---|---|---|---|

Еще одно преимущество в том, что нам нужно запомнить только один пароль для доступа ко всем нашим остальным паролям. Одним из наиболее рекомендуемых является `Proton Pass`, который предлагает бесплатный план и план Plus с интегрированной 2FA, безопасным хранилищем, мониторингом даркнета.

---

## Обновления и автоматизация

Мы должны постоянно обновлять компоненты, которые мы организовали перед началом нового теста на проникновение. Это относится к используемой нами операционной системе и всем коллекциям Github, которые мы будем собирать и использовать со временем. Настоятельно рекомендуется записывать все ресурсы и их источники в файл, чтобы легче автоматизировать их позже. Любые скрипты автоматизации также можно сохранить в Proton, Github или на собственном сервере с самостоятельно размещенными приложениями для прямой загрузки при необходимости.

Когда мы создаем автоматизированные скрипты, они зависят от операционной системы. Например, мы можем работать с Bash, Python и PowerShell. Создание скриптов автоматизации — хорошее упражнение для изучения и практики скриптинга, а также может помочь нам подготовиться и даже более эффективно переустановить систему. Мы найдем больше инструментов, практических объяснений и шпаргалок при изучении новых методов и технологий. Рекомендуется хранить их в записи и поддерживать записи в актуальном состоянии.

---

## Ведение заметок

Ведение заметок — еще одна важная часть нашего тестирования на проникновение, поскольку мы накапливаем много различной информации, результатов и идей, которые трудно запомнить все сразу. Существует пять различных основных типов информации, которую необходимо записать:

1. Вновь обнаруженная информация
2. Идеи для дальнейших тестов и обработки
3. Результаты сканирования
4. Ведение журнала
5. Скриншоты

#### 1. Обнаруженная информация

Под "обнаруженной информацией" мы понимаем общую информацию, такую как новые IP-адреса, имена пользователей, пароли, исходный код, которую мы идентифицировали и которая связана с процессом тестирования на проникновение. Это информация, которую мы можем использовать против нашей целевой компании. Мы часто получаем такую информацию через OSINT, активное сканирование и ручной анализ данных информационных ресурсов и сервисов.

#### 2. Обработка

В ходе тестирования на проникновение мы приобретем огромное количество информации различных типов. Это требует от нас способности адаптировать наш подход. Полученная информация может дать нам идеи для последующих шагов, в то время как другие уязвимости или неправильные конфигурации могут быть забыты или упущены из виду. Поэтому мы должны привыкнуть записывать все, что, по нашему мнению, должно быть исследовано в рамках оценки. Notion.so, Anytype, Obsidian и Xmind очень подходят для этого.

[Notion.so](https://notion.so/) — это элегантный онлайн-редактор Markdown, который предлагает множество различных функций и дает нам возможность формировать наши идеи и мысли в соответствии с нашими предпочтениями.

![](https://academy.hackthebox.com/storage/modules/87/notion.png)

[Xmind](https://www.xmind.net/) — отличный редактор интеллект-карт, который может очень хорошо визуализировать соответствующие информационные компоненты и процессы.

![](https://academy.hackthebox.com/storage/modules/87/xmind.png)

[Obsidian](https://obsidian.md/) — мощная база знаний, которая работает поверх локальной папки с текстовыми файлами Markdown.

![](https://academy.hackthebox.com/storage/modules/87/obsidian.png)

#### 3. Результаты

Результаты, которые мы получаем после наших сканирований и шагов тестирования на проникновение, имеют большое значение. При таком большом количестве информации за короткое время можно быстро почувствовать себя перегруженным. Поначалу нелегко отфильтровать наиболее важные части информации. Это придет с опытом и практикой. Только через практику наши глаза могут быть обучены распознавать существенные небольшие фрагменты информации. Тем не менее, мы должны хранить всю информацию и результаты, чтобы не пропустить что-то значимое, и потому что часть информации может оказаться полезной позже в процессе работы. Кроме того, эти результаты также часто используются для документации. Для этого мы можем использовать [GhostWriter](https://github.com/GhostManager/Ghostwriter) или [Pwndoc](https://github.com/pwndoc/pwndoc). Они позволяют нам создавать нашу документацию и иметь четкий обзор шагов, которые мы предприняли.


# 1.3 Виртуализация

---

`Виртуализация` — это абстракция физических вычислительных ресурсов. Могут быть абстрагированы как аппаратные, так и программные компоненты. Компьютерный компонент, созданный в рамках виртуализации, называется виртуальным или логическим компонентом и может использоваться точно так же, как его физический аналог. Основным преимуществом виртуализации является абстрактный слой между физическим ресурсом и виртуальным образом. Это основа различных облачных сервисов, которые становятся все более важными в повседневном бизнесе. Обратите внимание, что виртуализацию следует отличать от понятий симуляции и эмуляции.

Предоставляя возможность представления и доступа к физическим вычислительным ресурсам — аппаратному обеспечению, программному обеспечению, хранилищу и сетевым компонентам — в виртуальной форме, виртуализация позволяет распределять эти ресурсы между различными пользователями гибким и ориентированным на спрос способом. Этот подход направлен на улучшение общего использования вычислительных ресурсов. Одна из его ключевых целей — обеспечить выполнение приложений на системах, которые обычно их не поддерживают. В контексте виртуализации мы обычно различаем:

* Виртуализацию аппаратного обеспечения
* Виртуализацию приложений
* Виртуализацию хранилищ
* Виртуализацию данных
* Виртуализацию сети

Виртуализация аппаратного обеспечения относится к технологиям, которые позволяют получать доступ к аппаратным компонентам независимо от их физической формы с помощью программного обеспечения [гипервизора](https://ru.wikipedia.org/wiki/Гипервизор). Наиболее известным примером этого является `виртуальная машина (VM)`. VM — это виртуальный компьютер, который ведет себя как физический компьютер, от аппаратного обеспечения до операционной системы. Виртуальные машины работают как виртуальные гостевые системы на одной или нескольких физических системах, называемых `хостами`. VirtualBox также может быть улучшен с помощью` VirtualBox Guest Additions`, которые представляют собой набор драйверов и системных приложений, разработанных для улучшения производительности и удобства использования гостевых операционных систем с VirtualBox.

![](https://academy.hackthebox.com/storage/modules/87/techhoundscom.jpg)

---

## Виртуальные машины

`Виртуальная машина (VM)` — это виртуальная операционная система, которая работает на хост-системе (реальной физической компьютерной системе). Несколько изолированных друг от друга виртуальных машин могут работать параллельно. Физические аппаратные ресурсы хост-системы распределяются через `гипервизоры`. Это изолированная виртуализированная среда, в которой несколько гостевых систем могут работать параллельно, независимо от операционной системы, на одном физическом компьютере. Виртуальные машины работают независимо друг от друга и не влияют друг на друга. Гипервизор управляет аппаратными ресурсами, и с точки зрения виртуальной машины, выделенные вычислительные мощности, оперативная память, емкость жесткого диска и сетевые соединения доступны исключительно ей.

С точки зрения приложения, операционная система, установленная в виртуальной машине, ведет себя так, как если бы она была установлена непосредственно на аппаратном обеспечении. Приложениям и операционной системе не очевидно, что они работают в виртуальной среде. Виртуализация обычно связана с потерей производительности для виртуальной машины, поскольку промежуточный слой виртуализации сам требует ресурсов. Виртуальные машины предлагают множество преимуществ по сравнению с запуском операционной системы или приложения непосредственно на физической системе. Наиболее важные преимущества:

1. Приложения и службы виртуальной машины не мешают друг другу

2. Полная независимость гостевой системы от операционной системы хост-системы и базового физического оборудования

3. Виртуальные машины можно перемещать или клонировать на другие системы простым копированием

4. Аппаратные ресурсы можно динамически распределять через гипервизор

5. Лучшее и более эффективное использование существующих аппаратных ресурсов

6. Сокращение времени подготовки систем и приложений

7. Упрощенное управление виртуальными системами

8. Более высокая доступность виртуальных машин из-за независимости от физических ресурсов

---

## Введение в VirtualBox

Отличной и бесплатной альтернативой VMware Workstation Pro является [VirtualBox](https://www.virtualbox.org/). В VirtualBox жесткие диски эмулируются в файлах-контейнерах, называемых Virtual Disk Images (`VDI`). Помимо формата VDI, VirtualBox также может работать с файлами жестких дисков от продуктов виртуализации VMware (`.vmdk`), форматом `Virtual Hard Disk` (`.vhd`) и другими. Мы также можем конвертировать эти внешние форматы с помощью инструмента командной строки VBoxManage, который входит в состав VirtualBox. Мы можем установить VirtualBox из командной строки или загрузить установочный файл с [официального сайта](https://www.virtualbox.org/wiki/Downloads) и установить его вручную.

![](https://academy.hackthebox.com/storage/modules/87/virt1.png)

VirtualBox очень распространен в частном использовании. Установка проста и обычно не требует дополнительной настройки для запуска. Мы можем загрузить VirtualBox с их домашней страницы: https://www.virtualbox.org/

#### Загрузка VirtualBox

![](https://academy.hackthebox.com/storage/modules/87/virt2.png)

Также в Ubuntu Linux мы можем использовать следующие команды для одновременной установки VirtualBox и пакета расширений:

#### Установка VirtualBox

```
cry0l1t3@htb[/htb]$ sudo apt install virtualbox virtualbox-ext-pack -y
```

![](https://academy.hackthebox.com/storage/modules/87/virt3.png)

Пакет расширений VirtualBox улучшает общую функциональность VirtualBox следующими возможностями:

* Поддержка USB 2.0/3.0
* VirtualBox RDP
* Шифрование дисков
* PXE Boot
* Поддержка NVMe

---

## Proxmox

Proxmox — это платформа виртуализации и управления сервером с открытым исходным кодом корпоративного уровня, которая использует Kernel-based Virtual Machine (KVM) для полной виртуализации и Linux Containers (LXC) для контейнерной виртуализации. Это программное обеспечение используется в бизнесе и крупных центрах обработки данных.

![](https://academy.hackthebox.com/storage/modules/87/virt4.png)

Proxmox предоставляет три основных решения, которые можно загрузить [здесь](https://proxmox.com/en/downloads):

* Proxmox Virtual Environment
* Proxmox Backup Server
* Proxmox Mail Gateway

#### Загрузка ISO-образа Proxmox VE

![](https://academy.hackthebox.com/storage/modules/87/virt5.png)

Это программное обеспечение позволяет нам создавать и моделировать целые сети, включая сложные настройки с использованием любого типа виртуальных машин или контейнеров, какие только можно придумать. Мы можем загрузить ISO-файл Proxmox VE и установить его на VirtualBox для экспериментов без необходимости в дополнительных аппаратных ресурсах.

После завершения загрузки мы можем создать новую виртуальную машину и назначить ей ISO-образ. Обязательно выделите не менее 4 ГБ оперативной памяти и 2 процессора для виртуальной машины Proxmox.

### Установка Proxmox VE

![](https://academy.hackthebox.com/storage/modules/87/virt6.png)

После того, как всё настроено, мы должны дважды проверить все параметры. Если всё выглядит хорошо, теперь мы можем запустить виртуальную машину.

![](https://academy.hackthebox.com/storage/modules/87/virt7.png)

При загрузке виртуальной машины нас встречает экран Proxmox Virtual Environment. Теперь мы можем выбрать опцию установки Proxmox VE с использованием графического интерфейса.

![](https://academy.hackthebox.com/storage/modules/87/virt8.png)

Внимательно следите за всем процессом установки и обязательно прочитайте всё во время установки. После завершения установки вы увидите экран входа в систему вместе с URL-адресом веб-страницы управления.

![](https://academy.hackthebox.com/storage/modules/87/virt9.png)

Те же учетные данные, которые вы использовали во время установки, будут использоваться для входа в веб-панель управления. Ваши учетные данные будут `root:<ваш пароль>`.

![](https://academy.hackthebox.com/storage/modules/87/virt10.png)

На этом этапе вы должны увидеть все опции конфигурации для вашего виртуализированного "Центра данных". Здесь вы можете загружать виртуальные машины, контейнеры, создавать сети и многое другое. Эти виртуальные машины и контейнеры будут находиться внутри виртуализированной среды Proxmox и не нужно добавлять их отдельно в VirtualBox.

![](https://academy.hackthebox.com/storage/modules/87/virt11.png)



# Linux

---

Linux является наиболее широко используемой операционной системой для пентестинга. Поэтому мы должны хорошо владеть ею (или, по крайней мере, быть с ней знакомы). При настройке операционной системы для этой цели лучше всего установить стандартную конфигурацию, которая последовательно создаёт среду, удобную для работы.

Предположим, нас попросили провести пентест для проверки как внутренней, так и внешней безопасности сети. Если у нас ещё нет подготовленной специализированной системы, сейчас самое время её создать. В противном случае мы рискуем потратить ценное время во время задания на настройку и конфигурацию, тогда как это время можно было бы использовать для тестирования различных компонентов сети. Однако прежде чем подготовить систему, нам нужно ознакомиться с доступными дистрибутивами для пентестинга.

---

## Дистрибутивы для пентестинга

Существует множество различных дистрибутивов, которые мы можем использовать, и у всех них есть свои преимущества и недостатки. Многие люди спрашивают себя, какая система лучше. Тем не менее, то, что многие не понимают, — это то, что это личное решение. Это означает, что лучший дистрибутив для нас зависит в первую очередь от наших собственных потребностей и желаний. Инструменты, доступные в этих операционных системах, можно установить практически в любом дистрибутиве, поэтому мы должны спросить себя, чего ожидаем от этого дистрибутива Linux. Лучшие дистрибутивы для пентестинга характеризуются большим/активным сообществом и подробной документацией. Среди наиболее популярных, но не ограничиваясь ими:

| [ParrotOS](https://www.parrotsec.org/) (`Pwnbox`) | [Kali Linux](https://www.kali.org/) | [BlackArch](https://blackarch.org/) | [BackBox](https://linux.backbox.org/) |
|---------------------------------------------------|-------------------------------------|------------------------------------|--------------------------------------|

В этом сценарии мы будем работать с [ParrotOS Security](https://www.parrotsec.org/download/) в качестве нашего дистрибутива для пентестинга. Давайте выберем категорию `Live`, чтобы получить полную версию операционной системы.

![](https://academy.hackthebox.com/storage/modules/87/lin1.png)

Далее, мы видим три различных редакции ParrotOS:

- Security - для пентестов
- Home - для общего использования
- HTB - ваш персонализированный Pwnbox

В данном случае мы выберем HTB редакцию. Смело следуйте инструкциям.

![](https://academy.hackthebox.com/storage/modules/87/lin2.png)

После этого вы увидите кнопку загрузки и учетные данные по умолчанию, если вы хотите использовать систему без установки.

![](https://academy.hackthebox.com/storage/modules/87/lin3.png)

---

## Настройка VM

Перед установкой нашей операционной системы ParrotOS Security, нам нужно `создать VM` (в VirtualBox в этом примере). Здесь мы также указываем, какой установочный файл будет использоваться для операционной системы (файл `.iso`).

#### ParrotOS ISO

![](https://academy.hackthebox.com/storage/modules/87/lin4.png)

Поскольку VirtualBox не распознает каждую операционную систему по умолчанию, он может неправильно определить ParrotOS. Поэтому нам нужно вручную указать, на каком дистрибутиве она основана — в данном случае, `Debian`.

Также нам нужно назначить `имя` для VM с нужной нам меткой, а затем установить `путь`, где она будет храниться.

После этого мы можем установить `максимальный размер` VM. Рекомендуется выделить более 20 ГБ, так как VM будет расти по мере установки пакетов и приложений во время настройки и использования.

#### Размер ОС

![](https://academy.hackthebox.com/storage/modules/87/lin5.png)

---

## Установка ParrotOS

После создания VM мы можем запустить её и перейти в меню GRUB для выбора опций. Поскольку мы хотим `установить ParrotOS`, мы должны выбрать этот вариант. Как только мы нажмем на окно VM, наша мышь будет захвачена, что означает, что мышь не сможет покинуть окно. Чтобы снова свободно перемещать мышь, мы должны нажать `[Right CTRL]` (комбинация горячих клавиш по умолчанию в большинстве случаев). Однако мы должны проверить эту комбинацию клавиш в окне VirtualBox в разделе `Preferences > Virtual Machine > Hot Key Combo`.

Примечание: Мы можем настроить все шаги в соответствии с нашими потребностями. Однако для достижения одинакового результата следует придерживаться предлагаемого выбора.

![](https://academy.hackthebox.com/storage/modules/87/lin6.png)

Когда вы нажмёте на `Try / Install`, вы войдёте в режим live-системы ParrotOS. Этот режим позволяет вам исследовать и тестировать систему без установки. При нажатии на `Install Debian` начинается процесс установки. Затем нам будет предложено выбрать язык, местоположение, раскладку клавиатуры и метод разбиения диска.

![](https://academy.hackthebox.com/storage/modules/87/lin7.png)

Поскольку мы хотим зашифровать наши данные и информацию на VM с помощью [Logical Volume Manager](https://en.wikipedia.org/wiki/Logical_volume_management) (`LVM`), мы должны выбрать опцию "`Encrypt system`". Также рекомендуется создать `Swap (no Hibernate)` для нашей системы.

`LVM` — это схема разбиения. В основном используется в среде Unix и Linux, обеспечивает уровень абстракции между дисками, разделами и файловыми системами. С помощью LVM можно формировать динамически изменяемые разделы, которые распространяются на несколько дисков. После выбора LVM нам будет предложено ввести имя пользователя, имя хоста и пароль.

![](https://academy.hackthebox.com/storage/modules/87/lin8.png)

После того, как мы сделали все необходимые записи, мы можем подтвердить их и начать настройку `LVM`.

---

## Шифрование LUKS

`LVM` действует как дополнительный слой между физическим хранилищем и логическим хранилищем операционной системы. LVM поддерживает организацию логических томов в массивы RAID для защиты от сбоя жесткого диска. Однако, в отличие от RAID, концепция LVM не обеспечивает избыточность. Хотя в основном используется в Linux и Unix, аналогичные функции существуют в Windows ([Storage Spaces](https://docs.microsoft.com/en-us/windows-server/storage/storage-spaces/overview)) и macOS ([CoreStorage](https://en.wikipedia.org/wiki/Core_Storage)).

Когда мы дойдем до этапа разбиения диска, нам будет предложено ввести `парольную фразу для шифрования`. Мы должны помнить, что эта парольная фраза должна быть `очень надежной` и должна храниться в безопасном месте, в идеале с помощью менеджера паролей. Затем нам придется повторно ввести парольную фразу, чтобы убедиться, что не было допущено ошибок.

#### Парольная фраза LVM

![](https://academy.hackthebox.com/storage/modules/87/lin9.png)

После установки парольной фразы мы получим обзор всех созданных и настроенных разделов. Нам также будут доступны другие опции, как показано выше. Если никаких дополнительных настроек не требуется, мы можем завершить разбиение и применить изменения.

Теперь начнется установка операционной системы, и по ее завершении виртуальная машина автоматически перезагрузится. При перезагрузке нам будет предложено ввести парольную фразу шифрования, которую мы создали ранее, чтобы разблокировать зашифрованную систему и продолжить загрузку.

#### Разблокировка раздела LVM

![](https://academy.hackthebox.com/storage/modules/87/lin10.png)

Если мы правильно ввели парольную фразу, то операционная система полностью загрузится, и мы сможем войти в систему. Здесь мы вводим пароль для созданного нами имени пользователя.

#### Первый вход

![](https://academy.hackthebox.com/storage/modules/87/lin11.png)

---

## Обновления и менеджер пакетов APT

Теперь, когда мы установили операционную систему, нам нужно обновить её. Для этого мы будем использовать инструмент управления пакетами `APT`. `Advanced packaging toolkit` (`APT`) — это система управления пакетами, возникшая в операционной системе Debian (которая использует `dpkg` для управления пакетами .deb под капотом). Менеджеры пакетов используются для поиска, обновления и установки программных пакетов и зависимостей. APT использует репозитории (источники пакетов), которые хранятся в каталоге `/etc/apt/sources.list` (в нашем случае для ParrotOS: `/etc/apt.sources.list.d/parrot.list`).

#### Список источников ParrotOS

```
┌─[cry0l1t3@parrot]─[~]
└──╼ $ cat /etc/apt/sources.list.d/parrot.list | grep -v "#"

deb https://deb.parrot.sh/parrot lory main contrib non-free non-free-firmware

deb https://deb.parrot.sh/direct/parrot lory-security main contrib non-free non-free-firmware

deb https://deb.parrot.sh/parrot lory-backports main contrib non-free non-free-firmware
```

Здесь менеджер пакетов может получить доступ к списку HTTP и FTP-серверов, которые он затем использует для получения пакетов для установки. Если выполняется поиск пакетов, они автоматически загружаются из списка доступных репозиториев. Поскольку версии программ можно быстро сравнивать и автоматически загружать из списка репозиториев, обновление существующих программных пакетов в APT относительно просто и удобно.

#### Обновление ParrotOS

```
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ sudo apt update -y && sudo apt full-upgrade -y && sudo apt autoremove -y && sudo apt autoclean -y
[sudo] password for cry0l1t3: **********************

Hit:1 https://deb.parrot.sh/parrot rolling InRelease
Hit:2 https://deb.parrot.sh/parrot rolling-security InRelease
Reading package lists... Done
Building dependency tree
Reading state information... Done
2310 packages can be upgraded. Run 'apt list --upgradable' to see them.
Reading package lists... Done
Building dependency tree
Reading state information... Done
Calculating upgrade... Done
The following packages were automatically installed and are no longer required:
  cryptsetup-nuke-password dwarfdump
  <SNIP>
```

Ниже представлен список распространенных инструментов для пентестинга:

#### Список инструментов

```
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ cat tools.list
netcat
ncat
nmap
wireshark
tcpdump
hashcat
ffuf
gobuster
hydra
zaproxy
proxychains
sqlmap
radare2
metasploit-framework
python2.7
python3
spiderfoot
theharvester
remmina
xfreerdp
rdesktop
crackmapexec
exiftool
curl
seclists
testssl.sh
git
vim
tmux
```

Большинство пакетов уже установлены в операционной системе. Если есть всего несколько пакетов, которые мы хотим установить, мы можем ввести их вручную с помощью следующей команды.

#### Установка дополнительных инструментов

```
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ sudo apt install netcat ncat nmap wireshark tcpdump ...SNIP... git vim tmux -y
[sudo] password for cry0l1t3:

Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  libarmadillo9 libboost-locale1.71.0 libcfitsio8 libdap25 libgdal27 libgfapi0
  <SNIP>
```

Однако, если вы работаете с более длинным списком инструментов, эффективнее создать файл со списком инструментов и использовать его для автоматизации установки. Это обеспечивает согласованность и экономит время при будущих настройках:

#### Установка дополнительных инструментов из списка

```
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ sudo apt install $(cat tools.list | tr "\n" " ") -y
[sudo] password for cry0l1t3:

Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  libarmadillo9 libboost-locale1.71.0 libcfitsio8 libdap25 libgdal27 libgfapi0
  <SNIP>
```

---

## Использование Github

Вероятно, мы столкнемся с инструментами, которые не найдены в стандартных репозиториях, и поэтому нам потребуется загрузить их вручную с Github. Например, предположим, что нам не хватает некоторых инструментов для повышения привилегий, и мы хотим загрузить [Privilege-Escalation-Awesome-Scripts-Suite](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite). Мы бы использовали команду:

#### Клонирование репозитория Github

```
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ git clone https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite.git

Cloning into 'privilege-escalation-awesome-scripts-suite'...
remote: Enumerating objects: 29, done.
remote: Counting objects: 100% (29/29), done.
remote: Compressing objects: 100% (17/17), done.
remote: Total 5242 (delta 18), reused 22 (delta 11), pack-reused 5213
Receiving objects: 100% (5242/5242), 18.65 MiB | 5.11 MiB/s, done.
Resolving deltas: 100% (3129/3129), done.
```

#### Просмотр содержимого

```
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ ls -l privilege-escalation-awesome-scripts-suite/
total 16

-rwxrwxr-x 1 cry0l1t3 cry0l1t3 1069 Mar 23 16:41 LICENSE
drwxrwxr-x 3 cry0l1t3 cry0l1t3 4096 Mar 23 16:41 linPEAS
-rwxrwxr-x 1 cry0l1t3 cry0l1t3 2506 Mar 23 16:41 README.md
drwxrwxr-x 4 cry0l1t3 cry0l1t3 4096 Mar 23 16:41 winPEAS
```

---

## Снапшот

После установки соответствующих пакетов и репозиториев настоятельно рекомендуется сделать `снапшот VM`. В следующих шагах мы будем вносить изменения в конкретные конфигурационные файлы. Если мы не будем осторожны, человеческая ошибка может сделать части системы (или даже всю систему) непригодными для использования. Мы определенно не хотим повторять все наши предыдущие шаги. Поэтому давайте создадим снапшот и назовем его "`Initial Setup`".

Тем не менее, `прежде чем` создать этот снапшот, мы должны сначала выключить виртуальную машину. Это не только ускоряет процесс создания снапшота, но и гарантирует, что снапшот будет сделан в чистом, выключенном состоянии, снижая вероятность повреждения системы или несоответствий.

Если при выполнении дальнейших настроек или тестировании будут допущены какие-либо ошибки, мы можем просто восстановить снапшот и продолжить с работоспособного состояния. Рекомендуется делать снапшот после каждого крупного изменения конфигурации и даже периодически во время пентеста, чтобы избежать потери ценного прогресса.

#### Создание снапшота

![](https://academy.hackthebox.com/storage/modules/87/lin12.png)

#### Завершенные задачи

![](https://academy.hackthebox.com/storage/modules/87/lin13.png)

---

## Шифрование диска VM

В дополнение к шифрованию LVM мы можем зашифровать всю VM с помощью другого надежного пароля. Это дает нам дополнительный уровень защиты, который защитит наши результаты и любые данные клиента, находящиеся в системе. Это означает, что никто не сможет запустить VM без пароля, который мы установили.

Теперь, когда мы выключили VM, мы переходим в раздел `Edit virtual machine settings` и выбираем вкладку `Options`.

#### Настройки шифрования диска VirtualBox

![](https://academy.hackthebox.com/storage/modules/87/lin14.png)

Там мы найдем больше дополнительных функций и настроек, которые мы можем использовать позже. Актуальными для нас сейчас являются настройки `Access Control`. После того, как мы зашифровали VM, мы не сможем создать клон без предварительной расшифровки. Более подробную информацию об этом можно найти в документации VirtualBox.


# Резервное копирование и восстановление

---

Механизмы резервного копирования и восстановления являются одними из наиболее важных защитных мер против потери данных, компрометации системы и прерывания бизнеса.

Когда мы моделируем кибератаки, мы рассматриваем резервные копии и системы восстановления через двойную призму: как защитные меры, которые могут смягчить ущерб, и как приоритетные цели, которые злоумышленники могут использовать. Чтобы понять важность этих систем, нам необходимо изучить, как они работают в условиях стресса, какую роль они играют при реагировании на инциденты, и в каких реальных случаях они улучшили или ухудшили безопасность организации. Лучший способ понять это — разработать собственные стратегии резервного копирования и (аварийного) восстановления.

Например, во время атаки программы-вымогателя на [Colonial Pipeline в 2021 году](https://www.cisa.gov/news-events/news/attack-colonial-pipeline-what-weve-learned-what-weve-done-over-past-two-years), злоумышленники зашифровали ключевые системы и потребовали миллионы долларов выкупа. Способность компании быстро восстановить работу зависела от надежных резервных копий, изолированных от атакованной сети.

Процессы восстановления не менее важны, поскольку они определяют, насколько быстро компания может вернуться к нормальной работе после вторжения. Как пентестеры, мы можем моделировать сценарии, когда системы блокируются или данные похищаются, и оценивать скорость и точность восстановления, если события вообще обнаруживаются (да, к сожалению, это все еще случается). Плохой процесс восстановления может усугубить ущерб, как это видно на примере [Equifax в 2017 году](https://archive.epic.org/privacy/data-breach/equifax/), когда плохое реагирование на инцидент усугубило утечку данных 147 миллионов человек.

Давайте рассмотрим несколько решений, которые мы можем использовать для правильного резервного копирования вашей системы и восстановления её при необходимости.

---

## Pika Backup

[Pika Backup](https://apps.gnome.org/PikaBackup/) — это удобное решение для резервного копирования с графическим интерфейсом, которое позволяет создавать резервные копии локально и удаленно. Большим преимуществом является то, что оно не копирует файлы, которые уже были скопированы. Оно копирует только новые файлы или файлы, которые были изменены с момента последнего резервного копирования. Кроме того, оно поддерживает шифрование, что добавляет дополнительный уровень безопасности, и его легко настроить.

```
# Обновление
cry0l1t3@hbt[/htb]$ sudo apt update -y 

# Установка Pika Backup
cry0l1t3@hbt[/htb]$ sudo apt install flatpak -y
cry0l1t3@hbt[/htb]$ flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
cry0l1t3@hbt[/htb]$ flatpak install flathub org.gnome.World.PikaBackup

# Запуск Pika Backup
cry0l1t3@hbt[/htb]$ flatpak run org.gnome.World.PikaBackup
```

После запуска Pika Backup мы можем настроить процесс резервного копирования в соответствии с нашими потребностями.

![Экран Pika Backup, показывающий 'Резервное копирование не настроено' с кнопкой 'Настроить резервное копирование'](https://academy.hackthebox.com/storage/modules/87/bak1.png)

Pika Backup использует репозитории BorgBackup, которые представляют собой директории, содержащие (зашифрованные и) дедуплицированные архивы. Дедуплицированный архив — это тип архива данных, где избыточные копии можно идентифицировать и удалять для экономии места и повышения эффективности. Каждый фрагмент данных в архиве разделяется на меньшие части, и на основе его содержимого ему присваивается уникальный хеш. Если хеш фрагмента совпадает с уже существующим, он отбрасывается. В производственных средах, где хост может быть доступен через интернет (например, веб-сервер), рекомендуется следовать правилу 3-2-1:

* 3 копии ваших данных
* 2 на разных устройствах
* 1 вне офиса

![Экран настройки Pika Backup с опциями создания или использования существующего репозитория, показывающий 'Расположение на диске' и 'Удаленное расположение' для обоих](https://academy.hackthebox.com/storage/modules/87/bak2.png)

Мы можем указать местоположение, где будет создан локальный репозиторий. В этом примере мы будем использовать подключенный HDD с директорией под названием `backup`.

![Экран выбора местоположения Pika Backup, показывающий 'Базовую папку репозитория', установленную на 'backup', и 'Имя репозитория' как 'backup-ubuntu-cry0l1t3' с кнопкой 'Продолжить'](https://academy.hackthebox.com/storage/modules/87/bak3.png)

После определения директории для репозитория мы можем настроить фразу шифрования, которую Pika Backup использует для шифрования всех наших архивов. Как и BorgBackup, Pika Backup использует шифрование AES-256-CTR, которое обеспечивает высокий уровень безопасности.

![Экран настройки шифрования Pika Backup с включенным 'Использовать шифрование', показывающий поля для нового пароля и повтора пароля, и кнопку 'Создать'](https://academy.hackthebox.com/storage/modules/87/bak4.png)

После настройки шифрования мы можем приступить к первому резервному копированию или более глубоко погрузиться в конфигурацию — изучая такие вещи, как расписание, включаемые и исключаемые файлы и директории. В этом примере мы собираемся создать резервную копию только домашней директории, как видно в разделе `Файлы для резервного копирования`, и исключить все `Кэши`.

![Экран Pika Backup, показывающий 'Резервное копирование никогда не запускалось' с опциями резервного копирования папки 'Домашняя' и исключения 'Кэшей', и кнопкой 'Создать резервную копию сейчас'](https://academy.hackthebox.com/storage/modules/87/bak5.png)

Для архивов мы можем указать индекс архива по нашему выбору. Мы также можем запустить `Проверку целостности данных` вручную, которая проверяет последние архивы резервных копий с текущим состоянием и вносит обновления, если какие-либо файлы были изменены с момента последнего резервного копирования.

![Экран архивов Pika Backup, показывающий директорию 'домашняя' с 20.4 ГБ доступно из 52.5 ГБ всего, опции для 'Префикса архива' и 'Очистки архивов', и 'Проверка целостности не выполнена'. Архивы недоступны.](https://academy.hackthebox.com/storage/modules/87/bak6.png)

На вкладке `Расписание` мы можем указать, как часто нужно создавать резервную копию. Рекомендуемое расписание — делать резервную копию ежедневно на период в 2 недели.

![Экран расписания Pika Backup, показывающий 'Ожидание начала резервного копирования', с опциями регулярного создания резервных копий ежедневно в 21:00 и регулярной очистки архивов. Присутствует кнопка 'Сохранить конфигурацию'](https://academy.hackthebox.com/storage/modules/87/bak7.png)

Когда всё настроено, мы можем запустить процесс резервного копирования и подождать, пока он завершится.

![Экран Pika Backup, показывающий 'Резервное копирование выполняется' на 4.0% для директории 'домашняя', с опциями прервать, и списками файлов для резервного копирования и исключения](https://academy.hackthebox.com/storage/modules/87/bak8.png)

---

## Duplicati

[Duplicati](https://duplicati.com/download) — это кросс-платформенное решение для резервного копирования, также с мощными возможностями. Оно также поддерживает AES-256 для шифрования, с опциональным асимметричным шифрованием с использованием GPG (RSA или аналогичный для обмена ключами). Данные шифруются на стороне клиента и поддерживается сильное выведение ключей на основе пароля. Большим преимуществом для многих людей является количество удаленных мест назначения, которые поддерживает Duplicati:

* Google Drive
* OneDrive
* Amazon S3
* SFTP
* Dropbox
* и другие.

Процесс установки также очень прост, но вместо использования GUI, Duplicati использует веб-сервер для управления. Давайте [скачаем](https://duplicati.com/download) установочный пакет и установим его.

```
cry0l1t3@hbt[/htb]$ cd ~/Downloads
cry0l1t3@hbt[/htb]$ sudo apt install ./duplicati-2.1.0.5_stable_2025-03-04-linux-x64-gui.deb
cry0l1t3@hbt[/htb]$ duplicati
```

После установки мы можем перейти на http://localhost:8200 и увидим веб-страницу, похожую на эту:

![Интерфейс Duplicati, показывающий 'Добавить новую резервную копию' с опциями настройки новой резервной копии или импорта из файла, и кнопкой 'Далее'](https://academy.hackthebox.com/storage/modules/87/bak9.png)

Во вкладке `Добавить резервную копию` мы можем начать указывать наши общие настройки резервного копирования, дать ему имя, установить шифрование и фразу-пароль для него.

![Экран настроек резервного копирования Duplicati с полями для 'Имени', 'Описания', 'Шифрования', 'Фразы-пароля' и 'Повтора фразы-пароля', и кнопкой 'Далее'](https://academy.hackthebox.com/storage/modules/87/bak10.png)

В этом примере мы настроим Duplicati для создания резервных копий и отправки их на удаленный сервер. Одним из наиболее рекомендуемых и безопасных методов является передача файлов через SSH/SFTP с использованием SSH-ключей. Поэтому нам нужно сгенерировать отдельный SSH-ключ с помощью команды `ssh-keygen`.

```
cry0l1t3@hbt[/htb]$ ssh-keygen -t ed25519

Generating public/private ed25519 key pair.

Enter file in which to save the key (/home/cry0l1t3/.ssh/id_ed25519): duplicati
Enter passphrase (empty for no passphrase): ******************
Enter same passphrase again: ******************

Your identification has been saved in duplicati
Your public key has been saved in duplicati.pub
The key fingerprint is:
SHA256:2mKNI0ZOfVMuwkFenV4NtUv0hwiHTir0gGYfR/Lhm8Q cry0l1t3@ubuntu
The key's randomart image is:
+--[ED25519 256]--+
|     .o.+..oo+o  |
|    +o+*..=o.o.+ |
|   o oo=E=... + o|
|     oooo=o  . ..|
|    o +.S .   .  |
|   +   B o       |
|    + * o        |
|   . o o         |
|                 |
+----[SHA256]-----+
```

После создания SSH-ключа мы теперь можем указать тип хранилища, удаленный IP-адрес и порт, путь на сервере, имя пользователя, и в `Расширенных опциях` мы можем добавить метод аутентификации `ssh-key`.

![Настройка места назначения резервного копирования Duplicati с SFTP, IP-адресом сервера 10.129.12.122, порт 50022, путь '/home/duplicati', имя пользователя 'duplicati', и кнопкой 'Проверить соединение'](https://academy.hackthebox.com/storage/modules/87/bak11.png)

После этого мы можем выбрать исходные данные, которые необходимо скопировать. Огромным преимуществом, которое предоставляет Duplicati, является функциональность фильтрации с использованием регулярных выражений.

![Экран выбора исходных данных Duplicati с деревом папок для 'Пользовательских данных' и 'Компьютера', опцией показа скрытых папок и настройками фильтра](https://academy.hackthebox.com/storage/modules/87/bak12.png)

В качестве последнего шага мы можем настроить расписание для резервных копий.

![Экран расписания Duplicati с отмеченным 'Автоматически запускать резервные копии', следующий запуск в 13:00 27.04.2025, повторяющийся каждый день, со всеми выбранными днями](https://academy.hackthebox.com/storage/modules/87/bak13.png)

Настоятельно рекомендуется, чтобы ваши резервные копии (особенно когда они хранятся на удаленном сервере) были зашифрованы как в состоянии покоя, так и во время передачи. Это означает, что ваши данные должны быть зашифрованы в репозиториях и во время передачи. И Pika Backup, и Duplicati поддерживают эту функциональность и, следовательно, помогают организациям выполнять нормативные требования, такие как GDPR и HIPAA.

Мы также рекомендуем смоделировать ситуацию `Аварийного восстановления`, когда ваш сервер внезапно перестает работать должным образом или данные были потеряны, и вам нужно восстановить его последнее состояние с нуля. В процессе этого вы узнаете, какие вещи могут произойти во время восстановления и работает ли ваш процесс должным образом. Имейте в виду, что вы должны вести заметки и документировать процесс шаг за шагом, чтобы у вас был план обеспечения непрерывности, который вы можете использовать для восстановления своих данных. Мы также рекомендуем моделировать эту ситуацию дважды в год или раз в квартал, чтобы гарантировать, что настроенный вами процесс работает должным образом. Потому что когда что-то ломается, ваш план обеспечения непрерывности — это последнее средство для восстановления всего, что вы создали.


# Провайдеры VPS

---

`Виртуальный частный сервер` (`VPS`) — это изолированная среда, созданная на физическом сервере с использованием технологии виртуализации. VPS по сути является частью решений `Инфраструктура как услуга` (`IaaS`). Это решение предлагает все преимущества обычного сервера со специально выделенными ресурсами и полной свободой управления. Мы можем свободно выбирать операционную систему и приложения, которые мы хотим использовать, без каких-либо ограничений конфигурации. Эта ВМ использует ресурсы физического сервера и предоставляет пользователям различные серверные функции, сопоставимые с функциями выделенного сервера. Поэтому его также называют `Виртуальным выделенным сервером` (`VDS`).

VPS позиционируется как компромисс между недорогим общим хостингом и обычно дорогой арендой технологии выделенных серверов. Идея этой модели хостинга заключается в том, чтобы предложить пользователям максимально полный спектр функций по доступным ценам. Виртуальное воспроизведение отдельных компьютерных систем на стандартной хост-системе требует значительно меньших усилий для веб-хостера, чем предоставление отдельных аппаратных компонентов для каждого клиента. Обширная независимость отдельных гостевых систем достигается за счет инкапсуляции. Каждый VPS на общей аппаратной базе действует изолированно от других параллельных операционных систем. В большинстве случаев VPS используется для следующих целей, но не ограничивается ими:

| | | | |
|---|---|---|---|
| Веб-сервер | LAMP/XAMPP стек | Почтовый сервер | DNS-сервер |
| Сервер разработки | Прокси-сервер | Тестовый сервер | Репозиторий кода |
| Пентестинг | VPN | Игровой сервер | C2 сервер |

Мы можем выбрать из ряда операционных систем Windows и Linux, чтобы обеспечить необходимую операционную среду для нашего желаемого приложения или программного обеспечения во время установки. Серверы Windows могут стоить вдвое дороже, чем серверы Linux у некоторых провайдеров. Вы должны учитывать это при выборе провайдера.

| **Провайдер** | **Цена** | **ОЗУ** | **CPU ядра** | **Хранилище** | **Трафик/Пропускная способность** |
|---|---|---|---|---|---|
| [Linode](https://www.linode.com/pricing/) | $12/мес | 2GB | 1 CPU | 50 GB | 2 TB |
| [DigitalOcean](https://www.digitalocean.com/pricing) | $10/мес | 2GB | 1 CPU | 50 GB | 2 TB |
| [OneHostCloud](https://onehostcloud.hosting/) | $14.99/мес | 2GB | 1 CPU | 50 GB | 2 TB |


# Настройка VPS

---

Независимо от того, находимся ли мы на внутреннем или внешнем тесте на проникновение, VPS, который мы можем использовать, имеет для нас большое значение во многих различных случаях. Мы можем хранить на нем все наши ресурсы и получать к ним доступ практически из любой точки с доступом в интернет. Помимо того, что мы должны сначала настроить VPS, мы также должны подготовить соответствующую структуру папок и его сервисы. В этом примере мы рассмотрим провайдера под названием [Linode](https://www.linode.com/) и настроим там наш VPS. Для других провайдеров параметры конфигурации выглядят почти идентично.

В первую очередь нам нужно выбрать ближайшее к нам местоположение. Это обеспечит отличное соединение с нашим сервером. Если нам нужно выполнить тест на проникновение на другом континенте, мы также можем настроить там VPS, используя наши сценарии автоматизации, и выполнить тест на проникновение оттуда. Тем не менее, мы всё равно должны внимательно читать индивидуальную информацию об их компонентах и понимать, с каким типом VPS мы будем работать в будущем. В Linode мы можем выбрать один из четырех разных серверов. Для наших целей на данный момент достаточно сервера с `Shared CPU`. Для Linux-дистрибутива мы выбираем, какая операционная система должна быть установлена на VPS. ParrotOS основана на `Debian`, как и Ubuntu. Здесь мы можем выбрать один из этих двух или перейти к расширенным опциям и загрузить наш ISO.

![Экран создания Linode, показывающий регион установленный на Франкфурт, ОС как Ubuntu 24.04 LTS, и планы с общим CPU с ценами для Nanode 1 GB и Linode 2 GB.](https://academy.hackthebox.com/storage/modules/87/vpss1.png)

Marketplace от Linode предлагает множество различных приложений, которые были предварительно настроены и могут быть установлены сразу.

![Экран Marketplace от Linode, показывающий варианты выбора новых приложений, таких как Apache Spark, Backstage, и популярные приложения, такие как WordPress и cPanel.](https://academy.hackthebox.com/storage/modules/87/vpss2.png)

Далее нам нужно выбрать уровень производительности для нашего VPS. Это один из пунктов, где стоимость может сильно измениться. Для наших целей, однако, мы можем выбрать один из первых двух вариантов сверху. Тем не менее, здесь нам нужно выбрать производительность, для которой мы хотим использовать VPS. Если VPS будет использоваться для продвинутых целей и обеспечивает множество запросов и сервисов, 1024MB памяти будет недостаточно. Поэтому всегда рекомендуется сначала настроить установку нашей ОС локально в VM, а затем проверить нагрузку сервисов.

![Экран планов Linode, показывающий опции с общим CPU с ценами и спецификациями для Nanode 1 GB и Linode 2 GB, включая RAM, хранилище и детали трафика.](https://academy.hackthebox.com/storage/modules/87/vpss3.png)

После этого в разделе `Security` нам нужно указать пароль для `root` и мы также можем добавить SSH-ключи, которые мы можем использовать для входа на VPS через SSH позже. Мы также можем сгенерировать эти ключи позже на нашем VPS, нашей VM или собственной хост-операционной системе. Давайте используем нашу VM для генерации пары ключей. Давайте сгенерируем новый SSH-ключ и добавим его на наш VPS.

#### Генерация SSH-ключей

```shell
┌─[cry0l1t3@parrot]─[~]
└──╼ $ ssh-keygen -t ed25519 -f vps-ssh

Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase): ******************
Enter same passphrase again: ******************
Your identification has been saved in vps-ssh
Your public key has been saved in vps-ssh.pub
The key fingerprint is:
SHA256:zXyVAWK00000000000000000000VS4a/f0000+ag cry0l1t3@parrot
The key's randomart image is:
<SNIP>
```

С помощью команды, показанной выше, мы генерируем два разных ключа. `vps-ssh` - это `приватный ключ`, и он не должен быть передан куда-либо или кому-либо. Второй `vps-ssh.pub` - это `публичный ключ`, который мы теперь можем вставить в панель управления Linode.

#### SSH-ключи

```shell
┌─[cry0l1t3@parrot]─[~]
└──╼ $ ls -l vps*-rw------- 1 cry0l1t3 cry0l1t3 3434 Mar 30 12:23 vps-ssh
-rw-r--r-- 1 cry0l1t3 cry0l1t3  741 Mar 30 12:23 vps-ssh.pub

┌─[cry0l1t3@parrot]─[~]
└──╼ $ cat vps-ssh.py
```

![Экран настройки SSH-ключа Linode с полями для 'Метка' и 'Публичный SSH-ключ', и опциями для добавления или отмены.](https://academy.hackthebox.com/storage/modules/87/vpss4.png)

После того как всё настроено, мы можем нажать на `Create Linode` и подождать, пока завершится установка. После того как VPS будет готов, мы можем получить к нему доступ через SSH.

#### SSH с использованием пароля

```shell
cry0l1t3@htb[/htb]$ ssh root@<vps-ip-address>

root@VPS's password:

[root@VPS ~]#
```

После этого мы должны добавить нового пользователя для VPS, чтобы не запускать наши сервисы с привилегиями root или администратора. Для этого мы можем затем сгенерировать еще один SSH-ключ и добавить его для этого пользователя.

#### Добавление нового пользователя с правами sudo

```shell
[root@VPS ~]# adduser cry0l1t3
[root@VPS ~]# usermod -aG sudo cry0l1t3
[root@VPS ~]# su - cry0l1t3
Password: ********

[cry0l1t3@VPS ~]$
```

#### Добавление публичного SSH-ключа на VPS

```shell
[cry0l1t3@VPS ~]$ mkdir ~/.ssh
[cry0l1t3@VPS ~]$ echo '<vps-ssh.pub>' > ~/.ssh/authorized_keys
[cry0l1t3@VPS ~]$ chmod 600 ~/.ssh/authorized_keys
```

После того как мы добавили это в файл `authorized_keys`, мы можем использовать `приватный ключ` для входа в систему через SSH.

#### Использование SSH-ключей

```shell
Cry0l1t3@htb[/htb]$ ssh cry0l1t3@<vps-ip-address> -i vps-ssh

[cry0l1t3@VPS ~]$
```


# Управление сервером

---

Когда речь идет об управлении сервером, одним из наиболее важных аспектов (помимо безопасности) является поддержание сервера быстрым, надежным и готовым к выполнению задач, для которых он был создан. Поэтому настоятельно рекомендуется поддерживать сервер в актуальном состоянии и настраивать его таким образом, чтобы у него было достаточно ресурсов для обработки всего необходимого. Еще одним важным аспектом является доступ к серверу. Вместо того, чтобы настраивать все службы, которые мы хотим использовать, а затем сосредотачиваться на ограничении способов доступа к серверу, мы сделаем это наоборот. В противном случае, определенные точки доступа к нашему собственному серверу могут быть упущены из виду, что сделает нас уязвимыми. Поэтому, когда мы начинаем создавать удаленный сервер, сначала необходимо убедиться, что сервер имеет только один способ доступа с использованием защищенного протокола для связи. Лучший подход — убедиться, что в начале доступ к серверу возможен только через SSH с использованием ключа аутентификации, а не пароля.

Усиление доступа через SSH — один важный аспект. Другой аспект, на котором мы также должны сосредоточиться, — это управление ключами. Когда нам нужно управлять всего несколькими серверами, это может быть довольно легко и понятно. Однако, когда ваша ответственность возрастает до управления несколькими сотнями серверов, возникает высокая потребность в их эффективном управлении. В таком случае организации и предприятия используют комбинацию [Teleport](https://goteleport.com/) и [Ansible](https://docs.ansible.com/ansible/latest/index.html#).

При настройке сервера рекомендуется придерживаться принципа `Zero Trust` — `Никто и ничто - как внутри, так и вне сети - не может быть автоматически доверенным`. Представьте это как здание с высоким уровнем безопасности. Даже если вы сотрудник, вам нужно показывать свое удостоверение личности и проходить контрольно-пропускной пункт каждый раз, когда вы входите, и у вас есть доступ только к тем комнатам, которые вам нужны.

---

## SSH Agent

SSH Agent — это программа, которая работает в фоновом режиме и обычно устанавливается по умолчанию в большинстве систем Linux. Мы используем инструмент `ssh` для безопасного подключения к нашим удаленным серверам, и SSH agent помогает, храня и управляя вашими ключами SSH, которые похожи на ваше удостоверение личности, используемое для подтверждения вашей личности на сервере. Давайте сначала убедимся, что мы усилим наш SSH-сервер и сделаем его немного более безопасным. В дистрибутивах Ubuntu и Debian конфигурационный файл SSH-сервера находится в `/etc/ssh/sshd_config`.

#### Сторона сервера

```bash
cry0l1t3@MyVPS:~$ vim /etc/ssh/sshd_config
```

Вы увидите множество различных настроек, которые можно включить, но первые, которые мы настоятельно рекомендуем изменить, следующие:

```bash
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication no
X11Forwarding no
Port 4444
AllowUsers cry0l1t3
```

В этом примере мы отключили доступ для пользователя `root` через SSH и разрешили соединения на TCP-порту 4444 для пользователя `cry0l1t3` только через метод аутентификации по ключу ssh. После внесения этих изменений нам нужно перезапустить SSH-сервер.

```bash
cry0l1t3@MyVPS:~$ sudo service ssh restart
```

Для использования SSH agent есть несколько вещей, которые нам нужно сделать. Во-первых, нам нужен высокозащищенный ключ SSH. Один из наиболее эффективных методов следующий:

#### Сторона клиента

```bash
cry0l1t3@htb:~$ ssh-keygen -t ed25519 -f ~/.ssh/cry0l1t3

Generating public/private ed25519 key pair.
Enter passphrase (empty for no passphrase): ****************************
Enter same passphrase again: ****************************

Your identification has been saved in /home/cry0l1t3/.ssh/cry0l1t3
Your public key has been saved in /home/cry0l1t3/.ssh/cry0l1t3.pub
The key fingerprint is:
SHA256:5TNgGHaqFsIhfqbsFPxa2PllgV2NZdHacaxNddlA0WI cry0l1t3@MyVPS
The key's randomart image is:
+--[ED25519 256]--+
|. .   o ..++o.=+*|
|oo . .o=.... oE=+|
| +oo..ooo . o.*. |
|. O..o ..+ . o . |
| = =o  oS +      |
|o o.. o    o     |
| o   .           |
|                 |
|                 |
+----[SHA256]-----+
```

Убедитесь, что на этом этапе вы добавили свой открытый ключ SSH (`<your_key>.pub`) на удаленный сервер в файл `~/.ssh/authorized_keys` и установили соответствующие разрешения для этого файла.

```bash
# Удаленный сервер
cry0l1t3@MyVPS:~$ sudo chmod 600 ~/.ssh/authorized_keys
```

Затем нам нужно добавить приватный ключ в SSH agent и создать конфигурационный файл для SSH agent в директории `.ssh`.

```bash
cry0l1t3@MyVPS:~$ ssh-add ~/.ssh/cry0l1t3
Enter passphrase for /home/cry0l1t3/.ssh/cry0l1t3:
Identity added: /home/cry0l1t3/.ssh/cry0l1t3 (cry0l1t3@MyVPS)

cry0l1t3@MyVPS:~$ vim ~/.ssh/config
```

В этом конфигурационном файле мы настроим имя, которое хотим использовать для сервера, его IP-адрес или доменное имя, идентификационный файл, порт, пользователя и укажем SSH использовать только указанный ключ, а не пробовать другие ключи. Это делает соединения немного быстрее и существенно более безопасными.

```bash
Host MyVPS
    HostName <IP Address/domain name>
    IdentityFile ~/.ssh/cry0l1t3
    Port 4444
    User cry0l1t3
    IdentitiesOnly yes
```

С помощью следующей команды мы запускаем SSH agent в нашей терминальной сессии. Если вы хотите запускать SSH agent автоматически, вы можете добавить эту команду в ваш файл `~/.bashrc` или `~/.zshrc`.

```bash
cry0l1t3@htb:~$ eval $(ssh-agent)
```

Теперь мы можем использовать SSH-клиент, просто набрав имя (`MyVPS`), которое мы установили для этого сервера, и подключиться к нему.

```bash
cry0l1t3@htb:~$ ssh MyVPS
```

---

## Управление паролями и секретами

Управление паролями — это практика создания, хранения и организации паролей и секретов для обеспечения безопасного доступа к учетным записям и системам, требуя при этом меньше усилий для использования. Поскольку большинство людей используют один пароль (который часто даже не является безопасным), настоятельно рекомендуется иметь менеджер паролей, который может генерировать и хранить сложные пароли. Есть много различных вариантов, из которых вы можете выбрать:

| [Proton](https://proton.me/pass) | [Bitwarden](https://bitwarden.com/) | [1Password](https://1password.com/) | [Passbolt](https://www.passbolt.com/) | [Psono](https://psono.com/) | [Passky](https://passky.org/) | [OpenBao](https://openbao.org/) |
|---------|-----------|-----------|----------|-------|--------|---------|

Вы можете использовать любой из этих менеджеров, так как все они предоставляют подходящие решения для безопасного хранения данных. За исключением Psono и Passbolt, все упомянутые менеджеры используют сквозное шифрование (E2EE), которое позволяет только пользователю расшифровывать его. E2EE — это модель безопасности, где данные шифруются на устройстве отправителя и могут быть расшифрованы только на устройстве получателя. Никто между ними (включая поставщиков услуг) не может получить доступ к нешифрованным (открытым) данным.

Psono использует шифрование на стороне клиента, а Passbolt использует GPG-шифрование. GPG-шифрование использует приватные и публичные ключи, подобно SSH. Публичный ключ (которым можно поделиться с другими) используется для шифрования, и только тот, кто владеет приватным ключом (который никогда не следует передавать другим), может расшифровать данные. Шифрование на стороне клиента означает, что данные шифруются на устройстве перед отправкой.

Кроме того, Linode имеет предварительно настроенные образы на своем маркетплейсе, которые можно использовать для быстрого развертывания таких менеджеров.

![Экран выбора приложений Linode Marketplace, показывающий варианты OpenBao, HashiCorp Vault, Passbolt Community Edition и Passky.](https://academy.hackthebox.com/storage/modules/87/servm1.png)

---

## Git Hosting

Git — это распределенная система контроля версий (DVCS), разработанная для помощи разработчикам в управлении изменениями файлов, особенно кода, с течением времени. Она позволяет сотрудничать над проектом с несколькими людьми, отслеживать историю изменений и эффективно поддерживать различные версии своей работы.

Например, если вы выпускаете новую версию вашего программного обеспечения или инструмента, и что-то ломается, вы всегда можете вернуться к предыдущей версии. Кроме того, вы можете работать над множеством функций одновременно, не нарушая оригинальную версию вашего программного обеспечения, а затем объединять их в исходную ветку, как только они будут протестированы. Этот процесс также известен как Непрерывная Интеграция и Непрерывная Поставка или Развертывание (CI/CD).

Помимо разработки инструментов и программного обеспечения, мы можем использовать частные репозитории для наших собственных предпочтений и нужд. Например, мы можем хранить наши dotfiles (конфигурационные файлы) для нашей среды или служб. Это делает настройку новых виртуальных машин более оптимизированной, поскольку мы можем легко клонировать репозиторий и заменить необходимые конфигурационные файлы.

Существует множество провайдеров, использующих эту технологию, и многие из них могут быть размещены самостоятельно, если это необходимо.

| [Github](https://github.com/) | [Gitlab](https://about.gitlab.com/) | [BitBucket](https://bitbucket.org/) | [Gitea](https://about.gitea.com/) | [OneDev](https://onedev.io/) |
|--------|---------|----------|-------|--------|

Linode также предоставляет предварительно настроенные образы, которые можно использовать сразу.

![Экран выбора приложений Linode Marketplace, показывающий варианты Gitea и GitLab в категории Разработка.](https://academy.hackthebox.com/storage/modules/87/servm2.png)


# Сетевая безопасность

---

Сетевая безопасность является одним из наиболее критических аспектов кибербезопасности и требует максимального внимания. Поскольку в этой части мы устанавливаем правила доступа, крайне важно сделать это правильно. После настройки нам остаётся в основном мониторить и обеспечивать сохранение защищённости. Однако даже это представляет собой огромный объём работы.

Поскольку мы фокусируемся на безопасности (и одновременно на эффективности), нам нужно решение, позволяющее быстро и легко настроить доступ к удалённым серверам. Некоторые из таких решений предлагаются:

| [Netbird](https://netbird.io/) | [Tailscale](https://tailscale.com/) | [Twingate](https://www.twingate.com/) |
|-------------------------------|-----------------------------------|----------------------------------|

Zero Trust Network Access (`ZTNA`) — это то, на чём фокусируются эти провайдеры, и это относительно новая концепция. Переосмысливая безопасный доступ, ZTNA представляет собой значительный отход от традиционных периметрических моделей, таких как VPN. Основываясь на принципе `никогда не доверяй, всегда проверяй`, ZTNA аутентифицирует и авторизует каждого пользователя, каждое устройство и каждую попытку подключения на основе идентификации, контекста, устройства и статуса безопасности, обеспечивая детализированный доступ к ресурсам, настроенным администраторами, вместо широкого сетевого или группового доступа.

С одной стороны, это делает наши сетевые ресурсы гораздо более безопасными. С другой стороны, управление каждым отдельным устройством и ресурсом может стать очень сложным. Выбор решения зависит от конкретного случая.

[Netbird](https://netbird.io/) отлично подходит для случаев, требующих простой, автоматизированной настройки для безопасного доступа к облачным и локальным ресурсам, например, для подключения рабочих станций разработчиков к частным репозиториям.

[Tailscale](https://tailscale.com/) — это виртуальное приватное облако на базе WireGuard, требующее минимальной настройки, что делает его идеальным для обеспечения безопасных подключений удалённых сотрудников к внутренним сервисам (например, CI/CD-конвейерам, внутренним панелям мониторинга) или для организации сетевого взаимодействия между сайтами без сложных правил брандмауэра.

Архитектура Relay и Connector от [Twingate](https://www.twingate.com/) и API-ориентированный дизайн делают его идеальным для обеспечения безопасного доступа к базам данных, кластерам Kubernetes или устаревшим приложениям в мультиоблачных или локальных средах.

Настоятельно рекомендуется бесплатно попробовать каждое из них и выяснить, какое лучше всего соответствует вашим потребностям. Поскольку эти провайдеры предлагают схожие услуги, каждый из них имеет свою философию и фокус. Какое решение подходит именно вам — вопрос, на который можно ответить только после понимания, как будет выглядеть ваша сеть. В нашем случае мы будем использовать Netbird.

---

## Netbird

Открытый исходный код Netbird и одноранговая (P2P) сетевая структура на базе WireGuard делают его идеальным для команд с техническими навыками управления инфраструктурой, особенно для защиты гибридных сред с распределёнными устройствами, таких как удалённые рабочие места, серверы, внутренние ресурсы или даже небольшие филиалы. Огромным преимуществом Netbird является возможность самостоятельного хостинга.

Посетив страницу Netbird, вы можете зарегистрироваться бесплатно. Процесс регистрации довольно прост и не требует подробных объяснений. После подтверждения адреса электронной почты вы получите доступ к панели управления, которая будет выглядеть примерно так:

#### Панель управления

![Интерфейс Netbird, показывающий список из 5 узлов с такими деталями, как имя, адрес, группы, последнее соединение, ОС и версия. Доступны опции фильтрации и добавления узлов.](https://academy.hackthebox.com/storage/modules/87/net1.png)

Как видно на панели управления выше, в сети есть 5 узлов (peers). Вы увидите имя каждого узла, его внутренний IP-адрес, доменное имя, время последнего соединения, ОС и версию клиента Netbird, используемую системой.

Теперь, когда мы настроили VPS, мы можем добавить его в нашу внутреннюю сеть в Netbird. Для этого нам нужно настроить так называемые "Ключи настройки" (Setup Keys), которые сообщают Netbird, к какой сети принадлежит клиент.

Для этого можно нажать на `Create Setup Key` и указать имя для этого ключа настройки.

#### Ключи настройки

![Экран создания ключа настройки Netbird с полями для 'Имени', 'Сделать этот ключ многоразовым', 'Ограничение использования', 'Срок действия', и переключателями для 'Временных узлов' и 'Разрешить дополнительные DNS-метки'.](https://academy.hackthebox.com/storage/modules/87/net2.png)

Появится всплывающее окно, показывающее ключ настройки, который нужно скопировать. Этот ключ будет использоваться на VPS для подключения к сети.

![Подтверждение создания ключа настройки с отображением ключа и опциями 'Закрыть' или 'Установить NetBird'.](https://academy.hackthebox.com/storage/modules/87/net3.png)

После того, как вы скопировали ключ, вы увидите ещё одно всплывающее окно с инструкциями для каждой операционной системы, которые можно использовать для подключения узла с помощью ключа настройки.

![Экран установки NetBird для Linux с инструкциями командной строки для установки и запуска с использованием ключа настройки.](https://academy.hackthebox.com/storage/modules/87/net4.png)

В нашем примере для Ubuntu мы будем использовать команду `curl` с предоставленным URL, которая загружает и выполняет скрипт оболочки для автоматической установки. Вас попросят ввести пароль, и после установки вы увидите сообщение о том, что клиент netbird запущен и работает.

```shell-session
cry0l1t3@MyVPS:~$ curl -fsSL https://pkgs.netbird.io/install.sh | sh

The installation will be performed using apt package manager
[sudo] password for cry0l1t3: *****************

<SNIP>

NetBird service has already been loaded
Netbird service has been started
Installation has been finished. To connect, you need to run NetBird by executing the following command:

netbird up
```

Далее мы будем использовать сгенерированный ключ настройки и укажем его в клиенте Netbird с помощью следующей команды:

```shell-session
cry0l1t3@MyVPS:~$ netbird up --setup-key 826BC181-63D4-4875-84C3-9949FDEA48EE

Connected
```

Мы должны увидеть сообщение о том, что наш узел теперь подключен к сети. Когда Netbird запускается, он создаёт новый сетевой интерфейс, который обычно называется `wt0`. Мы можем использовать `ifconfig` или `ip addr` для проверки наличия нового сетевого интерфейса.

```shell-session
cry0l1t3@MyVPS:~$ ifconfig wt0

wt0: flags=209<UP,POINTOPOINT,RUNNING,NOARP>  mtu 1280
        inet 100.108.232.34  netmask 255.255.0.0  destination 100.108.232.34
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 1000  (UNSPEC)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

После подтверждения нам нужно перейти в панель управления Netbird. Здесь вы увидите появившийся узел, запрашивающий одобрение. Имейте в виду, что даже если кто-то похитил ваш ключ настройки и попытался подключиться к вашей сети, этот узел всё равно потребует одобрения администратора.

![Запись MyVPS, показывающая статус "онлайн", адрес 'myvps.netbird.cloud', последнее соединение 'только что', версия 0.41.3, с кнопками 'Требуется одобрение' и 'Одобрить'.](https://academy.hackthebox.com/storage/modules/87/net5.png)

После одобрения мы можем проверить соединение, попытавшись подключиться к нему через SSH.

```shell-session
cry0l1t3@htb:~$ ssh cry0l1t3@myvps.netbird.cloud

The authenticity of host 'myvps.netbird.cloud (100.108.232.34)' can't be established.
ED25519 key fingerprint is SHA256:NuxuseOH6mjejxr7dGWmBEYb4dHCi24eSFm+9qnn4lI.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes

Warning: Permanently added 'myvps.netbird.cloud' (ED25519) to the list of known hosts.

cry0l1t3@myvps.netbird.cloud's password: *******************

Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.11.0-21-generic x86_64)

<SNIP>

cry0l1t3@MyVPS:~$
```

Далее, поскольку соединение работает, мы можем настроить брандмауэр, чтобы разрешить входящие соединения только на интерфейсе `wt0` и отклонять всё остальное, кроме исходящих соединений. Мы можем использовать инструмент `ufw` или `iptables`. Для простоты будем использовать `ufw`.

#### Настройка брандмауэра

```shell-session
# Разрешаем входящие соединения только с интерфейса netbird wt0
# Сбрасываем ufw до состояния по умолчанию
ufw --force reset

# Разрешаем весь входящий трафик на интерфейсе wt0
ufw allow in on wt0

# Устанавливаем политики по умолчанию
ufw default deny incoming
ufw default allow outgoing

# Включаем ufw
ufw --force enable

# Отображаем статус ufw
ufw status
```

Дополнительно мы можем ещё больше усилить безопасность нашего SSH-сервера, указав ему прослушивать только интерфейс `wt0` с помощью следующего скрипта.

#### Альтернативная конфигурация SSH

```bash
#!/bin/bash

# Получаем IP-адрес интерфейса wt0
WT0_IP=$(ip addr show wt0 | grep -oP 'inet \K[\d.]+')

# Создаём резервную копию текущей конфигурации SSH
SSHD_CONF="/etc/ssh/sshd_config"
BACKUP_CONF="/etc/ssh/sshd_config.bak_$(date +%F_%H-%M-%S)"
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

# Проверяем, настроен ли уже ListenAddress
if grep -q "^ListenAddress" "$SSHD_CONF"; then
    # Заменяем существующий ListenAddress
    sed -i "s/^ListenAddress.*/ListenAddress $WT0_IP/" "$SSHD_CONF"
else
    # Добавляем ListenAddress
    echo "ListenAddress $WT0_IP" >> "$SSHD_CONFIG"
fi

# Убеждаемся, что SSH не прослушивает 0.0.0.0 или ::
sed -i '/^ListenAddress 0.0.0.0/d' "$SSHD_CONFIG"
sed -i '/^ListenAddress ::/d' "$SSHD_CONFIG"

# Проверяем конфигурацию SSH
if sshd -t; then
    echo "SSH конфигурация действительна."
else
    echo "Ошибка: Недействительная конфигурация SSH. Восстанавливаем из резервной копии."
    cp "$BACKUP_CONFIG" "$SSHD_CONFIG"
    exit 1
fi

# Перезапускаем SSH сервис
systemctl restart sshd
if [ $? -eq 0 ]; then
    echo "SSH сервис успешно перезапущен."
else
    echo "Ошибка: Не удалось перезапустить SSH сервис."
    exit 1
fi
```

